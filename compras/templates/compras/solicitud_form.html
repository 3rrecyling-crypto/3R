{% extends 'compras/compras_base.html' %}

{% load static %}
{% load widget_tweaks %}
{% load humanize %}

{% block compras_content %}
<div class="container-fluid" style="padding-bottom: 120px;">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-3 bg-primary rounded px-3 py-3">
                <div class="mb-3 mb-md-0">
                    <h3 class="fw-bold text-white mb-0">{{ titulo }}</h3>
                    <p class="text-white-50 mb-0">Complete los detalles de la solicitud de compra</p>
                </div>
                <a href="{% url 'lista_solicitudes' %}" class="btn btn-outline-light d-flex align-items-center">
                    <i class="fas fa-arrow-left me-2"></i> Volver al listado
                </a>
            </div>
            <div class="alert alert-info bg-opacity-10 p-3 rounded d-flex align-items-center">
                <i class="fas fa-info-circle text-info me-2 fs-5"></i>
                <small class="text-info">Los campos marcados con <span class="text-danger">*</span> son obligatorios</small>
            </div>
        </div>
    </div>

    <form method="post" id="solicitudForm" class="needs-validation" novalidate enctype="multipart/form-data">
        {% csrf_token %}
        
        <div class="card shadow-sm border-0 mb-4">
            <div class="card-header bg-primary text-white py-3 d-flex align-items-center">
                <div class="bg-blue bg-opacity-35 p-2 rounded-circle me-3 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                    <i class="fas fa-file-alt"></i>
                </div>
                <div>
                    <h5 class="card-title mb-0 text-white">Datos Generales</h5>
                    <small class="opacity-85 text-white-50">Información básica de la solicitud</small>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for field in form %}
                    <div class="col-12 col-md-6 mb-3">
                        <label for="{{ field.id_for_label }}" class="form-label fw-semibold">
                            {{ field.label }}
                            {% if field.field.required %} <span class="text-danger">*</span>{% endif %}
                        </label>
                        <div class="input-group">
                            <span class="input-group-text bg-light">
                                <i class="fas fa-{% if field.name == 'empresa' %}sitemap{% elif field.name == 'lugar' %}building{% elif 'proveedor' in field.name %}truck-loading{% elif 'fecha' in field.name %}calendar{% else %}pen{% endif %} text-muted"></i>
                            </span>
                            {% render_field field class="form-control" %}
                        </div>
                        
                        {% if 'proveedor' in field.name %}
                        <div id="no-proveedor-mensaje" class="alert alert-warning p-2 mt-2 d-none">
                            <small>
                                No hay proveedores disponibles. 
                                <a href="{% url 'crear_proveedor' %}" target="_blank" class="alert-link">¿Quieres dar de alta uno?</a>
                            </small>
                        </div>
                        {% endif %}

                        {% if field.name == 'lugar' %}
                        <div id="no-lugar-mensaje" class="alert alert-warning p-2 mt-2 d-none">
                            <small>
                                No hay Empresas (Lugares) disponibles para esta Operación.
                            </small>
                        </div>
                        {% endif %}
                        
                        {% if field.errors %}
                        <div class="text-danger small mt-1 d-flex align-items-center">
                            <i class="fas fa-exclamation-circle me-1"></i> {{ field.errors|first }}
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="card shadow-sm border-0">
            <div class="card-header bg-primary text-white py-3 d-flex align-items-center">
                <div class="bg-blue bg-opacity-20 p-2 rounded-circle me-3 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                    <i class="fas fa-boxes"></i>
                </div>
                <div>
                    <h5 class="card-title mb-0 text-white">Artículos Solicitados</h5>
                    <small class="opacity-85 text-white-50">Detalle de productos y cantidades</small>
                </div>
            </div>
            <div class="card-body">
                {{ formset.management_form }}
                
                {% if formset.non_form_errors %}
                    <div class="alert alert-danger mb-3">{{ formset.non_form_errors }}</div>
                {% endif %}

                <div id="detalle-forms-container">
                    {% for form in formset.forms %}
                    <div class="detalle-form card mb-3 border-light shadow-sm position-relative">
                        <div class="position-absolute top-0 start-0 h-100 bg-primary rounded-start" style="width: 4px;"></div>
                        {{ form.id }}
                        <div class="card-body">
                            <div class="row g-3 align-items-end">
                                <div class="col-12 col-lg-4 mb-0">
                                    <label class="form-label fw-semibold">Artículo <span class="text-danger">*</span></label>
                                    <div class="input-group">
                                        {{ form.articulo|add_class:"form-control select2-articulo" }}
                                    </div>
                                    {% if form.articulo.errors %}
                                        <div class="text-danger small">{{ form.articulo.errors|first }}</div>
                                    {% endif %}
                                </div>
                                
                                <div class="col-12 col-sm-6 col-lg-3 mb-0">
                                    <div class="row g-2 align-items-end">
                                        <div class="col-8 mb-0">
                                            <label class="form-label fw-semibold">Cantidad <span class="text-danger">*</span></label>
                                            {{ form.cantidad|add_class:"form-control cantidad-input" }}
                                        </div>
                                        <div class="col-4 mb-0">
                                            <label class="form-label fw-semibold">U.M.</label>
                                            <div class="input-group">
                                                <span class="input-group-text bg-light">
                                                    <i class="fas fa-ruler text-muted"></i>
                                                </span>
                                                <input type="text" class="form-control unidad-medida-display" readonly placeholder="U.M.">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-12 col-sm-6 col-lg-3 mb-0">
                                    <label class="form-label fw-semibold">Precio Unitario <span class="text-danger">*</span></label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-light">$</span>
                                        {{ form.precio_unitario|add_class:"form-control precio-input text-end" }}
                                        <button class="btn btn-outline-success update-catalog-price-btn" type="button" title="Guardar este precio en el Catálogo Maestro">
                                            <i class="fas fa-save"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="col-12 col-lg-2 d-flex align-items-end justify-content-start justify-content-lg-end mb-0">
                                    {% if formset.can_delete %}
                                        <div class="d-none">{{ form.DELETE }}</div>
                                    {% endif %}
                                    <button type="button" class="btn btn-sm btn-outline-danger remove-form d-flex align-items-center w-100 w-lg-auto justify-content-center">
                                        <i class="fas fa-trash me-1 d-none d-sm-inline"></i> Eliminar
                                    </button>
                                </div>
                            </div>
                            
                            <div class="row mt-3">
                                <div class="col-12">
                                    <div class="d-flex flex-column flex-sm-row flex-wrap gap-3 text-sm">
                                        <div class="articulo-info d-flex align-items-center">
                                            <small class="text-muted">SKU:</small>
                                            <span class="badge bg-light text-dark ms-1 sku-display">--</span>
                                        </div>
                                        <div class="articulo-info d-flex align-items-center">
                                            <small class="text-muted">Categoría:</small>
                                            <span class="badge bg-light text-dark ms-1 categoria-display">--</span>
                                        </div>
                                        <div class="articulo-info d-flex align-items-center">
                                            <small class="text-muted">Tipo:</small>
                                            <span class="badge bg-light text-dark ms-1 tipo-display">--</span>
                                        </div>
                                        <div class="articulo-info d-flex align-items-center">
                                            <small class="text-muted">Impuestos:</small>
                                            <span class="badge bg-info text-white ms-1 iva-badge d-none">IVA</span>
                                            <span class="badge bg-warning text-dark ms-1 ret-iva-badge d-none">RET IVA</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mt-3 pt-3 border-top">
                                <div class="col-12">
                                    <div class="d-flex flex-column flex-md-row flex-wrap justify-content-md-end gap-3 text-end">
                                        <div class="mb-2">
                                            <small class="text-muted d-block">Subtotal</small>
                                            <p class="fw-semibold mb-0 subtotal text-primary">--</p>
                                        </div>
                                        <div class="mb-2">
                                            <small class="text-muted d-block">IVA</small>
                                            <p class="fw-semibold mb-0 iva text-info">--</p>
                                        </div>
                                        <div class="mb-2">
                                            <small class="text-muted d-block">Ret. IVA</small>
                                            <p class="fw-semibold mb-0 ret-iva text-warning">--</p>
                                        </div>
                                        <div class="mb-2 ps-md-3 border-start-md">
                                            <small class="text-muted d-block">Total Línea</small>
                                            <p class="fw-bold fs-5 mb-0 total-linea text-success">--</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <button type="button" id="add-form" class="btn btn-primary mt-3 d-flex align-items-center">
                    <i class="fas fa-plus-circle me-2"></i> Añadir Artículo
                </button>
                <div id="no-articulos-mensaje" class="alert alert-warning p-2 mt-2 d-none">
                    <small>
                        Este proveedor no tiene artículos asociados o activos. 
                        <a href="{% url 'lista_articulos' %}" target="_blank" class="alert-link">Ir al catálogo de artículos</a>.
                    </small>
                </div>
            </div>
        </div>
        
        <div class="mt-4 d-flex flex-column flex-sm-row justify-content-end gap-2">
            <a href="{% url 'lista_solicitudes' %}" class="btn btn-outline-secondary px-4 d-flex align-items-center justify-content-center mb-2 mb-sm-0">
                <i class="fas fa-times me-2"></i> Cancelar
            </a>
            <button type="submit" class="btn btn-success px-4 d-flex align-items-center justify-content-center">
                <i class="fas fa-save me-2"></i> Guardar Solicitud
            </button>
        </div>
    </form>
    
    <div id="empty-form" class="d-none">
        <div class="detalle-form card mb-3 border-light shadow-sm position-relative">
            <div class="position-absolute top-0 start-0 h-100 bg-primary rounded-start" style="width: 4px;"></div>
            {{ formset.empty_form.id }}
            <div class="card-body">
                <div class="row g-3 align-items-end">
                    <div class="col-12 col-lg-4 mb-0">
                        <label class="form-label fw-semibold">Artículo <span class="text-danger">*</span></label>
                        <div class="input-group">
                            {{ formset.empty_form.articulo|add_class:"form-control select2-articulo" }}
                        </div>
                    </div>
                    
                    <div class="col-12 col-sm-6 col-lg-3 mb-0">
                        <div class="row g-2 align-items-end">
                            <div class="col-8 mb-0">
                                <label class="form-label fw-semibold">Cantidad <span class="text-danger">*</span></label>
                                {{ formset.empty_form.cantidad|add_class:"form-control cantidad-input" }}
                            </div>
                            <div class="col-4 mb-0">
                                <label class="form-label fw-semibold">U.M.</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-light">
                                        <i class="fas fa-ruler text-muted"></i>
                                    </span>
                                    <input type="text" class="form-control unidad-medida-display" readonly placeholder="U.M.">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-12 col-sm-6 col-lg-3 mb-0">
                        <label class="form-label fw-semibold">Precio Unitario <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <span class="input-group-text bg-light">$</span>
                            {{ formset.empty_form.precio_unitario|add_class:"form-control precio-input text-end" }}
                            <button class="btn btn-outline-success update-catalog-price-btn" type="button" title="Guardar este precio en el Catálogo Maestro">
                                <i class="fas fa-save"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="col-12 col-lg-2 d-flex align-items-end justify-content-start justify-content-lg-end mb-0">
                         {% if formset.can_delete %}
                            <div class="d-none">{{ formset.empty_form.DELETE }}</div>
                        {% endif %}
                        <button type="button" class="btn btn-sm btn-outline-danger remove-form d-flex align-items-center w-100 w-lg-auto justify-content-center">
                            <i class="fas fa-trash me-1 d-none d-sm-inline"></i> Eliminar
                        </button>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="d-flex flex-column flex-sm-row flex-wrap gap-3 text-sm">
                            <div class="articulo-info d-flex align-items-center">
                                <small class="text-muted">SKU:</small>
                                <span class="badge bg-light text-dark ms-1 sku-display">--</span>
                            </div>
                            <div class="articulo-info d-flex align-items-center">
                                <small class="text-muted">Categoría:</small>
                                <span class="badge bg-light text-dark ms-1 categoria-display">--</span>
                            </div>
                            <div class="articulo-info d-flex align-items-center">
                                <small class="text-muted">Tipo:</small>
                                <span class="badge bg-light text-dark ms-1 tipo-display">--</span>
                            </div>
                            <div class="articulo-info d-flex align-items-center">
                                <small class="text-muted">Impuestos:</small>
                                <span class="badge bg-info text-white ms-1 iva-badge d-none">IVA</span>
                                <span class="badge bg-warning text-dark ms-1 ret-iva-badge d-none">RET IVA</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-3 pt-3 border-top">
                    <div class="col-12">
                        <div class="d-flex flex-column flex-md-row flex-wrap justify-content-md-end gap-3 text-end">
                            <div class="mb-2">
                                <small class="text-muted d-block">Subtotal</small>
                                <p class="fw-semibold mb-0 subtotal text-primary">--</p>
                            </div>
                            <div class="mb-2">
                                <small class="text-muted d-block">IVA</small>
                                <p class="fw-semibold mb-0 iva text-info">--</p>
                            </div>
                            <div class="mb-2">
                                <small class="text-muted d-block">Ret. IVA</small>
                                <p class="fw-semibold mb-0 ret-iva text-warning">--</p>
                            </div>
                            <div class="mb-2 ps-md-3 border-start-md">
                                <small class="text-muted d-block">Total Línea</small>
                                <p class="fw-bold fs-5 mb-0 total-linea text-success">--</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="totals-summary-footer card shadow-lg border-0">
    <div class="card-body py-3">
        <div class="d-flex flex-column flex-md-row justify-content-md-end align-items-center gap-3">
            <div class="text-center text-md-end">
                <small class="text-muted d-block">SUBTOTAL</small>
                <h4 class="mb-0 text-primary" id="grand-subtotal">$0.00</h4>
            </div>
            <div class="text-center text-md-end">
                <small class="text-muted d-block">IMPUESTOS</small>
                <h4 class="mb-0 text-info" id="grand-impuestos">$0.00</h4>
            </div>
            <div class="text-center text-md-end border-start-md ps-md-4">
                <small class="text-muted d-block">GRAN TOTAL</small>
                <h3 class="mb-0 text-success fw-bold" id="grand-total">$0.00</h3>
            </div>
        </div>
    </div>
</div>

<div id="toast-container" class="position-fixed bottom-0 end-0 p-3" style="z-index: 1055"></div>

<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<style>
    /* Estilos responsivos mejorados */
    @media (max-width: 768px) {
        .card-body { padding: 1rem; }
        .input-group-text { min-width: 45px; }
        .totals-summary-footer h3, .totals-summary-footer h4 { font-size: 1.1rem; }
    }
    
    @media (max-width: 576px) {
        .btn { width: 100%; margin-bottom: 0.5rem; }
        .d-flex.flex-wrap.gap-3 { gap: 1rem !important; }
        .border-start-md { border-left: none !important; padding-left: 0 !important; }
    }
    
    .select2-container { width: 100% !important; }
    .select2-container--bootstrap-5 .select2-selection { border-radius: 0.375rem; }
    
    .totals-summary-footer { position: fixed; bottom: 0; left: 0; right: 0; z-index: 1030; border-radius: 0; }
    .articulo-info { margin-bottom: 0.5rem; }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    
    // --- Referencias DOM ---
    const operacionSelect = document.getElementById('id_operacion'); 
    const lugarSelect = document.getElementById('id_empresa_lugar'); 
    const proveedorSelect = document.getElementById('id_proveedor');
    
    const formContainer = document.getElementById('detalle-forms-container');
    const addButton = document.getElementById('add-form');
    const totalFormsInput = document.getElementById('id_detalles-TOTAL_FORMS');
    const emptyFormTemplate = document.getElementById('empty-form').innerHTML;
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    const noLugarMsg = document.getElementById('no-lugar-mensaje'); 
    const noProveedorMsg = document.getElementById('no-proveedor-mensaje');
    const noArticulosMsg = document.getElementById('no-articulos-mensaje');

    let articulosActuales = []; 

    // --- Formateadores ---
    function formatCurrency(v) { 
        return isNaN(v) ? '$0.00' : `$${v.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2})}`; 
    }

    // --- CÁLCULO DE TOTALES (Lógica Corregida) ---
    function calculateAll() {
        let grandSubtotal = 0, grandImpuestos = 0, grandTotal = 0;
        
        document.querySelectorAll('.detalle-form').forEach(form => {
            // 1. Obtener valores de los inputs (Cantidad y Precio)
            const cantInput = form.querySelector('.cantidad-input');
            const precioInput = form.querySelector('.precio-input');
            
            const cant = parseFloat(cantInput.value) || 0;
            // Limpiamos el precio de símbolos de moneda si los tuviera
            const precioRaw = precioInput.value || '0';
            const precio = parseFloat(precioRaw.toString().replace(/[^0-9.]/g, '')) || 0;
            
            // 2. Obtener datos del artículo usando el OPTION nativo (Más seguro que Select2 data)
            // Buscamos el <select> y luego su <option> seleccionado
            const selectElement = form.querySelector('.select2-articulo');
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            
            let subtotal = 0, iva = 0, retIVA = 0, totalLinea = 0;
            
            // Solo calculamos si hay un artículo válido seleccionado
            if (selectedOption && selectedOption.value) {
                // Si cantidad o precio son 0, el subtotal es 0, pero leemos las tasas para mostrar info
                subtotal = cant * precio;
                
                // --- LECTURA SEGURA DE TASAS ---
                // El navegador convierte data-iva-tasa a dataset.ivaTasa automáticamente
                const tasaIVA = parseFloat(selectedOption.dataset.ivaTasa) || 0;
                const tasaRet = parseFloat(selectedOption.dataset.retTasa) || 0;
                
                // Cálculo: (Subtotal * Tasa) / 100
                iva = subtotal * (tasaIVA / 100);
                retIVA = subtotal * (tasaRet / 100);
                
                totalLinea = subtotal + iva - retIVA;
                
                // Actualizar info visual del artículo (Badges)
                updateArticuloInfo(form, {
                    sku: selectedOption.dataset.sku,
                    categoria: selectedOption.dataset.categoria,
                    unidad: selectedOption.dataset.unidad,
                    tipo: selectedOption.dataset.tipo,
                    ivaTasa: tasaIVA,
                    retTasa: tasaRet
                });
            } else {
                updateArticuloInfo(form, {}); // Limpiar badges si no hay selección
            }
            
            // Acumular a totales globales
            grandSubtotal += subtotal;
            grandImpuestos += (iva - retIVA);
            grandTotal += totalLinea;
            
            // Actualizar textos de la fila
            const subtotalEl = form.querySelector('.subtotal');
            const ivaEl = form.querySelector('.iva');
            const retIvaEl = form.querySelector('.ret-iva');
            const totalLineaEl = form.querySelector('.total-linea');

            if(subtotalEl) subtotalEl.textContent = formatCurrency(subtotal);
            if(ivaEl) ivaEl.textContent = formatCurrency(iva);
            if(retIvaEl) retIvaEl.textContent = formatCurrency(retIVA);
            if(totalLineaEl) totalLineaEl.textContent = formatCurrency(totalLinea);
        });

        // Actualizar totales generales (Footer)
        const grandSubtotalEl = document.getElementById('grand-subtotal');
        const grandImpuestosEl = document.getElementById('grand-impuestos');
        const grandTotalEl = document.getElementById('grand-total');

        if(grandSubtotalEl) grandSubtotalEl.textContent = formatCurrency(grandSubtotal);
        if(grandImpuestosEl) grandImpuestosEl.textContent = formatCurrency(grandImpuestos);
        if(grandTotalEl) grandTotalEl.textContent = formatCurrency(grandTotal);
    }
    
    function updateArticuloInfo(form, data) {
        if (!form) return;
        
        // Inputs readonly
        const unidadDisplay = form.querySelector('.unidad-medida-display');
        if(unidadDisplay) unidadDisplay.value = data.unidad || '';

        // Badges de texto
        const skuDisplay = form.querySelector('.sku-display');
        const catDisplay = form.querySelector('.categoria-display');
        const tipoDisplay = form.querySelector('.tipo-display');
        
        if(skuDisplay) skuDisplay.textContent = data.sku || '--';
        if(catDisplay) catDisplay.textContent = data.categoria || '--';
        if(tipoDisplay) tipoDisplay.textContent = data.tipo || '--';
        
        // Badges de Impuestos
        const badgeIva = form.querySelector('.iva-badge');
        const badgeRet = form.querySelector('.ret-iva-badge');
        
        if (badgeIva) {
            const tasa = data.ivaTasa || 0;
            badgeIva.classList.toggle('d-none', tasa === 0);
            badgeIva.textContent = `IVA ${tasa}%`;
        }
        
        if (badgeRet) {
            const tasa = data.retTasa || 0;
            badgeRet.classList.toggle('d-none', tasa === 0);
            badgeRet.textContent = `RET ${tasa}%`;
        }
    }

    function initializeSelect2(el) { 
        $(el).select2({ 
            theme: 'bootstrap-5',
            placeholder: "Seleccione un artículo", 
            allowClear: true, 
            width: '100%',
            language: { noResults: () => "Sin resultados" }
        }); 
    }

    // --- CARGA DE DATOS DESDE API ---
    function fetchArticulos(proveedorId) {
        $('.select2-articulo').prop('disabled', true);
        if (noArticulosMsg) noArticulosMsg.classList.add('d-none');
        if (addButton) addButton.disabled = true;

        if (!proveedorId) {
            articulosActuales = [];
            $('.select2-articulo').empty().append('<option value="">Seleccione un proveedor primero</option>').trigger('change');
            return;
        }

        fetch(`/compras/api/articulos_por_proveedor/${proveedorId}/`)
            .then(res => res.json())
            .then(data => {
                articulosActuales = data.articulos || [];
                
                if (articulosActuales.length > 0) {
                    let optionsHtml = '<option value="">---------</option>';
                    articulosActuales.forEach(a => {
                        // IMPORTANTE: Aquí inyectamos los datos para que calculateAll los lea
                        optionsHtml += `<option value="${a.id}"
                            data-precio="${a.precio || ''}"
                            data-iva-tasa="${a.iva_tasa}" 
                            data-ret-tasa="${a.ret_iva_tasa}"
                            data-unidad="${a.unidad_medida || ''}"
                            data-sku="${a.sku || ''}"
                            data-categoria="${a.categoria || ''}"
                            data-tipo="${a.tipo || ''}"
                        >${a.nombre} (${a.sku || 'S/N'}) - $${a.precio}</option>`;
                    });

                    document.querySelectorAll('.select2-articulo').forEach(select => {
                        const $select = $(select);
                        const currentVal = $select.val();
                        
                        // Actualizar HTML y notificar a Select2
                        $select.empty().append(optionsHtml);
                        
                        if (currentVal && articulosActuales.some(a => String(a.id) === String(currentVal))) {
                            $select.val(currentVal).trigger('change'); // Usar 'change' estándar
                        } else {
                            $select.val(null).trigger('change');
                        }
                    });

                    $('.select2-articulo').prop('disabled', false);
                    addButton.disabled = false;
                } else {
                    $('.select2-articulo').empty().append('<option value="">Este proveedor no tiene artículos</option>').trigger('change');
                    if (noArticulosMsg) noArticulosMsg.classList.remove('d-none');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                $('.select2-articulo').empty().append('<option value="">Error al cargar</option>');
            });
    }

    // --- FUNCIONES API AUXILIARES ---
    function fetchEmpresas(operacionId, selectedLugarId = null) {
        lugarSelect.innerHTML = '<option value="">Cargando...</option>';
        noLugarMsg.classList.add('d-none');
        fetch(`/compras/api/empresas-por-operacion/${operacionId}/`)
            .then(res => res.json())
            .then(data => {
                if (data.empresas && data.empresas.length > 0) {
                    let options = '<option value="">---------</option>';
                    data.empresas.forEach(l => {
                        const sel = selectedLugarId && l.id == selectedLugarId ? 'selected' : '';
                        options += `<option value="${l.id}" ${sel}>${l.nombre}</option>`;
                    });
                    lugarSelect.innerHTML = options;
                    lugarSelect.disabled = false;
                } else {
                    lugarSelect.innerHTML = '<option value="">No hay empresas</option>';
                    lugarSelect.disabled = true;
                    noLugarMsg.classList.remove('d-none');
                }
            });
    }

    function fetchProveedores(operacionId, selectedProveedorId = null) {
        proveedorSelect.innerHTML = '<option value="">Cargando...</option>';
        noProveedorMsg.classList.add('d-none');
        fetch(`/compras/api/proveedores_por_empresa/${operacionId}/`) 
            .then(res => res.json())
            .then(data => {
                if (data.proveedores.length > 0) {
                    let options = '<option value="">---------</option>';
                    data.proveedores.forEach(p => {
                        const sel = selectedProveedorId && p.id == selectedProveedorId ? 'selected' : '';
                        options += `<option value="${p.id}" ${sel}>${p.razon_social}</option>`;
                    });
                    proveedorSelect.innerHTML = options;
                    proveedorSelect.disabled = false;
                    if (selectedProveedorId) fetchArticulos(selectedProveedorId);
                } else {
                    proveedorSelect.innerHTML = '<option value="">No hay proveedores</option>';
                    proveedorSelect.disabled = true;
                    noProveedorMsg.classList.remove('d-none');
                    fetchArticulos(null); 
                }
            });
    }

    // --- EVENT LISTENERS ---
    
    if (operacionSelect) {
        operacionSelect.addEventListener('change', () => {
            if (operacionSelect.value) {
                fetchEmpresas(operacionSelect.value);
                fetchProveedores(operacionSelect.value);
            } else {
                lugarSelect.innerHTML = '<option value="">Seleccione una operación</option>'; lugarSelect.disabled = true;
                proveedorSelect.innerHTML = '<option value="">Seleccione una operación</option>'; proveedorSelect.disabled = true;
            }
            fetchArticulos(null);
        });
    }

    if (proveedorSelect) {
        proveedorSelect.addEventListener('change', () => fetchArticulos(proveedorSelect.value));
    }

    // Evento Select2: Cambio de Artículo
    $(formContainer).on('select2:select change', '.select2-articulo', function(e) {
        // Al cambiar el select, Select2 actualiza el <option selected> subyacente.
        // Solo necesitamos buscar ese option nativo.
        const select = this;
        const selectedOption = select.options[select.selectedIndex];
        
        if (!selectedOption || !selectedOption.value) {
            // Si se deselecciona
            const form = select.closest('.detalle-form');
            if(form) {
                form.querySelector('.precio-input').value = '';
                form.querySelector('.unidad-medida-display').value = '';
            }
            calculateAll();
            return;
        }

        const form = select.closest('.detalle-form');
        const precioInput = form.querySelector('.precio-input');
        
        // Asignar precio sugerido si existe y el input está vacío o es un cambio nuevo
        // Nota: e.type === 'select2:select' es cuando el usuario elige manualmente
        if(selectedOption.dataset.precio && (e.type === 'select2:select' || precioInput.value === '')) {
            precioInput.value = selectedOption.dataset.precio;
        }

        calculateAll();
    });

    // Recálculo al escribir cantidad o precio
    formContainer.addEventListener('input', e => { 
        if (e.target.matches('.cantidad-input, .precio-input')) {
            calculateAll(); 
        }
    });

    // Eliminar fila
    formContainer.addEventListener('click', e => {
        const btnDelete = e.target.closest('.remove-form');
        if (btnDelete) {
            const row = btnDelete.closest('.detalle-form');
            const deleteInput = row.querySelector('input[name$="-DELETE"]');
            if (deleteInput) {
                deleteInput.checked = true;
                row.classList.add('d-none');
            } else {
                row.remove();
            }
            calculateAll();
        }
    });

    // Agregar Fila
    if (addButton) {
        addButton.addEventListener('click', () => {
            let formNum = parseInt(totalFormsInput.value);
            const newFormHtml = emptyFormTemplate.replace(/__prefix__/g, formNum);
            
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = newFormHtml;
            const newFormRow = tempDiv.firstElementChild;
            formContainer.appendChild(newFormRow);
            
            const newSelect = newFormRow.querySelector('.select2-articulo');
            
            // Rellenar con artículos cacheados
            if (articulosActuales.length > 0) {
                let optionsHtml = '<option value="">---------</option>';
                articulosActuales.forEach(a => {
                    optionsHtml += `<option value="${a.id}"
                        data-precio="${a.precio || ''}"
                        data-iva-tasa="${a.iva_tasa}"
                        data-ret-tasa="${a.ret_iva_tasa}"
                        data-unidad="${a.unidad_medida || ''}"
                        data-sku="${a.sku || ''}"
                        data-categoria="${a.categoria || ''}"
                        data-tipo="${a.tipo || ''}"
                    >${a.nombre} (${a.sku || 'S/N'}) - $${a.precio}</option>`;
                });
                $(newSelect).html(optionsHtml);
            }
            
            initializeSelect2(newSelect);
            totalFormsInput.value = formNum + 1;
        });
    }

    // Inicialización al Cargar
    function initializeForm() {
        $('.select2-articulo').each(function() { initializeSelect2(this); });
        
        if (operacionSelect && operacionSelect.value) {
            const initialLugarId = lugarSelect.getAttribute('data-initial') || lugarSelect.value;
            const initialProveedorId = proveedorSelect.value;
            
            if(lugarSelect.options.length <= 1) fetchEmpresas(operacionSelect.value, initialLugarId);
            if(proveedorSelect.options.length <= 1) fetchProveedores(operacionSelect.value, initialProveedorId);
        }
        setTimeout(calculateAll, 500); 
    }

    initializeForm();
});
</script>
{% endblock %}