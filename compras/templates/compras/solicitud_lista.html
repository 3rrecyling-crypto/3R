{% extends 'compras/compras_base.html' %}

{% load static %}

{% block compras_content %}
<div class="container-fluid px-4">
    <div class="d-flex justify-content-between align-items-center mb-4 mt-2">
        <div class="d-flex align-items-center">
            <div class="bg-primary bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 50px; height: 50px;">
                <i class="fas fa-file-alt text-primary fa-lg"></i>
            </div>
            <div>
                <h2 class="mb-0 fw-bold text-dark">Listado de Solicitudes de Compra</h2>
                <p class="text-muted mb-0">Gestión y seguimiento de solicitudes</p>
            </div>
        </div>
        <a href="{% url 'crear_solicitud' %}" class="btn btn-primary d-flex align-items-center shadow-sm">
            <i class="fas fa-plus-circle me-2"></i> Nueva Solicitud
        </a>
    </div>

    <div class="card shadow-sm mb-4 border-0">
        <div class="card-header bg-light py-3" data-bs-toggle="collapse" href="#collapseFilters" role="button" aria-expanded="true" aria-controls="collapseFilters">
            <div class="d-flex justify-content-between align-items-center">
                <h6 class="mb-0 fw-bold text-primary">
                    <i class="fas fa-filter me-2"></i>Filtros de Búsqueda
                </h6>
                <i class="fas fa-chevron-down text-primary"></i>
            </div>
        </div>
        <div class="collapse show" id="collapseFilters">
            <div class="card-body bg-light">
                <form action="" method="get" class="row g-3 align-items-end">
                    <div class="col-md-3 col-sm-6">
                        <label for="folio" class="form-label fw-semibold small text-uppercase text-muted">Folio</label>
                        <input type="text" name="folio" id="folio" class="form-control form-control-sm" value="{{ filtros_aplicados.folio|default:'' }}" placeholder="Ej: SC-1-00001">
                    </div>
<<<<<<< HEAD
                    
                    <div class="col-md-3 col-sm-6">
                        <label for="empresa" class="form-label fw-semibold small text-uppercase text-muted">Operación</label>
                        <select name="empresa" id="empresa" class="form-select form-select-sm">
                            <option value="">Todas las operaciones</option>
=======
                    <div class="col-md-3 col-sm-6">
                        <label for="empresa" class="form-label fw-semibold small text-uppercase text-muted">Empresa</label>
                        <select name="empresa" id="empresa" class="form-select form-select-sm">
                            <option value="">Todas las empresas</option>
>>>>>>> 400f8621cdea2163e4302d5550344851c937f99b
                            {% for empresa in empresas %}
                                <option value="{{ empresa.id }}" {% if filtros_aplicados.empresa == empresa.id|stringformat:"s" %}selected{% endif %}>
                                    {{ empresa.nombre }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
<<<<<<< HEAD

                    <div class="col-md-3 col-sm-6">
                        <label for="lugar" class="form-label fw-semibold small text-uppercase text-muted">Empresa</label>
                        <select name="lugar" id="lugar" class="form-select form-select-sm">
                            <option value="">Todas las empresas</option>
                            {% for lugar in lugares %}
                                <option value="{{ lugar.id }}" {% if filtros_aplicados.lugar == lugar.id|stringformat:"s" %}selected{% endif %}>
                                    {{ lugar.nombre }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    
=======
>>>>>>> 400f8621cdea2163e4302d5550344851c937f99b
                    <div class="col-md-3 col-sm-6">
                        <label for="solicitante" class="form-label fw-semibold small text-uppercase text-muted">Solicitante</label>
                        <select name="solicitante" id="solicitante" class="form-select form-select-sm">
                            <option value="">Todos los solicitantes</option>
                            {% for solicitante in solicitantes %}
                                <option value="{{ solicitante.id }}" {% if filtros_aplicados.solicitante == solicitante.id|stringformat:"s" %}selected{% endif %}>
                                    {{ solicitante.username }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <label for="estatus" class="form-label fw-semibold small text-uppercase text-muted">Estatus</label>
                        <select name="estatus" id="estatus" class="form-select form-select-sm">
                            <option value="">Todos los estatus</option>
                            {% for value, display in estatus_choices %}
                                <option value="{{ value }}" {% if filtros_aplicados.estatus == value %}selected{% endif %}>
                                    {{ display }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <label for="prioridad" class="form-label fw-semibold small text-uppercase text-muted">Prioridad</label>
                        <select name="prioridad" id="prioridad" class="form-select form-select-sm">
                            <option value="">Todas las prioridades</option>
                            {% for value, display in prioridad_choices %}
                                <option value="{{ value }}" {% if filtros_aplicados.prioridad == value %}selected{% endif %}>
                                    {{ display }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <label for="start_date" class="form-label fw-semibold small text-uppercase text-muted">Fecha Desde</label>
                        <input type="date" name="start_date" id="start_date" class="form-control form-control-sm" value="{{ filtros_aplicados.start_date|default:'' }}">
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <label for="end_date" class="form-label fw-semibold small text-uppercase text-muted">Fecha Hasta</label>
                        <input type="date" name="end_date" id="end_date" class="form-control form-control-sm" value="{{ filtros_aplicados.end_date|default:'' }}">
                    </div>
                    <div class="col-md-3 col-sm-6 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary btn-sm w-100 me-2 d-flex align-items-center justify-content-center">
                            <i class="fas fa-search me-1"></i> Aplicar Filtros
                        </button>
<<<<<<< HEAD
                    </div>
                    <div class="col-md-3 col-sm-6 d-flex align-items-end">
=======
>>>>>>> 400f8621cdea2163e4302d5550344851c937f99b
                        <a href="{% url 'lista_solicitudes' %}" class="btn btn-outline-secondary btn-sm w-100 d-flex align-items-center justify-content-center">
                            <i class="fas fa-times me-1"></i> Limpiar
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="card border-0 shadow-sm rounded-3 overflow-hidden">
        <div class="card-header bg-primary text-white py-3 d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0 fw-semibold"><i class="fas fa-list me-2"></i>Registros de solicitudes</h5>
<<<<<<< HEAD
            {% if page_obj %}
            <span class="badge bg-white text-primary rounded-pill">{{ page_obj.paginator.count }} registros</span>
            {% endif %}
=======
            <span class="badge bg-white text-primary rounded-pill">{{ solicitudes|length }} registros</span>
>>>>>>> 400f8621cdea2163e4302d5550344851c937f99b
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th class="ps-4 py-3 text-uppercase fw-semibold small text-muted">Folio</th>
<<<<<<< HEAD
                            <th class="py-3 text-uppercase fw-semibold small text-muted">Operación</th> <th class="py-3 text-uppercase fw-semibold small text-muted">Empresa</th>   <th class="py-3 text-uppercase fw-semibold small text-muted">Solicitante</th>
=======
                            <th class="py-3 text-uppercase fw-semibold small text-muted">Empresa</th>
                            <th class="py-3 text-uppercase fw-semibold small text-muted">Solicitante</th>
>>>>>>> 400f8621cdea2163e4302d5550344851c937f99b
                            <th class="py-3 text-uppercase fw-semibold small text-muted">Fecha</th>
                            <th class="py-3 text-uppercase fw-semibold small text-muted">Prioridad</th>
                            <th class="py-3 text-uppercase fw-semibold small text-muted">Estatus</th>
                            <th class="text-center pe-4 py-3 text-uppercase fw-semibold small text-muted">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for solicitud in solicitudes %}
                        <tr class="border-bottom">
                            <td class="ps-4 fw-bold text-primary">{{ solicitud.folio }}</td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="bg-light rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 28px; height: 28px;">
<<<<<<< HEAD
                                        <i class="fas fa-sitemap text-primary small"></i> </div>
                                    <span class="fw-medium">{{ solicitud.empresa.nombre }}</span>
                                </div>
                            </td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="bg-light rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 28px; height: 28px;">
                                        <i class="fas fa-building text-secondary small"></i>
                                    </div>
                                    <span class="fw-medium">{{ solicitud.lugar.nombre|default:"N/A" }}</span>
=======
                                        <i class="fas fa-building text-primary small"></i>
                                    </div>
                                    <span class="fw-medium">{{ solicitud.empresa.nombre }}</span>
>>>>>>> 400f8621cdea2163e4302d5550344851c937f99b
                                </div>
                            </td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="bg-primary bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 32px; height: 32px;">
                                        <i class="fas fa-user text-primary small"></i>
                                    </div>
                                    <span>{{ solicitud.solicitante.username }}</span>
                                </div>
                            </td>
                            <td class="text-muted">{{ solicitud.creado_en|date:"d/m/Y" }}</td>
                            <td>
                                {% if solicitud.prioridad == 'URGENTE' %}
                                    <span class="badge bg-danger text-white fw-bold px-2 py-1 rounded-pill"><i class="fas fa-arrow-up me-1 small"></i> Urgente</span>
                                {% elif solicitud.prioridad == 'PROGRAMADO' %}
                                    <span class="badge bg-warning text-dark fw-bold px-2 py-1 rounded-pill"><i class="fas fa-minus me-1 small"></i> Programado</span>
                                {% else %}
                                    <span class="badge bg-success text-white fw-bold px-2 py-1 rounded-pill"><i class="fas fa-arrow-down me-1 small"></i> Stock</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if solicitud.estatus == 'APROBADA' %}
                                    <span class="badge bg-success text-white fw-bold px-2 py-1 rounded-pill"><i class="fas fa-check-circle me-1 small"></i> Aprobada</span>
                                {% elif solicitud.estatus == 'CERRADA' %}
                                    <span class="badge bg-info text-dark fw-bold px-2 py-1 rounded-pill"><i class="fas fa-check-double me-1 small"></i> Cerrada</span>
                                {% elif solicitud.estatus == 'PENDIENTE_APROBACION' %}
                                    <span class="badge bg-warning text-dark fw-bold px-2 py-1 rounded-pill"><i class="fas fa-clock me-1 small"></i> Pendiente</span>
                                {% elif solicitud.estatus == 'RECHAZADA' %}
                                    <span class="badge bg-danger text-white fw-bold px-2 py-1 rounded-pill"><i class="fas fa-times-circle me-1 small"></i> Rechazada</span>
                                {% elif solicitud.estatus == 'BORRADOR' %}
                                    <span class="badge bg-secondary text-white fw-bold px-2 py-1 rounded-pill"><i class="fas fa-pencil-alt me-1 small"></i> Borrador</span>
                                {% else %}
                                    <span class="badge bg-dark text-white fw-bold px-2 py-1 rounded-pill">{{ solicitud.get_estatus_display }}</span>
                                {% endif %}
                            </td>
                            <td class="text-center pe-4">
                                <a href="{% url 'detalle_solicitud' solicitud.pk %}" class="btn btn-sm btn-outline-primary rounded-pill px-3 d-inline-flex align-items-center">
                                    <i class="fas fa-eye me-1 small"></i> Ver Detalle
                                </a>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
<<<<<<< HEAD
                            <td colspan="8" class="text-center py-5">
=======
                            <td colspan="7" class="text-center py-5">
>>>>>>> 400f8621cdea2163e4302d5550344851c937f99b
                                <div class="py-4">
                                    <i class="fas fa-search-minus fa-3x text-muted mb-3 opacity-50"></i>
                                    <h5 class="text-muted fw-semibold">No se encontraron solicitudes</h5>
                                    <p class="text-muted mb-0">Intenta ajustar tus criterios de búsqueda o <a href="{% url 'lista_solicitudes' %}" class="text-primary text-decoration-none">limpia los filtros</a>.</p>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            {% if is_paginated %}
            <div class="card-footer bg-white py-3">
                <div class="d-flex flex-column align-items-center">
                    <nav aria-label="Navegación de páginas">
                        <ul class="pagination pagination-sm justify-content-center mb-2">
                            {% if page_obj.has_previous %}
                                <li class="page-item">
                                    <a class="page-link rounded px-3 py-2" href="?page={{ page_obj.previous_page_number }}&amp;{{ filtros_aplicados.urlencode }}" aria-label="Anterior">
                                        <span aria-hidden="true">&laquo;</span>
                                    </a>
                                </li>
                            {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link rounded px-3 py-2">&laquo;</span>
                                </li>
                            {% endif %}
                            
                            {% for i in paginator.page_range %}
                                {% if page_obj.number == i %}
                                    <li class="page-item active"><span class="page-link rounded px-3 py-2">{{ i }}</span></li>
                                {% else %}
                                    <li class="page-item"><a class="page-link rounded px-3 py-2" href="?page={{ i }}&amp;{{ filtros_aplicados.urlencode }}">{{ i }}</a></li>
                                {% endif %}
                            {% endfor %}
                            
                            {% if page_obj.has_next %}
                                <li class="page-item">
                                    <a class="page-link rounded px-3 py-2" href="?page={{ page_obj.next_page_number }}&amp;{{ filtros_aplicados.urlencode }}" aria-label="Siguiente">
                                        <span aria-hidden="true">&raquo;</span>
                                    </a>
                                </li>
                            {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link rounded px-3 py-2">&raquo;</span>
                                </li>
                            {% endif %}
                        </ul>
                    </nav>
                    <div class="text-muted small">
                        Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }} - Total de registros: {{ paginator.count }}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
    .table th {
        border-top: 1px solid #dee2e6;
        padding: 0.75rem 0.5rem;
        font-size: 0.8rem;
    }
    
    .table td {
        padding: 1rem 0.5rem;
        vertical-align: middle;
        font-size: 0.9rem;
    }
    
    .card {
        box-shadow: 0 0.15rem 1rem 0 rgba(58, 59, 69, 0.1);
        border: 1px solid rgba(58, 59, 69, 0.05);
    }
    
    .btn {
        border-radius: 0.35rem;
        font-weight: 500;
        transition: all 0.2s ease;
    }
    
    .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 0.125rem 0.5rem rgba(0, 0, 0, 0.1);
    }
    
    .badge {
        font-weight: 500;
    }
    
    .page-link {
        border-radius: 0.3rem;
        margin: 0 0.15rem;
        border: 1px solid #e3e6f0;
    }
    
    .form-control, .form-select {
        border: 1px solid #e3e6f0;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }
    
    .form-control:focus, .form-select:focus {
        border-color: #4e73df;
        box-shadow: 0 0 0 0.2rem rgba(78, 115, 223, 0.1);
    }
    
    .table-hover tbody tr:hover {
        background-color: rgba(78, 115, 223, 0.03);
    }
</style>
{% endblock %}