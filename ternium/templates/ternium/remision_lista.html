{% extends 'ternium/base.html' %}
{% load math_filters %}

{% block title %}Gestión de Remisiones{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
<style>
    :root {
        --primary-color: #2c3e50;
        --secondary-color: #3498db;
        --accent-color: #e74c3c;
        --gain-color: #2980b9;
        --light-color: #f8f9fa;
        --text-color: #34495e;
        --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        --hover-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
        --success-color: #2ecc71;
        --border-radius: 10px;
    }
    
    .bg-primary-gradient {
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    }
    
    .btn-primary-gradient {
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        border: none;
        color: white;
    }
    
    .btn-primary-gradient:hover {
        background: linear-gradient(135deg, var(--primary-color), #2980b9);
        color: white;
        box-shadow: var(--hover-shadow);
    }
    
    .section-title {
        color: var(--primary-color);
        font-size: 1.5rem;
        font-weight: 600;
        margin-bottom: 1.5rem;
    }

    /* BADGES DE ESTATUS */
    .status-badge {
        font-size: 0.8rem;
        font-weight: 600;
        padding: .5em .9em;
        border-radius: 50rem;
        text-transform: uppercase;
        display: inline-block;
        min-width: 90px;
        text-align: center;
    }
    .status-PENDIENTE { background-color: #f39c1233; color: #f39c12; }
    .status-TERMINADO { background-color: #3498db33; color: #3498db; }
    .status-AUDITADO { background-color: #27ae6033; color: #27ae60; }
    
    /* NUEVO ESTILO PARA CANCELADO */
    .status-CANCELADO { 
        background-color: #e9ecef; 
        color: #6c757d; 
        border: 1px solid #dee2e6;
        text-decoration: line-through; 
    }

    .text-loss { color: var(--accent-color); font-weight: bold; }
    .text-gain { color: var(--gain-color); font-weight: bold; }

    .select2-container--bootstrap-5 .select2-selection {
        font-size: 0.875rem;
        min-height: calc(1.5em + 0.5rem + 2px);
        padding: 0.25rem 0.5rem;
    }

    /* --- ESTILOS DEL LOADING OVERLAY (CARGADOR EXCEL) --- */
    #loadingOverlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.85);
        z-index: 9999;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        backdrop-filter: blur(5px);
    }
    
    .loader-content {
        text-align: center;
        background: white;
        padding: 2rem;
        border-radius: 15px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        border: 1px solid #e9ecef;
    }

    .spinner-excel {
        width: 3rem;
        height: 3rem;
        color: #198754; /* Verde Excel */
    }
</style>
{% endblock %}

{% block content %}
<div id="loadingOverlay" class="d-none">
    <div class="loader-content">
        <div class="spinner-border spinner-excel mb-3" role="status">
            <span class="visually-hidden">Cargando...</span>
        </div>
        <h5 class="fw-bold text-dark mb-1">Generando Excel</h5>
        <p class="text-muted mb-0">Preparando datos, por favor espere...</p>
    </div>
</div>

<div class="container-fluid px-4 mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="section-title"><i class="fas fa-truck-moving me-2"></i>Gestión de Remisiones</h1>
            <p class="mb-0 text-muted">Listado completo de remisiones registradas en el sistema</p>
        </div>
        <a href="{% url 'crear_remision' %}" class="btn btn-primary-gradient shadow-sm py-2 px-3 rounded-pill">
            <i class="fas fa-plus-circle me-2"></i>Nueva Remisión
        </a>
    </div>

    <div class="card shadow mb-4">
        <div class="card-header py-3 d-flex justify-content-between align-items-center bg-primary-gradient text-white">
            <h6 class="m-0 font-weight-bold"><i class="fas fa-filter me-2"></i>Filtros Avanzados</h6>
            <button class="btn btn-link p-0 text-white" type="button" data-bs-toggle="collapse" data-bs-target="#filterCollapse"><i class="fas fa-chevron-down"></i></button>
        </div>
        <div class="card-body collapse show" id="filterCollapse" style="background-color: #f8f9fa;">
            <form method="get" action="" class="needs-validation" novalidate id="filterForm">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label for="q_remision" class="form-label small fw-bold">N° Remisión</label>
                        <input type="text" name="q_remision" id="q_remision" class="form-control form-control-sm" placeholder="Buscar por número exacto..." value="{{ search_params.q_remision|default:'' }}" list="remision-list">
                        <datalist id="remision-list">
                            {% for num in all_remision_numbers %}
                            <option value="{{ num }}">
                            {% endfor %}
                        </datalist>
                    </div>
                    <div class="col-md-4">
                        <label for="q_prefijo" class="form-label small fw-bold">Operación</label>
                        <select name="q_prefijo" id="q_prefijo" class="form-select form-select-sm searchable-select">
                            <option value="" {% if not search_params.q_prefijo %}selected{% endif %}>Todas</option>
                            {% for prefijo in prefijos %}
                                <option value="{{ prefijo }}" {% if search_params.q_prefijo == prefijo %}selected{% endif %}>{{ prefijo }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="q_material" class="form-label small fw-bold">Material</label>
                        <select name="q_material" id="q_material" class="form-select form-select-sm searchable-select">
                            <option value="">Todos</option>
                            {% for material in materiales %}
                                <option value="{{ material.id }}" {% if search_params.q_material == material.id|stringformat:"s" %}selected{% endif %}>{{ material.nombre }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="q_status" class="form-label small fw-bold">Estatus</label>
                        <select name="q_status" id="q_status" class="form-select form-select-sm searchable-select">
                            <option value="">Todos</option>
                            {% for value, display in estatus_choices %}
                                <option value="{{ value }}" {% if search_params.q_status == value %}selected{% endif %}>{{ display }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="q_origen" class="form-label small fw-bold">Origen</label>
                        <select name="q_origen" id="q_origen" class="form-select form-select-sm searchable-select">
                            <option value="">Todos</option>
                            {% for origen in origenes %}
                                <option value="{{ origen.id }}" {% if search_params.q_origen == origen.id|stringformat:"s" %}selected{% endif %}>{{ origen.nombre }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="q_destino" class="form-label small fw-bold">Destino</label>
                        <select name="q_destino" id="q_destino" class="form-select form-select-sm searchable-select">
                            <option value="">Todos</option>
                            {% for destino in destinos %}
                                <option value="{{ destino.id }}" {% if search_params.q_destino == destino.id|stringformat:"s" %}selected{% endif %}>{{ destino.nombre }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="q_fecha_desde" class="form-label small fw-bold">Fecha desde</label>
                        <input type="date" name="q_fecha_desde" id="q_fecha_desde" class="form-control form-control-sm" value="{{ search_params.q_fecha_desde|default:'' }}">
                    </div>
                    <div class="col-md-3">
                        <label for="q_fecha_hasta" class="form-label small fw-bold">Fecha hasta</label>
                        <input type="date" name="q_fecha_hasta" id="q_fecha_hasta" class="form-control form-control-sm" value="{{ search_params.q_fecha_hasta|default:'' }}">
                    </div>
                </div>
                
                <div class="row mt-4">
                    <div class="col-12 d-flex justify-content-end align-items-center">
                        <a id="export-excel-btn" href="{% url 'export_remisiones_to_excel' %}" class="btn btn-outline-success btn-sm me-2 rounded-pill py-2 px-3">
                            <i class="fas fa-file-excel me-2"></i>Exportar a Excel
                        </a>
                        
                        <a href="{% url 'remision_lista' %}" class="btn btn-outline-secondary btn-sm me-2 rounded-pill py-2 px-3">
                            <i class="fas fa-broom me-2"></i>Limpiar Filtros
                        </a>
                        <button type="submit" class="btn btn-primary-gradient btn-sm shadow-sm rounded-pill py-2 px-3">
                            <i class="fas fa-search me-2"></i>Aplicar Filtros
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div class="card shadow border-0">
        <div class="card-header py-3 bg-primary-gradient text-white">
            <div class="d-flex justify-content-between align-items-center">
                <h6 class="m-0 font-weight-bold"><i class="fas fa-list-ol me-2"></i>Resultados</h6>
                <span class="badge bg-white text-dark rounded-pill py-2 px-3">{{ page_obj.paginator.count|default:"0" }} registros encontrados</span>
            </div>
        </div>
        
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover table-sm mb-0">
                    <thead style="background-color: #f0f7fc;">
                        <tr>
                            <th class="py-3 px-3">Remisión #</th>
                            <th class="py-3 px-3">Fecha</th>
                            <th class="py-3 px-3">Estatus</th>
                            <th class="py-3 px-3 text-center">Folio Factura</th>
                            
                            <th class="py-3 px-3">Origen</th>
                            <th class="py-3 px-3">Destino</th>
                            <th class="py-3 px-3">Material</th> 
                            <th class="text-end py-3 px-3">Peso Carga (Ton)</th>
                            <th class="text-end py-3 px-3">Peso Descarga (Ton)</th>
                            <th class="text-end py-3 px-3">Diferencia (Ton)</th>
                            <th class="text-center py-3 px-3">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for remision in remisiones %}
                        <tr class="align-middle">
                            <td class="fw-bold py-3 px-3">{{ remision.remision }}</td>
                            <td class="text-nowrap py-3 px-3">{{ remision.fecha|date:"d/m/Y" }}</td>
                            <td class="text-nowrap py-3 px-3"><span class="status-badge status-{{ remision.status }}">{{ remision.get_status_display }}</span></td>
                            
                            <td class="py-3 px-3 text-center">
                                {% if remision.facturas.exists %}
                                    {% for factura in remision.facturas.all %}
                                        <a href="{% url 'detalle_factura_cliente' factura.id %}" class="badge bg-success text-decoration-none border border-light shadow-sm" data-bs-toggle="tooltip" title="Ver Factura">
                                            <i class="fas fa-file-invoice me-1"></i>{{ factura.folio }}
                                        </a>
                                    {% endfor %}
                                {% else %}
                                    <span class="text-muted small">-</span>
                                {% endif %}
                            </td>

                            <td class="py-3 px-3">{{ remision.origen.nombre|default:"-" }}</td>
                            <td class="py-3 px-3">{{ remision.destino.nombre|default:"-" }}</td>
                            
                            <td class="py-3 px-3">
                                {% for detalle in remision.detalles.all %}
                                    {{ detalle.material.nombre }}{% if not forloop.last %}, <br>{% endif %}
                                {% empty %}
                                    <span class="text-muted small">-</span>
                                {% endfor %}
                            </td>

                            <td class="text-end py-3 px-3">{{ remision.total_peso_ld|floatformat:3 }}</td>
                            <td class="text-end py-3 px-3">{{ remision.total_peso_dlv|floatformat:3 }}</td>
                            <td class="text-end py-3 px-3">
                                {% with diff=remision.total_peso_dlv|sub:remision.total_peso_ld %}
                                    <span class="{% if diff < 0 %}text-loss{% elif diff > 0 %}text-gain{% endif %}">
                                        {{ diff|floatformat:3 }}
                                    </span>
                                {% endwith %}
                            </td>
                            <td class="text-center py-3 px-3">
                                <div class="btn-group btn-group-sm" role="group">
                                    <a href="{% url 'detalle_remision' pk=remision.pk %}" class="btn btn-outline-primary" data-bs-toggle="tooltip" title="Ver detalles"><i class="fas fa-eye"></i></a>
                                    
                                    {% if remision.status != 'AUDITADO' and remision.status != 'CANCELADO' %}
                                        <a href="{% url 'editar_remision' pk=remision.pk %}" class="btn btn-outline-primary" data-bs-toggle="tooltip" title="Editar"><i class="fas fa-edit"></i></a>
                                        
                                        <form action="{% url 'cancelar_remision' pk=remision.pk %}" method="POST" class="d-inline" onsubmit="return confirm('¿Estás SEGURO de cancelar la remisión {{ remision.remision }}?\n\nEsto revertirá los movimientos de inventario y la quitará del dashboard.');">
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-outline-warning" data-bs-toggle="tooltip" title="Cancelar Remisión (Revertir)">
                                                <i class="fas fa-ban"></i>
                                            </button>
                                        </form>

                                        <a href="{% url 'eliminar_remision' pk=remision.pk %}" class="btn btn-outline-danger" data-bs-toggle="tooltip" title="Eliminar"><i class="fas fa-trash-alt"></i></a>
                                    {% else %}
                                        <button class="btn btn-outline-secondary disabled"><i class="fas fa-edit"></i></button>
                                        <button class="btn btn-outline-secondary disabled"><i class="fas fa-ban"></i></button>
                                        <button class="btn btn-outline-secondary disabled"><i class="fas fa-trash-alt"></i></button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="11" class="text-center py-5"> <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                                <h5 class="text-muted">No se encontraron remisiones</h5>
                                <p class="text-muted small">
                                    {% if search_params.q_remision %}
                                        No existe la remisión "{{ search_params.q_remision }}" en el histórico.
                                    {% else %}
                                        Intente ajustar los filtros de fecha o búsqueda.
                                    {% endif %}
                                </p>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        
        {% if is_paginated %}
        <div class="card-footer bg-white py-3">
            <nav aria-label="Navegación de páginas">
                <ul class="pagination pagination-sm justify-content-center mb-0 flex-wrap">
                    {% if page_obj.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page=1{% for key, value in search_params.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" aria-label="Primero">
                                <span aria-hidden="true">&laquo;&laquo;</span>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% for key, value in search_params.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" aria-label="Anterior">
                                <span aria-hidden="true">&laquo;</span>
                            </a>
                        </li>
                    {% else %}
                        <li class="page-item disabled"><span class="page-link">&laquo;&laquo;</span></li>
                        <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
                    {% endif %}

                    {% for i in page_obj.paginator.get_elided_page_range %}
                        {% if page_obj.paginator.ELLIPSIS == i %}
                            <li class="page-item disabled"><span class="page-link">...</span></li>
                        {% else %}
                            <li class="page-item {% if page_obj.number == i %}active{% endif %}">
                                <a class="page-link" href="?page={{ i }}{% for key, value in search_params.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                    {{ i }}
                                </a>
                            </li>
                        {% endif %}
                    {% endfor %}

                    {% if page_obj.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.next_page_number }}{% for key, value in search_params.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" aria-label="Siguiente">
                                <span aria-hidden="true">&raquo;</span>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% for key, value in search_params.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" aria-label="Último">
                                <span aria-hidden="true">&raquo;&raquo;</span>
                            </a>
                        </li>
                    {% else %}
                        <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
                        <li class="page-item disabled"><span class="page-link">&raquo;&raquo;</span></li>
                    {% endif %}
                </ul>
                <div class="text-center text-muted mt-2 small">
                    Mostrando registros {{ page_obj.start_index }} - {{ page_obj.end_index }} de un total de <strong>{{ page_obj.paginator.count }}</strong>
                </div>
            </nav>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
$(document).ready(function() {
    // Inicializar Tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // Inicializar Select2
    $('.searchable-select').select2({
        theme: 'bootstrap-5',
        width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style'
    });

    // Actualizar URL del botón exportar con los filtros actuales
    function updateExportUrl() {
        const form = $('#filterForm');
        const params = new URLSearchParams(new FormData(form[0])).toString();
        const exportBtn = $('#export-excel-btn');
        const baseUrl = exportBtn.attr('href').split('?')[0];
        exportBtn.attr('href', `${baseUrl}?${params}`);
    }

    $('#filterForm').on('submit input change', updateExportUrl);
    updateExportUrl();

    // --- LÓGICA DE CARGADOR DE EXCEL ---
    $('#export-excel-btn').on('click', function(e) {
        // Mostrar el overlay
        $('#loadingOverlay').removeClass('d-none');
        
        // Simular tiempo de carga (3 segundos) para feedback visual
        setTimeout(function(){
             $('#loadingOverlay').addClass('d-none');
        }, 3000); 
    });
});
</script>
{% endblock %}