{% extends 'ternium/base.html' %}
{% load static %}

{% block title %}Registro de Entradas de Maquila{% endblock %}

{% block content %}
<div class="container animate-fadein">
    <header class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h2 mb-0">Registro de Entradas</h1>
            <p class="text-muted">Gestión centralizada de la maquila.</p>
        </div>
        <div>
            <a href="{% url 'crear_entrada' %}" class="btn btn-primary shadow-sm">
                <i class="fas fa-plus me-2"></i>Nueva Entrada
            </a>
            <a href="{% url 'export_entradas_excel' %}" class="btn btn-success shadow-sm">
                <i class="fas fa-file-excel me-2"></i>Exportar a Excel
            </a>
        </div>
    </header>

    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body">
            <form method="get" action="{% url 'lista_entradas' %}">
                <div class="row g-3 align-items-end">
                    <div class="col-md-3">
                        <label for="remito_q" class="form-label small fw-bold text-muted">Remito</label>
                        <input type="text" name="q" id="remito_q" class="form-control" placeholder="Buscar por remito..." value="{{ request.GET.q }}">
                    </div>
                    <div class="col-md-2">
                        <label for="calidad_filter" class="form-label small fw-bold text-muted">Calidad</label>
                        <input type="text" name="calidad" id="calidad_filter" class="form-control" placeholder="Filtrar calidad" value="{{ request.GET.calidad }}">
                    </div>
                    <div class="col-md-2">
                        <label for="transporte_filter" class="form-label small fw-bold text-muted">Transporte</label>
                        <input type="text" name="transporte" id="transporte_filter" class="form-control" placeholder="Filtrar transporte" value="{{ request.GET.transporte }}">
                    </div>
                    <div class="col-md-2">
                        <label for="status_filter" class="form-label small fw-bold text-muted">Estatus</label>
                        <select name="status" id="status_filter" class="form-select">
                            <option value="">Todos</option>
                            <option value="PENDIENTE" {% if request.GET.status == 'PENDIENTE' %}selected{% endif %}>Pendiente</option>
                            <option value="TERMINADO" {% if request.GET.status == 'TERMINADO' %}selected{% endif %}>Terminado</option>
                            <option value="AUDITADO" {% if request.GET.status == 'AUDITADO' %}selected{% endif %}>Auditado</option>
                        </select>
                    </div>
                    <div class="col-md-3 d-flex gap-2">
                        <button type="submit" class="btn btn-primary w-100"><i class="fas fa-filter me-1"></i> Filtrar</button>
                        <a href="{% url 'lista_entradas' %}" class="btn btn-outline-secondary" title="Limpiar filtros"><i class="fas fa-times"></i></a>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div class="table-container">
        <table class="table table-hover align-middle">
            <thead>
                <tr>
                    <th>ID Remito</th>
                    <th>Fecha Ingreso</th>
                    <th>Transporte</th>
                    <th>Estatus</th>
                    <th>Alerta de Peso</th>
                    <th class="text-end">Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for entrada in entradas %}
                <tr>
                    <td class="fw-bold">{{ entrada.c_id_remito }}</td>
                    <td>{{ entrada.fecha_ingreso|date:"d/m/Y" }}</td>
                    <td>{{ entrada.transporte|default:"N/A"|truncatechars:25 }}</td>
                    <td>
                        {% if entrada.status == 'PENDIENTE' %}<span class="badge bg-warning text-dark">Pendiente</span>
                        {% elif entrada.status == 'TERMINADO' %}<span class="badge bg-info">Terminado</span>
                        {% elif entrada.status == 'AUDITADO' %}<span class="badge bg-success">Auditado</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if entrada.alerta %}
                            <span class="text-danger"><i class="fas fa-exclamation-triangle"></i> Discrepancia</span>
                        {% else %}
                            <span class="text-success"><i class="fas fa-check-circle"></i> OK</span>
                        {% endif %}
                    </td>
                    <td class="text-end">
                        <div class="btn-group btn-group-sm">
                            <a href="{% url 'detalle_entrada' pk=entrada.pk %}" class="btn btn-outline-primary" title="Ver Detalles">
                                <i class="fas fa-eye"></i>
                            </a>
                            {% if entrada.status != 'AUDITADO' %}
                            <a href="{% url 'editar_entrada' pk=entrada.pk %}" class="btn btn-outline-secondary" title="Editar">
                                <i class="fas fa-pencil-alt"></i>
                            </a>
                            {% endif %}
                            <a href="{% url 'descargar_zip_maquila' pk=entrada.pk %}" class="btn btn-outline-info" title="Descargar ZIP">
                                <i class="fas fa-file-archive"></i>
                            </a>
                            {% if entrada.status != 'AUDITADO' %}
                            <a href="{% url 'eliminar_entrada' pk=entrada.pk %}" class="btn btn-outline-danger" title="Eliminar">
                                <i class="fas fa-trash-alt"></i>
                            </a>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6" class="text-center p-5">
                        <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
                        <h4 class="mb-2">No se encontraron entradas</h4>
                        <p class="text-muted">Intenta ajustar los filtros o <a href="{% url 'crear_entrada' %}">agrega una nueva entrada</a>.</p>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {% if is_paginated %}
    <nav class="mt-4" aria-label="Paginación de resultados">
        <ul class="pagination justify-content-center">
            {% if page_obj.has_previous %}
                <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}&{{ request.GET.urlencode }}">&laquo;</a></li>
            {% else %}
                <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
            {% endif %}

            <li class="page-item active"><span class="page-link">Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span></li>

            {% if page_obj.has_next %}
                <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}&{{ request.GET.urlencode }}">&raquo;</a></li>
            {% else %}
                <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
</div>
{% endblock %}