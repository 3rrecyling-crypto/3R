{% extends 'ternium/base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Dashboard Operativo Avanzado{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>

<style>
    /* Estilos base del dashboard */
    .kpi-card {
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    }
    .kpi-value { font-size: 2.25rem; font-weight: 700; }
    .kpi-label { font-size: 0.8rem; text-transform: uppercase; }
    .chart-container { position: relative; height: 350px; }
    .table-container { height: 300px; overflow-y: auto; }
</style>

<div class="container-fluid px-4 py-4">
    <h2 class="fw-bold text-dark mb-4"><i class="fas fa-chart-line me-2 text-success"></i>Control Operacional y Financiero</h2>
    
    <div class="row g-3 mb-4">
        <div class="col-lg-2 col-md-4 col-sm-6">{% include 'ternium/kpi_card.html' with title='Ton Compradas (Mes)' value=kpi_comp_mes unit='Ton' icon='fas fa-arrow-down' color='primary' %}</div>
        <div class="col-lg-2 col-md-4 col-sm-6">{% include 'ternium/kpi_card.html' with title='Ton Vendidas (Mes)' value=kpi_vent_mes unit='Ton' icon='fas fa-arrow-up' color='success' %}</div>
        <div class="col-lg-3 col-md-4 col-sm-6">{% include 'ternium/kpi_card.html' with title='Inventario Actual' value=kpi_inv_act unit='Ton' icon='fas fa-boxes' color='info' %}</div>
        <div class="col-lg-2 col-md-4 col-sm-6">{% include 'ternium/kpi_card.html' with title='% Merma Global' value=kpi_merma_perc unit='%' icon='fas fa-trash-alt' color='danger' %}</div>
        <div class="col-lg-3 col-md-4 col-sm-6">{% include 'ternium/kpi_card.html' with title='Movimientos (Ent/Sal)' value=kpi_movs_total unit='Viajes' icon='fas fa-route' color='secondary' %}</div>
    </div>
    
    <div class="row g-4 mb-4">
        <div class="col-lg-8">
            <div class="card kpi-card h-100">
                <div class="card-header bg-white fw-bold">Volumen Mensual: Compras vs Ventas (Ton)</div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="chartVolumen"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card kpi-card h-100">
                <div class="card-header bg-white fw-bold text-danger">P√©rdidas (Merma Promedio Mensual)</div>
                <div class="card-body">
                    <div class="chart-container" style="height: 300px;">
                        <canvas id="chartMerma"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row g-4">
        <div class="col-lg-6">
            <div class="card kpi-card">
                <div class="card-header bg-white fw-bold">An√°lisis de Materiales (Top 10)</div>
                <div class="card-body table-container">
                    <table class="table table-striped table-hover small mb-0">
                        <thead class="sticky-top bg-light">
                            <tr>
                                <th>Material</th>
                                <th class="text-primary">Comprado (Ton)</th>
                                <th class="text-success">Vendido (Ton)</th>
                                <th class="text-info">Stock (Ton)</th>
                                <th class="text-danger">Alertas Merma</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for material, data in material_analysis %}
                            <tr>
                                <td class="fw-bold">{{ material }}</td>
                                <td>{{ data.comprado|floatformat:2|intcomma }}</td>
                                <td>{{ data.vendido|floatformat:2|intcomma }}</td>
                                <td>{{ data.stock|floatformat:2|intcomma }}</td>
                                <td>
                                    {% if data.merma_incidencias > 0 %}
                                        <span class="badge bg-danger">{{ data.merma_incidencias }}</span>
                                    {% else %}
                                        <span class="badge bg-light text-muted">0</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3">
            <div class="card kpi-card h-100">
                <div class="card-header bg-white fw-bold">Top 5 Proveedores (Por Volumen)</div>
                <div class="card-body table-container">
                    <table class="table table-hover table-sm mb-0">
                        <thead>
                            <tr><th>Proveedor</th><th>Ton</th><th>Avg Merma</th></tr>
                        </thead>
                        <tbody>
                            {% for p in top_proveedores %}
                            <tr>
                                <td class="fw-bold">{{ p.transporte }}</td>
                                <td>{{ p.toneladas|floatformat:1|intcomma }}</td>
                                <td><span class="badge bg-{% if p.avg_merma_perc > 5 %}danger{% else %}success{% endif %}">{{ p.avg_merma_perc|floatformat:1 }}%</span></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="col-lg-3">
            <div class="card kpi-card h-100">
                <div class="card-header bg-white fw-bold">Top 5 Clientes (Por Consumo)</div>
                <div class="card-body table-container">
                    <table class="table table-hover table-sm mb-0">
                        <thead>
                            <tr><th>Cliente</th><th>Ton</th><th>Viajes</th></tr>
                        </thead>
                        <tbody>
                            {% for c in top_clientes %}
                            <tr>
                                <td class="fw-bold">{{ c.transportista__nombre|default:"Sin Nombre" }}</td>
                                <td>{{ c.toneladas|floatformat:1|intcomma }}</td>
                                <td>{{ c.viajes }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid px-4 py-4 mt-4">
    <div class="row">
        <div class="col-12">
            <h3 class="fw-bold mb-3"><i class="fas fa-list-alt me-2 text-secondary"></i>Actividad Reciente (Boletas/Remisiones)</h3>
            <div class="row g-4">
                <div class="col-md-6">
                    <div class="card kpi-card">
                        <div class="card-header bg-light fw-bold text-primary">√öltimas Entradas (Boletas de Maquila)</div>
                        <div class="card-body table-container">
                            <table class="table table-sm mb-0">
                                {% for entrada in ultimas_entradas %}
                                <tr>
                                    <td class="fw-bold text-primary">{{ entrada.folio }}</td>
                                    <td>{{ entrada.calidad_mat|default:"Sin Calidad" }}</td>
                                    <td>{{ entrada.peso|floatformat:1 }} Ton</td>
                                    <td class="small text-muted">{{ entrada.trans|default:"Sin Transporte" }}</td>
                                </tr>
                                {% endfor %}
                            </table>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card kpi-card">
                        <div class="card-header bg-light fw-bold text-success">√öltimas Salidas (Remisiones de Log√≠stica)</div>
                        <div class="card-body table-container">
                            <table class="table table-sm mb-0">
                                {% for salida in ultimas_salidas %}
                                <tr>
                                    <td class="fw-bold text-success">{{ salida.remision }}</td>
                                    <td>{{ salida.material__nombre|default:"Sin Material" }}</td>
                                    <td>{{ salida.toneladas_remisionadas|floatformat:1 }} Ton</td>
                                    <td class="small text-muted">{{ salida.transportista__nombre|default:"Sin Transportista" }}</td>
                                </tr>
                                {% endfor %}
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // üü© A√±adir las etiquetas de datos a las gr√°ficas (lo que llamaste "ponerles n√∫meros")
    const plugins = [{
        id: 'datalabels',
        afterDatasetsDraw(chart, args, options) {
            const { ctx, data } = chart;
            ctx.save();
            
            data.datasets.forEach((dataset, i) => {
                const meta = chart.getDatasetMeta(i);
                if (meta.hidden) return;

                meta.data.forEach((element, index) => {
                    const dataValue = dataset.data[index];
                    const x = element.x;
                    const y = element.y - 10; // Ajustar posici√≥n vertical
                    
                    if (dataValue > 0) { // Solo mostrar si hay valor
                        // Usamos dataset.borderColor o dataset.backgroundColor para el color del texto
                        ctx.fillStyle = dataset.borderColor || dataset.backgroundColor; 
                        ctx.font = 'bold 10px Segoe UI';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillText(dataValue.toLocaleString('es-MX', { maximumFractionDigits: 1 }), x, y);
                    }
                });
            });
            ctx.restore();
        }
    }];

    // 1. Volumen Comprado vs Vendido
    const ctxVolumen = document.getElementById('chartVolumen').getContext('2d');
    new Chart(ctxVolumen, {
        type: 'line',
        data: {
            labels: {{ chart_tl_labels|safe }},
            datasets: [{
                label: 'Comprado (Ton)',
                data: {{ chart_tl_comprado|safe }},
                borderColor: '#0d6efd',
                backgroundColor: 'rgba(13, 110, 253, 0.1)',
                fill: true,
                tension: 0.4,
                pointRadius: 5
            }, {
                label: 'Vendido (Ton)',
                data: {{ chart_tl_vendido|safe }},
                borderColor: '#198754',
                backgroundColor: 'rgba(25, 135, 84, 0.1)',
                fill: true,
                tension: 0.4,
                pointRadius: 5
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'top' } },
            scales: { y: { beginAtZero: true }, x: { grid: { display: false } } }
        },
        plugins: [plugins[0]] // Aplicar plugins
    });

    // 2. P√©rdidas por Mes (Barra)
    const ctxMerma = document.getElementById('chartMerma').getContext('2d');
    new Chart(ctxMerma, {
        type: 'bar',
        data: {
            labels: {{ chart_merma_labels|safe }},
            datasets: [{
                label: 'Merma Promedio (%)',
                data: {{ chart_merma_data|safe }},
                backgroundColor: 'rgba(220, 53, 69, 0.7)',
                borderColor: '#dc3545',
                borderWidth: 1,
                borderRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true, max: 10 } } // Escala m√°xima a 10% por defecto
        },
        plugins: [plugins[0]] // Aplicar plugins
    });

</script>
{% endblock %}