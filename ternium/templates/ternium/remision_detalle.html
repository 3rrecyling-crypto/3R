{% extends 'ternium/base.html' %}
{% load math_filters %}
{% load static %}

{% block title %}{{ titulo }} - Detalle{% endblock %}

{% block extra_css %}
<style>
    :root {
        --primary-color: #1e3a8a;
        --secondary-color: #3b82f6;
        --accent-color: #ef4444;
        --gain-color: #10b981;
        --warning-color: #f59e0b;
        --light-bg: #f8fafc;
        --card-border: #e2e8f0;
        --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    
    body {
        background-color: var(--light-bg);
    }
    
    /* Encabezado Principal */
    .remision-header {
        background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
        color: white;
        padding: 2rem;
        border-radius: 12px;
        box-shadow: var(--card-shadow);
        margin-bottom: 2rem;
        position: relative;
        overflow: hidden;
    }

    .status-badge {
        background-color: rgba(255, 255, 255, 0.2);
        padding: 0.5rem 1rem;
        border-radius: 50px;
        backdrop-filter: blur(5px);
        font-weight: 600;
        letter-spacing: 0.5px;
    }

    /* Tarjetas de Información */
    .info-card {
        background: white;
        border-radius: 12px;
        border: 1px solid var(--card-border);
        box-shadow: var(--card-shadow);
        height: 100%;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        overflow: hidden;
    }
    
    .info-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }

    .card-header-custom {
        background-color: #f8fafc;
        border-bottom: 1px solid var(--card-border);
        padding: 1rem 1.5rem;
        font-weight: 600;
        color: var(--primary-color);
        display: flex;
        align-items: center;
    }

    .card-body-custom {
        padding: 1.5rem;
    }

    .data-label {
        color: #64748b;
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 0.25rem;
    }

    .data-value {
        color: #1e293b;
        font-weight: 600;
        font-size: 1rem;
    }

    /* Estilos para la Galería de Evidencias */
    .preview-item {
        width: 140px;
        height: 160px;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        background: #fff;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .preview-item:hover {
        transform: scale(1.05);
        box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        border-color: var(--secondary-color);
    }

    .preview-content {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        background-color: #f1f5f9;
    }

    .preview-content img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .preview-footer {
        padding: 8px;
        background: white;
        text-align: center;
        border-top: 1px solid #e2e8f0;
    }

    .file-icon {
        font-size: 3rem;
    }

    /* Modal Oscuro para Previsualización */
    #filePreviewModal .modal-body {
        padding: 0;
        background-color: #0f172a; /* Fondo oscuro */
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 500px;
    }
    #filePreviewModal .modal-content {
        background-color: transparent;
        border: none;
    }
    #filePreviewModal .btn-close {
        background-color: white;
        opacity: 0.8;
        position: absolute;
        right: 15px;
        top: 15px;
        z-index: 1056;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-4">
    
    <div class="remision-header">
        <div class="d-flex justify-content-between align-items-start">
            <div>
                <h1 class="h2 mb-2 fw-bold">Remisión: {{ object.remision }}</h1>
                <p class="mb-0 opacity-75"><i class="far fa-calendar-alt me-2"></i>{{ object.fecha|date:"d de F, Y" }}</p>
            </div>
            <div class="text-end">
                <span class="status-badge mb-2 d-inline-block">
                    {% if object.status == 'TERMINADO' %}
                        <i class="fas fa-check-circle me-1"></i> TERMINADO
                    {% elif object.status == 'PENDIENTE' %}
                        <i class="fas fa-clock me-1"></i> PENDIENTE
                    {% elif object.status == 'AUDITADO' %}
                        <i class="fas fa-shield-alt me-1"></i> AUDITADO
                    {% elif object.status == 'CANCELADO' %}
                        <i class="fas fa-ban me-1"></i> CANCELADO
                    {% endif %}
                </span>
                <div>
                    <a href="{% url 'remision_lista' %}" class="btn btn-light btn-sm mt-2 text-primary fw-bold">
                        <i class="fas fa-arrow-left me-1"></i> Volver
                    </a>
                    {% if object.status != 'AUDITADO' %}
                    <a href="{% url 'remision_editar' object.pk %}" class="btn btn-warning btn-sm mt-2 fw-bold">
                        <i class="fas fa-edit me-1"></i> Editar
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-lg-8">
            
            <div class="card info-card mb-4">
                <div class="card-header-custom">
                    <i class="fas fa-truck text-secondary me-2"></i> Datos de Transporte
                </div>
                <div class="card-body-custom">
                    <div class="row g-4">
                        <div class="col-md-6">
                            <div class="data-label">Empresa</div>
                            <div class="data-value">{{ object.empresa.nombre }}</div>
                        </div>
                        <div class="col-md-6">
                            <div class="data-label">Línea de Transporte</div>
                            <div class="data-value">{{ object.linea_transporte.nombre|default:"---" }}</div>
                        </div>
                        <div class="col-md-4">
                            <div class="data-label">Operador</div>
                            <div class="data-value">{{ object.operador.nombre|default:"---" }}</div>
                        </div>
                        <div class="col-md-4">
                            <div class="data-label">Unidad</div>
                            <div class="data-value">{{ object.unidad.internal_id|default:"---" }}</div>
                        </div>
                        <div class="col-md-4">
                            <div class="data-label">Contenedor / Caja</div>
                            <div class="data-value">{{ object.contenedor.nombre|default:"---" }}</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row g-4 mb-4">
                <div class="col-md-6">
                    <div class="card info-card h-100 border-start-0 border-top-0 border-bottom-0 border-5 border-success">
                        <div class="card-body-custom">
                            <div class="d-flex align-items-center mb-3">
                                <div class="bg-success text-white rounded-circle p-2 me-3">
                                    <i class="fas fa-map-marker-alt"></i>
                                </div>
                                <h5 class="mb-0 text-success fw-bold">ORIGEN</h5>
                            </div>
                            <h4 class="fw-bold mb-1">{{ object.origen.nombre }}</h4>
                            <p class="text-muted small mb-3">Folio: {{ object.folio_ld|default:"N/A" }}</p>
                            
                            <div class="d-flex justify-content-between border-top pt-2">
                                <div>
                                    <span class="data-label d-block">Inicia</span>
                                    <span class="fw-bold">{{ object.inicia_ld|date:"d/m H:i"|default:"---" }}</span>
                                </div>
                                <div>
                                    <span class="data-label d-block">Termina</span>
                                    <span class="fw-bold">{{ object.termina_ld|date:"d/m H:i"|default:"---" }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card info-card h-100 border-start-0 border-top-0 border-bottom-0 border-5 border-primary">
                        <div class="card-body-custom">
                            <div class="d-flex align-items-center mb-3">
                                <div class="bg-primary text-white rounded-circle p-2 me-3">
                                    <i class="fas fa-flag-checkered"></i>
                                </div>
                                <h5 class="mb-0 text-primary fw-bold">DESTINO</h5>
                            </div>
                            <h4 class="fw-bold mb-1">{{ object.destino.nombre }}</h4>
                            <p class="text-muted small mb-3">Folio: {{ object.folio_dlv|default:"N/A" }}</p>

                            <div class="d-flex justify-content-between border-top pt-2">
                                <div>
                                    <span class="data-label d-block">Inicia</span>
                                    <span class="fw-bold">{{ object.inicia_dlv|date:"d/m H:i"|default:"---" }}</span>
                                </div>
                                <div>
                                    <span class="data-label d-block">Termina</span>
                                    <span class="fw-bold">{{ object.termina_dlv|date:"d/m H:i"|default:"---" }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card info-card mb-4">
                <div class="card-header-custom d-flex justify-content-between">
                    <span><i class="fas fa-boxes text-secondary me-2"></i> Materiales y Pesos</span>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover mb-0 align-middle">
                        <thead class="bg-light text-secondary">
                            <tr>
                                <th class="ps-4">Material</th>
                                <th>Cliente</th>
                                <th class="text-end">Carga (kg)</th>
                                <th class="text-end">Descarga (kg)</th>
                                <th class="text-center">Diferencia</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for detalle in object.detalles.all %}
                            <tr>
                                <td class="ps-4 fw-bold">{{ detalle.material.nombre }}</td>
                                <td class="text-muted small">{{ detalle.cliente.nombre }}</td>
                                <td class="text-end font-monospace">{{ detalle.peso_ld|floatform:0 }}</td>
                                <td class="text-end font-monospace">{{ detalle.peso_dlv|floatform:0 }}</td>
                                <td class="text-center">
                                    {% with diff=detalle.peso_dlv|sub:detalle.peso_ld %}
                                        {% if diff >= 0 %}
                                            <span class="badge bg-success bg-opacity-10 text-success">+{{ diff|floatform:0 }}</span>
                                        {% else %}
                                            <span class="badge bg-danger bg-opacity-10 text-danger">{{ diff|floatform:0 }}</span>
                                        {% endif %}
                                    {% endwith %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center py-4 text-muted">No hay materiales registrados</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot class="bg-light fw-bold">
                            <tr>
                                <td colspan="2" class="text-end">TOTALES:</td>
                                <td class="text-end">{{ object.total_peso_ld|floatform:0 }}</td>
                                <td class="text-end">{{ object.total_peso_dlv|floatform:0 }}</td>
                                <td class="text-center">
                                    {% if object.diff >= 0 %}
                                        <span class="text-success">+{{ object.diff|floatform:0 }}</span>
                                    {% else %}
                                        <span class="text-danger">{{ object.diff|floatform:0 }}</span>
                                    {% endif %}
                                </td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>

        </div> <div class="col-lg-4">
            
            <div class="card info-card mb-4">
                <div class="card-header-custom">
                    <i class="fas fa-paperclip text-secondary me-2"></i> Evidencias
                </div>
                <div class="card-body-custom">
                    {% if object.evidencias.exists %}
                        <div class="d-flex flex-wrap gap-3 justify-content-center">
                            {% for evidencia in object.evidencias.all %}
                                
                                {% if evidencia.archivo.url|lower|slice:"-3:" == "pdf" %}
                                <div class="preview-item" onclick="openPreviewModal('{{ evidencia.archivo.url }}', 'pdf', '{{ evidencia.archivo.name|escapejs }}')">
                                    <div class="preview-content">
                                        <i class="fas fa-file-pdf text-danger file-icon"></i>
                                    </div>
                                    <div class="preview-footer">
                                        <small class="d-block text-truncate fw-bold text-primary">VER PDF</small>
                                    </div>
                                </div>
                                
                                {% else %}
                                <div class="preview-item" onclick="openPreviewModal('{{ evidencia.archivo.url }}', 'image', '{{ evidencia.archivo.name|escapejs }}')">
                                    <div class="preview-content">
                                        <img src="{{ evidencia.archivo.url }}" alt="Evidencia">
                                    </div>
                                    <div class="preview-footer">
                                        <small class="d-block text-truncate fw-bold text-primary">VER FOTO</small>
                                    </div>
                                </div>
                                {% endif %}

                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <div class="mb-2 text-muted opacity-50"><i class="fas fa-folder-open fa-3x"></i></div>
                            <p class="text-muted small">No se cargaron evidencias.</p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <div class="card info-card">
                <div class="card-header-custom">
                    <i class="fas fa-comment-alt text-secondary me-2"></i> Comentarios
                </div>
                <div class="card-body-custom bg-light">
                    {% if object.descripcion %}
                        <div class="mb-3">
                            <label class="data-label">Descripción Carga:</label>
                            <p class="small text-dark">{{ object.descripcion }}</p>
                        </div>
                    {% endif %}
                    
                    {% if object.comentario %}
                        <div class="mb-0">
                            <label class="data-label">Comentarios Generales:</label>
                            <div class="p-3 bg-white rounded border border-light">
                                <p class="mb-0 fst-italic text-secondary">"{{ object.comentario }}"</p>
                            </div>
                        </div>
                    {% else %}
                        <p class="text-muted small mb-0 text-center">Sin comentarios adicionales.</p>
                    {% endif %}
                </div>
            </div>

        </div> </div>
</div>

<div class="modal fade" id="filePreviewModal" tabindex="-1" aria-labelledby="filePreviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-3" data-bs-dismiss="modal" aria-label="Close" style="z-index: 1060;"></button>
        
        <div class="modal-content bg-transparent border-0 shadow-none">
            <div class="modal-body p-0 d-flex justify-content-center align-items-center" id="previewModalBody">
                </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // FUNCIÓN PARA ABRIR EL MODAL (POPUP)
    function openPreviewModal(url, type, name) {
        const modalBody = document.getElementById('previewModalBody');
        modalBody.innerHTML = ''; // Limpiar anterior

        if (type === 'pdf') {
            // Si es PDF usamos un iframe o embed
            const iframe = document.createElement('iframe');
            iframe.src = url;
            iframe.style.width = '100%';
            iframe.style.height = '85vh';
            iframe.style.border = 'none';
            iframe.style.borderRadius = '8px';
            iframe.style.backgroundColor = 'white';
            modalBody.appendChild(iframe);
        } else {
            // Si es Imagen
            const img = document.createElement('img');
            img.src = url;
            img.className = 'img-fluid rounded shadow-lg';
            img.style.maxHeight = '90vh';
            img.style.maxWidth = '100%';
            img.style.objectFit = 'contain';
            modalBody.appendChild(img);
        }

        // Abrir Modal
        var myModal = new bootstrap.Modal(document.getElementById('filePreviewModal'));
        myModal.show();
    }
</script>
{% endblock %}