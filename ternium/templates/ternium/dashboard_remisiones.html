{% extends 'ternium/base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Análisis de Remisiones - 3R Recycling{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="container-fluid px-4 py-4" style="background-color: #f8f9fa;">

    {% if perms.ternium.acceso_reportes_kpi %}

        <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4 gap-3 bg-white p-3 rounded shadow-sm">
            <div>
                <h4 class="fw-bold text-dark mb-0"><i class="fas fa-chart-pie me-2 text-primary"></i>Dashboard Operativo</h4>
                <p class="text-muted small mb-0">Análisis de volúmenes netos y riesgo en transporte</p>
            </div>
            
            <form method="get" class="d-flex gap-2 align-items-center">
                <div class="input-group input-group-sm">
                    <span class="input-group-text bg-light"><i class="fas fa-map-marker-alt"></i></span>
                    <select name="origen" class="form-select" onchange="this.form.submit()" style="max-width: 180px;">
                        <option value="">Origen: Todos</option>
                        {% for o in origenes_list %}
                        <option value="{{ o.id }}" {% if filtro_origen_sel == o.id %}selected{% endif %}>{{ o.nombre }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="input-group input-group-sm">
                    <span class="input-group-text bg-light"><i class="fas fa-flag-checkered"></i></span>
                    <select name="destino" class="form-select" onchange="this.form.submit()" style="max-width: 180px;">
                        <option value="">Destino: Todos</option>
                        {% for d in destinos_list %}
                        <option value="{{ d.id }}" {% if filtro_destino_sel == d.id %}selected{% endif %}>{{ d.nombre }}</option>
                        {% endfor %}
                    </select>
                </div>

                {% if filtro_origen_sel or filtro_destino_sel %}
                <a href="?" class="btn btn-sm btn-outline-danger" title="Borrar Filtros"><i class="fas fa-times"></i></a>
                {% endif %}
            </form>
        </div>

        <div class="row g-3 mb-4">
            <div class="col-md-4">
                <div class="card border-0 shadow-sm h-100 overflow-hidden">
                    <div class="card-body position-relative">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="text-uppercase text-muted small fw-bold mb-0">Total Cargado</h6>
                            <i class="fas fa-truck-loading text-primary opacity-25 fa-2x"></i>
                        </div>
                        <h2 class="fw-bold text-dark mb-0">{{ kpi_carga|floatformat:2|intcomma }} <span class="fs-6 text-muted">Ton</span></h2>
                        <div class="progress mt-2" style="height: 4px;">
                            <div class="progress-bar bg-primary" role="progressbar" style="width: 100%"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card border-0 shadow-sm h-100 overflow-hidden">
                    <div class="card-body position-relative">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="text-uppercase text-muted small fw-bold mb-0">Total Descargado</h6>
                            <i class="fas fa-check-circle text-success opacity-25 fa-2x"></i>
                        </div>
                        <h2 class="fw-bold text-dark mb-0">{{ kpi_descarga|floatformat:2|intcomma }} <span class="fs-6 text-muted">Ton</span></h2>
                        <div class="progress mt-2" style="height: 4px;">
                            <div class="progress-bar bg-success" role="progressbar" style="width: 100%"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card border-0 shadow-sm h-100 overflow-hidden">
                    <div class="card-body position-relative">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="text-uppercase text-muted small fw-bold mb-0">Diferencia Neta</h6>
                            <i class="fas fa-balance-scale text-secondary opacity-25 fa-2x"></i>
                        </div>
                        <div class="d-flex align-items-end">
                            <h2 class="fw-bold text-dark mb-0">{{ kpi_merma_ton|floatformat:2|intcomma }} <span class="fs-6 text-muted">Ton</span></h2>
                            <span class="badge {% if kpi_merma_perc > 1 %}bg-danger{% else %}bg-secondary{% endif %} ms-2 mb-1">
                                {{ kpi_merma_perc }}%
                            </span>
                        </div>
                        <div class="progress mt-2" style="height: 4px;">
                            <div class="progress-bar bg-secondary" role="progressbar" style="width: {{ kpi_merma_perc }}%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-3 mb-4">
            
            <div class="col-lg-6">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-white py-3 border-bottom d-flex justify-content-between align-items-center">
                        <h6 class="fw-bold m-0 text-primary"><i class="fas fa-cubes me-2"></i>Volumen por Material</h6>
                        <small class="text-muted fst-italic">Clic para ver detalle</small>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive" style="max-height: 400px;">
                            <table class="table table-hover mb-0 align-middle small">
                                <thead class="bg-light sticky-top text-uppercase">
                                    <tr>
                                        <th class="ps-3 py-2">Material</th>
                                        <th class="text-end py-2">Carga</th>
                                        <th class="text-end py-2">Descarga</th>
                                        <th class="text-end pe-3 py-2">Diff</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for mat in lista_materiales %}
                                    <tr style="cursor: pointer; transition: background 0.2s;" onclick="abrirDetalleMaterial('{{ mat.nombre|escapejs }}')" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='white'">
                                        <td class="ps-3 py-2">
                                            <div class="fw-bold text-dark">{{ mat.nombre }}</div>
                                        </td>
                                        <td class="text-end py-2 text-muted">{{ mat.carga|floatformat:2|intcomma }}</td>
                                        <td class="text-end py-2 text-muted">{{ mat.descarga|floatformat:2|intcomma }}</td>
                                        <td class="text-end pe-3 py-2 fw-bold {% if mat.diff > 0.1 %}text-danger{% elif mat.diff < -0.1 %}text-success{% else %}text-secondary{% endif %}">
                                            {{ mat.diff|floatformat:2|intcomma }}
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr><td colspan="4" class="text-center py-4 text-muted">Sin datos disponibles.</td></tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-6">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-white py-3 border-bottom d-flex justify-content-between align-items-center">
                        <h6 class="fw-bold m-0 text-primary"><i class="fas fa-chart-line me-2"></i>Evolución Mensual</h6>
                        <span class="badge bg-light text-dark border">Ventas Reales</span>
                    </div>
                    <div class="card-body">
                        <canvas id="evolutionChart" style="max-height: 350px; width: 100%;"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-3">
            
            <div class="col-lg-7">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-white py-3 border-bottom d-flex justify-content-between align-items-center">
                        <h6 class="fw-bold m-0 text-primary"><i class="fas fa-users-cog me-2"></i>Riesgo por Operador</h6>
                        <span class="badge bg-danger bg-opacity-10 text-danger border border-danger border-opacity-25">Enfoque: Pérdidas</span>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive" style="max-height: 500px;">
                            <table class="table table-sm table-hover mb-0 small align-middle">
                                <thead class="bg-light sticky-top text-uppercase">
                                    <tr>
                                        <th class="ps-3 py-2">Operador</th>
                                        <th class="text-center py-2">Viajes</th>
                                        <th class="text-end py-2">Cargado</th>
                                        <th class="text-end py-2 text-danger">Pérdida (T)</th>
                                        <th class="text-end pe-3 py-2">% Riesgo</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for op in ranking_operadores %}
                                    <tr>
                                        <td class="ps-3 py-2">
                                            <a href="#" class="text-decoration-none fw-bold text-dark" 
                                               onclick="verDetalleOperador('{{ op.nombre|escapejs }}', '{{ op.json_detalles|escapejs }}'); return false;">
                                                <i class="fas fa-search-plus me-1 text-primary"></i>{{ op.nombre }}
                                            </a>
                                        </td>
                                        <td class="text-center py-2"><span class="badge bg-light text-dark border">{{ op.viajes }}</span></td>
                                        <td class="text-end py-2 text-muted">{{ op.cargado|floatformat:1 }}</td>
                                        
                                        <td class="text-end py-2 fw-bold {% if op.diff > 0 %}text-danger{% else %}text-muted{% endif %}">
                                            {{ op.diff|floatformat:2 }}
                                        </td>
                                        
                                        <td class="text-end pe-3 py-2">
                                            {% if op.riesgo_perc > 1.5 %}
                                                <span class="badge bg-danger">{{ op.riesgo_perc|floatformat:2 }}%</span>
                                            {% elif op.riesgo_perc > 0.5 %}
                                                <span class="badge bg-warning text-dark">{{ op.riesgo_perc|floatformat:2 }}%</span>
                                            {% else %}
                                                <span class="badge bg-success">{{ op.riesgo_perc|floatformat:2 }}%</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr><td colspan="5" class="text-center py-3 text-muted">No hay datos.</td></tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-5">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-white py-3 border-bottom d-flex justify-content-between align-items-center">
                        <h6 class="fw-bold m-0 text-primary"><i class="fas fa-clock me-2"></i>Remisiones Pendientes</h6>
                        <span class="badge bg-warning text-dark">{{ lista_pendientes|length }} Activas</span>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive" style="max-height: 500px;">
                            <table class="table table-hover mb-0 small align-middle">
                                <thead class="bg-light sticky-top text-uppercase">
                                    <tr>
                                        <th class="ps-3 py-2">Remisión</th>
                                        <th class="py-2">Antigüedad</th>
                                        <th class="text-end pe-3 py-2">Peso</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for p in lista_pendientes %}
                                    <tr>
                                        <td class="ps-3 py-2">
                                            <div class="fw-bold text-dark">{{ p.remision }}</div>
                                            <div class="text-muted" style="font-size: 0.75rem;">{{ p.unidad }}</div>
                                        </td>
                                        <td class="py-2">
                                            {% if p.dias == 0 %}
                                                <span class="badge bg-success">Hoy</span>
                                            {% elif p.dias > 5 %}
                                                <span class="badge bg-danger">Hace {{ p.dias }} días</span>
                                            {% else %}
                                                <span class="badge bg-warning text-dark">Hace {{ p.dias }} días</span>
                                            {% endif %}
                                            <div class="text-muted mt-1" style="font-size: 0.7rem;">{{ p.estado_txt }}</div>
                                        </td>
                                        <td class="text-end pe-3 py-2 fw-bold text-dark">{{ p.peso_origen|floatformat:2 }}</td>
                                    </tr>
                                    {% empty %}
                                    <tr><td colspan="3" class="text-center py-3 text-muted">Todo al día.</td></tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    {% else %}
        <div class="row justify-content-center mt-5">
            <div class="col-md-6 col-lg-5">
                <div class="card border-0 shadow-lg text-center p-5">
                    <div class="text-danger mb-4"><i class="fas fa-lock fa-4x"></i></div>
                    <h3 class="fw-bold text-dark mb-3">Acceso Restringido</h3>
                    <p class="text-muted mb-4">No tienes permisos para visualizar el Análisis de Remisiones.</p>
                    <a href="{% url 'home' %}" class="btn btn-outline-secondary">Volver al Inicio</a>
                </div>
            </div>
        </div>
    {% endif %}
</div>

<div class="offcanvas offcanvas-end shadow-lg" tabindex="-1" id="offcanvasMateriales" style="width: 800px;">
  <div class="offcanvas-header bg-primary text-white">
    <h5 class="offcanvas-title"><i class="fas fa-box-open me-2"></i>Detalle de Material</h5>
    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
  </div>
  <div class="offcanvas-body bg-light">
    <h4 id="tituloMaterial" class="mb-3 text-dark fw-bold border-bottom pb-2"></h4>
    
    <div class="table-responsive bg-white rounded shadow-sm">
        <table class="table table-striped table-hover mb-0 small text-center align-middle">
            <thead class="bg-dark text-white">
                <tr>
                    <th class="py-2">Remisión</th>
                    <th class="py-2 text-start">Ruta</th>
                    <th class="py-2">Carga</th>
                    <th class="py-2">Descarga</th>
                    <th class="py-2">Faltante</th>
                    <th class="py-2">%</th>
                    <th class="py-2">Ver</th>
                </tr>
            </thead>
            <tbody id="tablaDetalleMaterialBody"></tbody>
        </table>
    </div>
  </div>
</div>

<div class="offcanvas offcanvas-end shadow-lg" tabindex="-1" id="offcanvasOperador" style="width: 750px;">
  <div class="offcanvas-header bg-dark text-white">
    <h5 class="offcanvas-title"><i class="fas fa-exclamation-triangle me-2 text-warning"></i>Historial de Pérdidas</h5>
    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
  </div>
  <div class="offcanvas-body bg-light">
    <h4 id="nombreOperadorTitulo" class="mb-2 text-primary fw-bold"></h4>
    <p class="text-muted small mb-4 border-bottom pb-2">
        Mostrando solo viajes con faltantes superiores a 20kg.
    </p>
    
    <div class="table-responsive bg-white rounded shadow-sm">
        <table class="table table-striped table-hover mb-0 small text-center align-middle">
            <thead class="bg-danger text-white">
                <tr>
                    <th class="py-2">Remisión</th>
                    <th class="py-2 text-start">Ruta / Material</th>
                    <th class="py-2">Carga</th>
                    <th class="py-2">Descarga</th>
                    <th class="py-2 fw-bold">Faltante</th>
                    <th class="py-2">Ver</th>
                </tr>
            </thead>
            <tbody id="tablaOperadorBody"></tbody>
        </table>
    </div>
  </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        
        // 1. GRÁFICA DE EVOLUCIÓN
        const ctx = document.getElementById('evolutionChart');
        if (ctx) {
            try {
                const labels = JSON.parse('{{ chart_labels|escapejs }}');
                const dataCarga = JSON.parse('{{ chart_carga|escapejs }}');
                const dataDescarga = JSON.parse('{{ chart_descarga|escapejs }}');

                new Chart(ctx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            { 
                                label: 'Carga', data: dataCarga, 
                                borderColor: '#0d6efd', backgroundColor: 'rgba(13,110,253,0.1)', 
                                tension: 0.3, fill: true, pointRadius: 3 
                            },
                            { 
                                label: 'Descarga', data: dataDescarga, 
                                borderColor: '#198754', backgroundColor: 'rgba(25,135,84,0.1)', 
                                tension: 0.3, fill: true, pointRadius: 3 
                            }
                        ]
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false, 
                        scales: { y: { beginAtZero: true, grid: { borderDash: [2, 4] } } },
                        plugins: { legend: { position: 'top' } }
                    }
                });
            } catch (e) { console.error("Error gráfica:", e); }
        }

        // 2. DATOS DE DETALLE
        let dataMateriales = {};
        try { 
            const raw = '{{ materiales_detalle_json|escapejs }}'; 
            if(raw) dataMateriales = JSON.parse(raw); 
        } catch(e){}

        // --- FUNCIÓN A: ABRIR DETALLE MATERIAL ---
        window.abrirDetalleMaterial = function(nombre) {
            const regs = dataMateriales[nombre] || [];
            document.getElementById('tituloMaterial').innerText = nombre;
            const tbody = document.getElementById('tablaDetalleMaterialBody');
            tbody.innerHTML = '';

            if(!regs.length) {
                tbody.innerHTML = '<tr><td colspan="7" class="py-4 text-muted">Sin registros.</td></tr>';
            } else {
                regs.forEach(r => {
                    // Colores para el faltante
                    let colorClass = 'text-muted'; 
                    if(r.faltante > 0.05) colorClass='text-danger fw-bold'; 
                    else if(r.faltante < -0.05) colorClass='text-success fw-bold';

                    // Construcción de la URL (Asumimos ID estándar de Django)
                    // Si el JSON no trae ID, usamos un placeholder o folio.
                    // Nota: Asegúrate de que tu views.py mande el 'id' del objeto remision.
                    // Si no, usaremos el folio como texto.
                    let linkHtml = `<span class="text-muted">-</span>`;
                    // Suponemos que en el futuro agregarás 'id' al json. Por ahora usaremos folio en la url si es lo que tienes.
                    // Ajuste: Usaremos el folio como texto visible.
                    
                    tbody.insertAdjacentHTML('beforeend', `
                        <tr>
                            <td>
                                <strong>${r.remision}</strong><br>
                                <span class="text-muted" style="font-size:0.7rem">${r.fecha}</span>
                            </td>
                            <td class="text-start">
                                <div class="text-dark small">${r.origen} <i class="fas fa-arrow-right mx-1 text-muted"></i> ${r.destino}</div>
                            </td>
                            <td class="text-end">${r.carga.toFixed(2)}</td>
                            <td class="text-end">${r.descarga.toFixed(2)}</td>
                            <td class="text-end ${colorClass}">${r.faltante.toFixed(2)}</td>
                            <td class="text-end small">${r.porcentaje.toFixed(1)}%</td>
                            <td>
                                <a href="/remisiones/?q_remision=${r.remision}" target="_blank" class="btn btn-sm btn-outline-primary border-0">
                                    <i class="fas fa-external-link-alt"></i>
                                </a>
                            </td>
                        </tr>
                    `);
                });
            }
            new bootstrap.Offcanvas(document.getElementById('offcanvasMateriales')).show();
        };

        // --- FUNCIÓN B: ABRIR DETALLE OPERADOR ---
        window.verDetalleOperador = function(nombre, jsonString) {
            let hist = []; try { hist = JSON.parse(jsonString); } catch(e){}
            document.getElementById('nombreOperadorTitulo').innerText = nombre;
            const tbody = document.getElementById('tablaOperadorBody');
            tbody.innerHTML = '';

            if(!hist.length) {
                tbody.innerHTML = `<tr><td colspan="6" class="py-5 text-center text-success"><i class="fas fa-check-circle fa-2x mb-2"></i><br>Excelente desempeño.<br>Sin viajes con pérdidas significativas.</td></tr>`;
            } else {
                hist.forEach(v => {
                    tbody.insertAdjacentHTML('beforeend', `
                        <tr>
                            <td>
                                <strong>${v.remision}</strong><br>
                                <span class="text-muted" style="font-size:0.7rem">${v.fecha}</span>
                            </td>
                            <td class="text-start">
                                <div class="fw-bold text-primary text-truncate" style="max-width:180px" title="${v.material}">${v.material}</div>
                                <div class="text-muted small">${v.origen} &rarr; ${v.destino}</div>
                            </td>
                            <td class="text-end">${v.carga.toFixed(3)}</td>
                            <td class="text-end">${v.descarga.toFixed(3)}</td>
                            <td class="text-end fw-bold text-danger">-${v.faltante.toFixed(3)}</td>
                            <td>
                                <a href="/remisiones/?q_remision=${v.remision}" target="_blank" class="btn btn-sm btn-outline-dark border-0">
                                    <i class="fas fa-eye"></i>
                                </a>
                            </td>
                        </tr>
                    `);
                });
            }
            new bootstrap.Offcanvas(document.getElementById('offcanvasOperador')).show();
        };
    });
</script>
{% endblock %}