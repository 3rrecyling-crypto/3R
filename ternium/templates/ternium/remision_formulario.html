{% extends 'ternium/base.html' %}
{% load static %}
{% block title %}{{ titulo }}{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
<style>
    :root {
        --primary-color: #2c3e50;
        --secondary-color: #34495e;
        --accent-color: #3498db;
        --light-color: #ecf0f1;
        --success-color: #27ae60;
        --danger-color: #e74c3c;
        --border-radius: 8px;
        --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }
    .card {
        border: none;
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
    }
    .card-header {
        background-color: var(--primary-color);
        color: white;
        border-radius: var(--border-radius) var(--border-radius) 0 0 !important;
    }
    .form-label {
        font-weight: 500;
        color: var(--secondary-color);
    }
    .form-select, .form-control {
        border-radius: var(--border-radius) !important;
    }
    .detalle-form-row {
        padding: 0.75rem;
        background-color: #fafafa;
        border-bottom: 1px solid #eee;
    }
    .detalle-form-row:last-of-type {
        border-bottom: none;
    }
    .perdida-calculada-label {
        display: block;
        font-size: 0.75rem;
        font-weight: bold;
    }
    .perdida-calculada-valor {
        font-weight: bold;
        font-size: 1rem;
    }
    .text-success { color: var(--success-color) !important; }
    .text-danger { color: var(--danger-color) !important; }
    .formset-header {
        font-size: 0.8rem;
        font-weight: 600;
        color: #555;
        padding: 0.5rem 0.75rem;
        background-color: #f8f9fa;
    }
    .file-upload-card {
        padding: 1rem;
        border-radius: var(--border-radius);
        background-color: #f8fafc;
        border: 1px dashed #d1d5db;
        transition: all 0.3s ease;
    }
    .image-preview-container {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 10px;
    }
    .preview-item {
        width: 100px;
        height: 120px; /* Un poco más alto para el botón */
        border: 1px solid #ddd;
        border-radius: 4px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        background: #fff;
        position: relative;
        cursor: pointer;
        transition: transform 0.2s;
    }
    .preview-item:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .preview-item img {
        width: 100%;
        height: 80px;
        object-fit: cover;
    }
    .preview-item .file-icon-container {
        width: 100%;
        height: 80px;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #f8f9fa;
    }
    .preview-item .file-icon {
        font-size: 2rem;
        color: var(--secondary-color);
    }
    .preview-item small {
        font-size: 0.6rem;
        text-align: center;
        width: 100%;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        padding: 2px;
        margin-top: auto;
    }
    .form-error {
        color: var(--danger-color);
        font-size: 0.8rem;
        margin-top: 0.25rem;
    }
    .required-asterisk {
        color: var(--danger-color);
        margin-left: 3px;
        font-weight: bold;
    }
    /* Estilos para el Modal de Previsualización */
    #filePreviewModal .modal-body {
        padding: 0;
        background-color: #333;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 400px;
    }
    #filePreviewModal .modal-content {
        background-color: transparent;
        border: none;
    }
    #filePreviewModal .btn-close {
        background-color: white;
        opacity: 0.8;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4 mb-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>{{ titulo }}</h2>
        <a href="{% url 'remision_lista' %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>Volver a la Lista
        </a>
    </div>
    
    <form method="post" enctype="multipart/form-data" novalidate id="remisionForm">
        {% csrf_token %}

        {% if form.non_field_errors or formset.non_form_errors %}
        <div class="alert alert-danger">
            {{ form.non_field_errors }}
            {{ formset.non_form_errors }}
        </div>
        {% endif %}

        <div class="card mb-4">
            <div class="card-header"><h5><i class="fas fa-file-alt me-2"></i>Información General</h5></div>
            <div class="card-body"><div class="row g-3">
                <div class="col-md-4"><label for="{{ form.empresa.id_for_label }}" class="form-label">{{ form.empresa.label }}</label>{{ form.empresa }}<div class="form-error">{{ form.empresa.errors }}</div></div>
                
                <div class="col-md-4">
                    <label for="id_remision_display" class="form-label">Remisión</label>
                    <input type="text" id="id_remision_display" name="remision" class="form-control" 
                           readonly 
                           value="{% if is_editing %}{{ remision.remision }}{% endif %}">
                    
                    <div class="form-text">
                        {% if is_editing %}
                            El folio no puede ser modificado.
                        {% else %}
                            Este folio es automático y se asignará al guardar.
                        {% endif %}
                    </div>
                </div>

                <div class="col-md-4"><label for="{{ form.fecha.id_for_label }}" class="form-label">{{ form.fecha.label }}</label>{{ form.fecha }}<div class="form-error">{{ form.fecha.errors }}</div></div>
            </div></div>
        </div>

        <div class="card mb-4">
            <div class="card-header"><h5><i class="fas fa-truck me-2"></i>Transporte</h5></div>
            <div class="card-body"><div class="row g-3">
                <div class="col-md-6"><label for="{{ form.linea_transporte.id_for_label }}" class="form-label">{{ form.linea_transporte.label }}</label>{{ form.linea_transporte }}<div class="form-error">{{ form.linea_transporte.errors }}</div></div>
                <div class="col-md-6"><label for="{{ form.operador.id_for_label }}" class="form-label">{{ form.operador.label }}</label>{{ form.operador }}<div class="form-error">{{ form.operador.errors }}</div></div>
                <div class="col-md-6"><label for="{{ form.unidad.id_for_label }}" class="form-label">{{ form.unidad.label }}</label>{{ form.unidad }}<div class="form-error">{{ form.unidad.errors }}</div></div>
                <div class="col-md-6"><label for="{{ form.contenedor.id_for_label }}" class="form-label">{{ form.contenedor.label }}</label>{{ form.contenedor }}<div class="form-error">{{ form.contenedor.errors }}</div></div>
            </div></div>
        </div>

        <div class="card mb-4">
            <div class="card-header"><h5><i class="fas fa-route me-2"></i>Ruta y Operación</h5></div>
            <div class="card-body"><div class="row g-3">
                <div class="col-md-6">
                    <label for="{{ form.origen.id_for_label }}" class="form-label">
                        {{ form.origen.label }} <span class="required-asterisk">*</span>
                    </label>
                    {{ form.origen }}
                    <div class="form-error">{{ form.origen.errors }}</div>
                </div>
                
                <div class="col-md-6">
                    <label for="{{ form.destino.id_for_label }}" class="form-label">
                        {{ form.destino.label }} <span class="required-asterisk">*</span>
                    </label>
                    {{ form.destino }}
                    <div class="form-error">{{ form.destino.errors }}</div>
                </div>
                
                <hr class="my-3">
                <div class="col-md-3"><label for="{{ form.inicia_ld.id_for_label }}" class="form-label">{{ form.inicia_ld.label }}</label>{{ form.inicia_ld }}<div class="form-error">{{ form.inicia_ld.errors }}</div></div>
                <div class="col-md-3"><label for="{{ form.termina_ld.id_for_label }}" class="form-label">{{ form.termina_ld.label }}</label>{{ form.termina_ld }}<div class="form-error">{{ form.termina_ld.errors }}</div></div>
                <div class="col-md-3"><label for="{{ form.inicia_dlv.id_for_label }}" class="form-label">{{ form.inicia_dlv.label }}</label>{{ form.inicia_dlv }}<div class="form-error">{{ form.inicia_dlv.errors }}</div></div>
                <div class="col-md-3"><label for="{{ form.termina_dlv.id_for_label }}" class="form-label">{{ form.termina_dlv.label }}</label>{{ form.termina_dlv }}<div class="form-error">{{ form.termina_dlv.errors }}</div></div>
            </div></div>
        </div>

        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-balance-scale me-2"></i>Materiales y Pesos</h5>
                <button type="button" id="add-form" class="btn btn-success btn-sm"><i class="fas fa-plus me-1"></i> Añadir Material</button>
            </div>
            <div class="card-body p-0">
                {{ formset.management_form }}
                <div class="row g-3 formset-header align-items-center d-none d-md-flex">
                    <div class="col-md-3">MATERIAL</div><div class="col-md-2 text-end">CARGA (Ton)</div><div class="col-md-3">CLIENTE (Destino)</div><div class="col-md-2 text-end">DESCARGA (Ton)</div><div class="col-md-1 text-center">+/-</div><div class="col-md-1"></div>
                </div>
                <div id="form-container">
                    {% for form in formset %}<div class="detalle-form-row"><div class="row g-3 align-items-center">
                        <div class="col-12 col-md-3">{{ form.material }}<div class="form-error">{{ form.material.errors }}</div></div>
                        <div class="col-6 col-md-2">{{ form.peso_ld }}<div class="form-error">{{ form.peso_ld.errors }}</div></div>
                        <div class="col-12 col-md-3">{{ form.cliente }}<div class="form-error">{{ form.cliente.errors }}</div></div>
                        <div class="col-6 col-md-2">{{ form.peso_dlv }}<div class="form-error">{{ form.peso_dlv.errors }}</div></div>
                        <div class="col-6 col-md-1 text-center"><span class="perdida-calculada-label">PÉRDIDA</span><span class="perdida-calculada-valor text-danger">0.000</span></div>
                        
                        <div class="col-12 col-md-1 text-center delete-widget-cell">
                            {{ form.DELETE }} <button type="button" class="btn btn-danger btn-sm btn-delete-row w-100"><i class="fas fa-trash"></i></button>
                        </div>
                        {{ form.id }}
                    </div></div>{% endfor %}
                </div>
                <div id="empty-form-template" style="display: none;"><div class="detalle-form-row"><div class="row g-3 align-items-center">
                    <div class="col-12 col-md-3">{{ formset.empty_form.material }}</div><div class="col-6 col-md-2">{{ formset.empty_form.peso_ld }}</div><div class="col-12 col-md-3">{{ formset.empty_form.cliente }}</div><div class="col-6 col-md-2">{{ formset.empty_form.peso_dlv }}</div>
                    <div class="col-6 col-md-1 text-center"><span class="perdida-calculada-label">PÉRDIDA</span><span class="perdida-calculada-valor text-danger">0.000</span></div>
                    <div class="col-12 col-md-1 text-center delete-widget-cell">{{ formset.empty_form.DELETE }}<button type="button" class="btn btn-danger btn-sm btn-delete-row w-100"><i class="fas fa-trash"></i></button></div>
                </div></div></div>
            </div>
        </div>
        
        <div class="card mb-4">
            <div class="card-header"><h5><i class="fas fa-folder-open me-2"></i>Documentación y Evidencias</h5></div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6"><label for="{{ form.folio_ld.id_for_label }}" class="form-label">{{ form.folio_ld.label }}</label>{{ form.folio_ld }}<div class="form-error">{{ form.folio_ld.errors }}</div></div>
                    <div class="col-md-6"><label for="{{ form.folio_dlv.id_for_label }}" class="form-label">{{ form.folio_dlv.label }}</label>{{ form.folio_dlv }}<div class="form-error">{{ form.folio_dlv.errors }}</div></div>
                    
                    <div class="col-12 mt-4">
                        <div class="file-upload-card">
                            <label for="{{ form.archivos_evidencia.id_for_label }}" class="form-label fw-bold">
                                <i class="fas fa-cloud-upload-alt me-2"></i>{{ form.archivos_evidencia.label }}
                            </label>
                            {{ form.archivos_evidencia }}
                            <div class="form-text mt-2">Puede seleccionar varios archivos a la vez (Ctrl + Clic). Se aceptan imágenes y PDF.</div>
                            
                            <div id="new-files-preview" class="image-preview-container"></div>
                        </div>
                    </div>

                    {% if object and object.evidencias.all %}
                    <div class="col-12 mt-3">
                        <h6 class="border-bottom pb-2">Evidencias Guardadas:</h6>
                        <div class="d-flex flex-wrap gap-2 mt-2">
                            {% for ev in object.evidencias.all %}
                                {% if ev.archivo.url|lower|slice:"-3:" == "pdf" %}
                                    <div class="preview-item" onclick="openPreviewModal('{{ ev.archivo.url }}', 'pdf', '{{ ev.archivo.name|escapejs }}')">
                                        <div class="file-icon-container">
                                            <i class="fas fa-file-pdf file-icon text-danger"></i>
                                        </div>
                                        <div class="mt-auto w-100 text-center bg-light p-1">
                                            <small class="text-primary fw-bold">VER PDF</small>
                                        </div>
                                    </div>
                                {% else %}
                                    <div class="preview-item" onclick="openPreviewModal('{{ ev.archivo.url }}', 'image', '{{ ev.archivo.name|escapejs }}')">
                                        <img src="{{ ev.archivo.url }}" alt="Evidencia">
                                        <div class="mt-auto w-100 text-center bg-light p-1">
                                            <small class="text-primary fw-bold">VER FOTO</small>
                                        </div>
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <div class="col-12 mt-3"><label for="{{ form.comentario.id_for_label }}" class="form-label">{{ form.comentario.label }}</label>{{ form.comentario }}</div>
                </div>
            </div>
        </div>
        
        <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
            <a href="{% url 'remision_lista' %}" class="btn btn-secondary me-md-2">Cancelar</a>
            <button type="submit" class="btn btn-primary">Guardar Remisión</button>
        </div>
    </form>
</div>

<div class="modal fade" id="filePreviewModal" tabindex="-1" aria-labelledby="filePreviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0 p-2">
                <h6 class="modal-title text-white ms-2" id="filePreviewModalLabel">Visualizando Documento</h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="previewModalBody">
                </div>
        </div>
    </div>
</div>

{% endblock content %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
// --- FUNCIÓN GLOBAL PARA ABRIR EL MODAL ---
function openPreviewModal(url, type, name) {
    const modalBody = $('#previewModalBody');
    const modalTitle = $('#filePreviewModalLabel');
    modalBody.empty(); // Limpiar contenido anterior
    
    if (name) modalTitle.text(name);

    if (type === 'pdf') {
        // Opción A: Usar <embed> o <iframe> para PDF
        const iframe = $('<iframe>', {
            src: url,
            frameborder: 0,
            style: 'width: 100%; height: 80vh;'
        });
        modalBody.append(iframe);
    } else {
        // Opción B: Imagen normal
        const img = $('<img>', {
            src: url,
            class: 'img-fluid',
            style: 'max-height: 85vh; max-width: 100%; object-fit: contain;'
        });
        modalBody.append(img);
    }

    // Mostrar el modal usando Bootstrap 5
    var myModal = new bootstrap.Modal(document.getElementById('filePreviewModal'));
    myModal.show();
}

$(document).ready(function() {
    
    // --- Variables y selectores ---
    const IS_EDITING = {{ is_editing|yesno:"true,false" }}; 
    let cachedCatalogData = { materiales: [], lugares: [] };
    const formContainer = $('#form-container');
    const addButton = $('#add-form');
    const totalFormsInput = $('#id_detalles-TOTAL_FORMS');
    const empresaSelect = $('#id_empresa');
    const remisionInput = $('#id_remision_display'); 
    
    const emptyFormTemplate = $('#empty-form-template').html();

    // --- Funciones auxiliares ---
    function initializeSelect2(context) {
        $(context).find('select:not([data-select2-id])').select2({
            theme: 'bootstrap-5', width: '100%', placeholder: 'Seleccione una opción', allowClear: true
        });
        $(context).find('input[type="checkbox"][name$="-DELETE"]').hide(); 
    }
    
    function populateSelect(selectElement, options) {
        const currentVal = $(selectElement).val();
        $(selectElement).empty().append('<option value=""></option>');
        if (options) {
            options.forEach(i => $(selectElement).append(new Option(i.nombre || i.placas, i.id)));
        }
        $(selectElement).val(currentVal).trigger('change');
    }

    initializeSelect2(document);

    // --- LÓGICA PRINCIPAL AL CAMBIAR LA EMPRESA ---
    empresaSelect.on('change', function() { 
        const empresaId = $(this).val();
        addButton.prop('disabled', true);

        if (empresaId) {
            if (!IS_EDITING) { 
                fetch(`/api/get-next-remision/${empresaId}/`) 
                    .then(response => response.json())
                    .then(data => {
                        if (data.is_manual) {
                            remisionInput.prop('readonly', false);
                            remisionInput.val('');
                            remisionInput.attr('placeholder', 'Ingrese folio manualmente');
                        } else if (data.next_remision) {
                            remisionInput.val(data.next_remision);
                            remisionInput.prop('readonly', true);
                            remisionInput.attr('placeholder', '');
                        }
                    }).catch(error => {
                        console.error("Error al obtener el número de remisión:", error);
                        remisionInput.prop('readonly', false);
                    });
            }

            // Lógica para cargar catálogos
            fetch(`/api/get-catalogos/${empresaId}/`) 
                .then(response => response.json())
                .then(data => {
                    cachedCatalogData.materiales = data.materiales || [];
                    const lugares = [...(data.lugares_origen || []), ...(data.lugares_destino || [])];
                    cachedCatalogData.lugares = Array.from(new Set(lugares.map(l => l.id))).map(id => lugares.find(l => l.id === id));
                    
                    populateSelect($('#id_linea_transporte'), data.lineas_transporte);
                    populateSelect($('#id_unidad'), data.unidades);
                    populateSelect($('#id_contenedor'), data.contenedores);
                    populateSelect($('#id_origen'), data.lugares_origen);
                    populateSelect($('#id_destino'), data.lugares_destino);
                    
                    formContainer.find('.detalle-form-row').each(function() {
                        populateSelect($(this).find('.material-select'), cachedCatalogData.materiales);
                        populateSelect($(this).find('.cliente-select'), cachedCatalogData.lugares);
                    });
                }).finally(() => { addButton.prop('disabled', false); });
        } else {
            cachedCatalogData = { materiales: [], lugares: [] };
            addButton.prop('disabled', true);
            if (!IS_EDITING) {
                remisionInput.prop('readonly', false);
                remisionInput.val('');
                remisionInput.attr('placeholder', 'Seleccione empresa primero');
            }
        }
    });

    // --- LÓGICA DE SINCRONIZACIÓN DESTINO -> CLIENTE ---
    $('#id_destino').on('change', function() {
        const destinoId = $(this).val();
        if (destinoId) {
            $('#form-container .cliente-select').each(function() {
                $(this).val(destinoId).trigger('change');
            });
        }
    });

    // --- LÓGICA DEL FORMSET (Agregar Fila) ---
    addButton.on('click', function() { 
        if (!empresaSelect.val()) {
            alert('Por favor, seleccione una Unidad de Negocio (Empresa) primero.'); return;
        }
        const formIndex = parseInt(totalFormsInput.val());
        const newRowHtml = emptyFormTemplate.replace(/__prefix__/g, formIndex);
        const newRow = $(newRowHtml);
        
        formContainer.append(newRow);
        
        populateSelect(newRow.find('.material-select'), cachedCatalogData.materiales);
        populateSelect(newRow.find('.cliente-select'), cachedCatalogData.lugares);
        
        const destinoActual = $('#id_destino').val();
        if (destinoActual) {
            newRow.find('.cliente-select').val(destinoActual); 
        }

        initializeSelect2(newRow);
        totalFormsInput.val(formIndex + 1);
    });
    
    formContainer.on('click', '.btn-delete-row', function() { 
        $(this).closest('.detalle-form-row').find('input[type="checkbox"][name$="-DELETE"]').prop('checked', true).end().hide(); 
    });

    formContainer.on('input', '.peso-carga, .peso-descarga', function() { 
        const row = $(this).closest('.row');
        const carga = parseFloat(row.find('.peso-carga').val()) || 0;
        const descarga = parseFloat(row.find('.peso-descarga').val()) || 0;
        const diferencia = descarga - carga; 
        const labelSpan = row.find('.perdida-calculada-label');
        const valorSpan = row.find('.perdida-calculada-valor');

        valorSpan.text(diferencia.toFixed(3));
        if (diferencia >= 0) {
            labelSpan.text('GANANCIA').removeClass('text-danger').addClass('text-success');
            valorSpan.removeClass('text-danger').addClass('text-success');
        } else {
            labelSpan.text('PÉRDIDA').removeClass('text-success').addClass('text-danger');
            valorSpan.removeClass('text-success').addClass('text-danger');
        }
    });
    
    // --- LÓGICA DE PREVISUALIZACIÓN DE EVIDENCIAS NUEVAS ---
    // AHORA LAS NUEVAS TAMBIÉN ABREN EL POPUP
    $('#id_archivos_evidencia').on('change', function() {
        const container = $('#new-files-preview');
        container.empty();
        
        const files = this.files;
        if (files.length === 0) return;

        Array.from(files).forEach(file => {
            // Creamos un wrapper que sea clickeable
            const wrapper = $('<div class="preview-item"></div>');
            let contentHtml = '';
            let fileType = 'image'; // por defecto

            if (file.type.startsWith('image/')) {
                // Es imagen
                const reader = new FileReader();
                reader.onload = function(e) {
                    // Inyectamos la imagen y configuramos el click para abrir el modal
                    wrapper.prepend(`<img src="${e.target.result}">`);
                    
                    // Al hacer click, pasamos el base64 al modal
                    wrapper.on('click', function() {
                        openPreviewModal(e.target.result, 'image', file.name);
                    });
                }
                reader.readAsDataURL(file);
                
                contentHtml = '<div class="mt-auto w-100 text-center bg-light p-1"><small class="text-primary fw-bold">VER FOTO</small></div>';

            } else if (file.type === 'application/pdf') {
                // Es PDF
                fileType = 'pdf';
                const reader = new FileReader();
                reader.onload = function(e) {
                    // Al hacer click, pasamos el base64 al modal
                     wrapper.on('click', function() {
                        openPreviewModal(e.target.result, 'pdf', file.name);
                    });
                }
                reader.readAsDataURL(file);

                wrapper.prepend(`<div class="file-icon-container"><i class="fas fa-file-pdf file-icon text-danger"></i></div>`);
                contentHtml = '<div class="mt-auto w-100 text-center bg-light p-1"><small class="text-primary fw-bold">VER PDF</small></div>';
            
            } else {
                // Otros archivos
                wrapper.prepend(`<div class="file-icon-container"><i class="fas fa-file-alt file-icon text-muted"></i></div>`);
                contentHtml = `<div class="mt-auto w-100 text-center bg-light p-1"><small>${file.name}</small></div>`;
            }
            
            wrapper.append(contentHtml);
            container.append(wrapper);
        });
    });

    if (empresaSelect.val()) { 
        empresaSelect.trigger('change');
    } else {
        addButton.prop('disabled', true);
    }
    
    $('.detalle-form-row').each(function() {
        $(this).find('.peso-carga').trigger('input');
    });
});
</script>
{% endblock %}