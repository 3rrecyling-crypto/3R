{% extends 'ternium/base.html' %}
{% load static %}
{% block title %}{{ titulo }}{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
<style>
    :root {
        --primary-color: #2c3e50;
        --secondary-color: #34495e;
        --accent-color: #3498db;
        --light-color: #ecf0f1;
        --success-color: #27ae60;
        --danger-color: #e74c3c;
        --border-radius: 8px;
        --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }
    .card {
        border: none;
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
    }
    .card-header {
        background-color: var(--primary-color);
        color: white;
        border-radius: var(--border-radius) var(--border-radius) 0 0 !important;
    }
    .form-label {
        font-weight: 500;
        color: var(--secondary-color);
    }
    .form-select, .form-control {
        border-radius: var(--border-radius) !important;
    }
    .detalle-form-row {
        padding: 0.75rem;
        background-color: #fafafa;
        border-bottom: 1px solid #eee;
    }
    .detalle-form-row:last-of-type {
        border-bottom: none;
    }
    .perdida-calculada-label {
        display: block;
        font-size: 0.75rem;
        font-weight: bold;
    }
    .perdida-calculada-valor {
        font-weight: bold;
        font-size: 1rem;
    }
    .text-success { color: var(--success-color) !important; }
    .text-danger { color: var(--danger-color) !important; }
    .formset-header {
        font-size: 0.8rem;
        font-weight: 600;
        color: #555;
        padding: 0.5rem 0.75rem;
        background-color: #f8f9fa;
    }
    .file-upload-card {
        padding: 1.5rem;
        border-radius: var(--border-radius);
        background-color: #f8fafc;
        border: 2px dashed #d1d5db;
        transition: all 0.3s ease;
    }
    .file-upload-card:hover {
        border-color: var(--accent-color);
        background-color: #f0f4f8;
    }
    .form-error {
        color: var(--danger-color);
        font-size: 0.8rem;
        margin-top: 0.25rem;
    }
    .required-asterisk {
        color: var(--danger-color);
        margin-left: 3px;
        font-weight: bold;
    }
    
    /* Preview Styles */
    .preview-container {
        cursor: pointer;
        transition: transform 0.2s;
        position: relative;
    }
    .preview-container:hover {
        transform: scale(1.02);
    }
    .preview-overlay {
        position: absolute;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        opacity: 0;
        transition: opacity 0.2s;
        border-radius: 8px;
    }
    .preview-container:hover .preview-overlay {
        opacity: 1;
    }
    
    /* --- CORRECCIÓN Z-INDEX MODAL (EXTREMA) --- */
    /* Indices muy altos para superar cualquier Navbar o Sidebar fija */
    .modal-backdrop {
        z-index: 10050 !important;
    }
    .modal {
        z-index: 10060 !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4 mb-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>{{ titulo }}</h2>
        <a href="{% url 'remision_lista' %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>Volver a la Lista
        </a>
    </div>
    
    <form method="post" enctype="multipart/form-data" novalidate id="remisionForm">
        {% csrf_token %}

        {% if form.non_field_errors or formset.non_form_errors %}
        <div class="alert alert-danger">
            {{ form.non_field_errors }}
            {{ formset.non_form_errors }}
        </div>
        {% endif %}

        <div class="card mb-4">
            <div class="card-header"><h5><i class="fas fa-file-alt me-2"></i>Información General</h5></div>
            <div class="card-body"><div class="row g-3">
                
                <div class="col-md-4">
                    <label for="{{ form.empresa.id_for_label }}" class="form-label">{{ form.empresa.label }}</label>
                    {% if is_editing %}
                        <select class="form-select" disabled>
                            <option selected>{{ remision.empresa.nombre }}</option>
                        </select>
                        <input type="hidden" name="empresa" value="{{ form.empresa.value }}">
                    {% else %}
                        {{ form.empresa }}
                        <div class="form-error">{{ form.empresa.errors }}</div>
                    {% endif %}
                </div>
                <div class="col-md-4">
                    <label for="id_remision_display" class="form-label">Remisión</label>
                    <input type="text" id="id_remision_display" name="remision" class="form-control" 
                           readonly 
                           value="{% if is_editing %}{{ remision.remision }}{% endif %}">
                    
                    <div class="form-text">
                        {% if is_editing %}
                            El folio no puede ser modificado.
                        {% else %}
                            Este folio es automático y se asignará al guardar.
                        {% endif %}
                    </div>
                </div>

                <div class="col-md-4"><label for="{{ form.fecha.id_for_label }}" class="form-label">{{ form.fecha.label }}</label>{{ form.fecha }}<div class="form-error">{{ form.fecha.errors }}</div></div>
            </div></div>
        </div>

        <div class="card mb-4">
            <div class="card-header"><h5><i class="fas fa-truck me-2"></i>Transporte</h5></div>
            <div class="card-body"><div class="row g-3">
                <div class="col-md-6"><label for="{{ form.linea_transporte.id_for_label }}" class="form-label">{{ form.linea_transporte.label }}</label>{{ form.linea_transporte }}<div class="form-error">{{ form.linea_transporte.errors }}</div></div>
                <div class="col-md-6"><label for="{{ form.operador.id_for_label }}" class="form-label">{{ form.operador.label }}</label>{{ form.operador }}<div class="form-error">{{ form.operador.errors }}</div></div>
                <div class="col-md-6"><label for="{{ form.unidad.id_for_label }}" class="form-label">{{ form.unidad.label }}</label>{{ form.unidad }}<div class="form-error">{{ form.unidad.errors }}</div></div>
                <div class="col-md-6"><label for="{{ form.contenedor.id_for_label }}" class="form-label">{{ form.contenedor.label }}</label>{{ form.contenedor }}<div class="form-error">{{ form.contenedor.errors }}</div></div>
            </div></div>
        </div>

        <div class="card mb-4">
            <div class="card-header"><h5><i class="fas fa-route me-2"></i>Ruta y Operación</h5></div>
            <div class="card-body"><div class="row g-3">
                <div class="col-md-6">
                    <label for="{{ form.origen.id_for_label }}" class="form-label">
                        {{ form.origen.label }} <span class="required-asterisk">*</span>
                    </label>
                    {{ form.origen }}
                    <div class="form-error">{{ form.origen.errors }}</div>
                </div>
                
                <div class="col-md-6">
                    <label for="{{ form.destino.id_for_label }}" class="form-label">
                        {{ form.destino.label }} <span class="required-asterisk">*</span>
                    </label>
                    {{ form.destino }}
                    <div class="form-error">{{ form.destino.errors }}</div>
                </div>
                
                <hr class="my-3">
                <div class="col-md-3"><label for="{{ form.inicia_ld.id_for_label }}" class="form-label">{{ form.inicia_ld.label }}</label>{{ form.inicia_ld }}<div class="form-error">{{ form.inicia_ld.errors }}</div></div>
                <div class="col-md-3"><label for="{{ form.termina_ld.id_for_label }}" class="form-label">{{ form.termina_ld.label }}</label>{{ form.termina_ld }}<div class="form-error">{{ form.termina_ld.errors }}</div></div>
                <div class="col-md-3"><label for="{{ form.inicia_dlv.id_for_label }}" class="form-label">{{ form.inicia_dlv.label }}</label>{{ form.inicia_dlv }}<div class="form-error">{{ form.inicia_dlv.errors }}</div></div>
                <div class="col-md-3"><label for="{{ form.termina_dlv.id_for_label }}" class="form-label">{{ form.termina_dlv.label }}</label>{{ form.termina_dlv }}<div class="form-error">{{ form.termina_dlv.errors }}</div></div>
            </div></div>
        </div>

        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-balance-scale me-2"></i>Materiales y Pesos</h5>
                <button type="button" id="add-form" class="btn btn-success btn-sm"><i class="fas fa-plus me-1"></i> Añadir Material</button>
            </div>
            <div class="card-body p-0">
                {{ formset.management_form }}
                <div class="row g-3 formset-header align-items-center d-none d-md-flex">
                    <div class="col-md-3">MATERIAL</div><div class="col-md-2 text-end">CARGA (Ton)</div><div class="col-md-3">CLIENTE (Destino)</div><div class="col-md-2 text-end">DESCARGA (Ton)</div><div class="col-md-1 text-center">+/-</div><div class="col-md-1"></div>
                </div>
                <div id="form-container">
                    {% for form in formset %}<div class="detalle-form-row"><div class="row g-3 align-items-center">
                        <div class="col-12 col-md-3">{{ form.material }}<div class="form-error">{{ form.material.errors }}</div></div>
                        <div class="col-6 col-md-2">{{ form.peso_ld }}<div class="form-error">{{ form.peso_ld.errors }}</div></div>
                        <div class="col-12 col-md-3">{{ form.cliente }}<div class="form-error">{{ form.cliente.errors }}</div></div>
                        <div class="col-6 col-md-2">{{ form.peso_dlv }}<div class="form-error">{{ form.peso_dlv.errors }}</div></div>
                        <div class="col-6 col-md-1 text-center"><span class="perdida-calculada-label">PÉRDIDA</span><span class="perdida-calculada-valor text-danger">0.000</span></div>
                        
                        <div class="col-12 col-md-1 text-center delete-widget-cell">
                            {{ form.DELETE }} <button type="button" class="btn btn-danger btn-sm btn-delete-row w-100"><i class="fas fa-trash"></i></button>
                        </div>
                        {{ form.id }}
                    </div></div>{% endfor %}
                </div>
                <div id="empty-form-template" style="display: none;"><div class="detalle-form-row"><div class="row g-3 align-items-center">
                    <div class="col-12 col-md-3">{{ formset.empty_form.material }}</div><div class="col-6 col-md-2">{{ formset.empty_form.peso_ld }}</div><div class="col-12 col-md-3">{{ formset.empty_form.cliente }}</div><div class="col-6 col-md-2">{{ formset.empty_form.peso_dlv }}</div>
                    <div class="col-6 col-md-1 text-center"><span class="perdida-calculada-label">PÉRDIDA</span><span class="perdida-calculada-valor text-danger">0.000</span></div>
                    <div class="col-12 col-md-1 text-center delete-widget-cell">{{ formset.empty_form.DELETE }}<button type="button" class="btn btn-danger btn-sm btn-delete-row w-100"><i class="fas fa-trash"></i></button></div>
                </div></div></div>
            </div>
        </div>
        
        <div class="card mb-4">
            <div class="card-header"><h5><i class="fas fa-folder-open me-2"></i>Documentación y Evidencias</h5></div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6"><label for="{{ form.folio_ld.id_for_label }}" class="form-label">{{ form.folio_ld.label }}</label>{{ form.folio_ld }}<div class="form-error">{{ form.folio_ld.errors }}</div></div>
                    <div class="col-md-6"><label for="{{ form.folio_dlv.id_for_label }}" class="form-label">{{ form.folio_dlv.label }}</label>{{ form.folio_dlv }}<div class="form-error">{{ form.folio_dlv.errors }}</div></div>
                    
                    <div class="col-12 mt-4">
                        <div class="file-upload-card">
                            <label for="{{ form.evidencia_documento.id_for_label }}" class="form-label fw-bold">
                                <i class="fas fa-paperclip me-2"></i>{{ form.evidencia_documento.label }}
                            </label>
                            
                            {{ form.evidencia_documento }}
                            
                            <div class="form-text mt-2 text-muted">Seleccione un archivo (PDF o Imagen). Si ya existe uno, se mostrará arriba.</div>
                            
                            <div id="preview-container" class="mt-3 text-center" style="display:none;">
                                <h6 class="text-primary mb-2">Vista Previa de archivo nuevo:</h6>
                                <div class="preview-container d-inline-block rounded shadow-sm border p-1" onclick="openPreviewModalFromInput()">
                                    <div id="preview-content"></div>
                                    <div class="preview-overlay">
                                        <i class="fas fa-search-plus fa-2x"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-12 mt-3"><label for="{{ form.comentario.id_for_label }}" class="form-label">{{ form.comentario.label }}</label>{{ form.comentario }}</div>
                </div>
            </div>
        </div>
        
        <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
            <a href="{% url 'remision_lista' %}" class="btn btn-secondary me-md-2">Cancelar</a>
            <button type="submit" class="btn btn-primary">Guardar Remisión</button>
        </div>
    </form>
</div>

<div class="modal fade" id="universalModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-dark text-white py-2">
        <h5 class="modal-title fs-6"><i class="fas fa-eye me-2"></i>Vista Previa</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-0 bg-light" style="height: 80vh; position: relative;">
        <div id="modal-content-area" class="w-100 h-100 d-flex justify-content-center align-items-center">
            </div>
      </div>
    </div>
  </div>
</div>

{% endblock content %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
// --- SOLUCIÓN AL BLOQUEO DEL MODAL ---
// Mueve el modal al body al cargar para evitar conflictos de apilamiento con navbar o cards
document.addEventListener("DOMContentLoaded", function() {
    var modalEl = document.getElementById('universalModal');
    if(modalEl) {
        document.body.appendChild(modalEl);
    }
});

// Variable global para guardar el dataURI del input
let currentPreviewData = null;
let currentPreviewType = null;

function openPreviewModal(src, type) {
    const container = document.getElementById('modal-content-area');
    container.innerHTML = ''; 
    
    if (type === 'pdf') {
        const iframe = document.createElement('iframe');
        iframe.src = src;
        iframe.style.width = '100%';
        iframe.style.height = '100%';
        iframe.style.border = 'none';
        container.appendChild(iframe);
    } else {
        const img = document.createElement('img');
        img.src = src;
        img.style.maxWidth = '100%';
        img.style.maxHeight = '100%';
        img.style.objectFit = 'contain';
        container.appendChild(img);
    }
    
    const myModal = new bootstrap.Modal(document.getElementById('universalModal'));
    myModal.show();
}

function openPreviewModalFromInput() {
    if (currentPreviewData && currentPreviewType) {
        openPreviewModal(currentPreviewData, currentPreviewType);
    }
}

$(document).ready(function() {
    
    const IS_EDITING = {{ is_editing|yesno:"true,false" }}; 
    let cachedCatalogData = { materiales: [], lugares: [] };
    const formContainer = $('#form-container');
    const addButton = $('#add-form');
    const totalFormsInput = $('#id_detalles-TOTAL_FORMS');
    const empresaSelect = $('#id_empresa'); 
    const remisionInput = $('#id_remision_display'); // INPUT DE REMISIÓN
    const emptyFormTemplate = $('#empty-form-template').html();

    function initializeSelect2(context) {
        $(context).find('select:not([data-select2-id])').select2({
            theme: 'bootstrap-5', width: '100%', placeholder: 'Seleccione una opción', allowClear: true
        });
        $(context).find('input[type="checkbox"][name$="-DELETE"]').hide(); 
    }
    
    function populateSelect(selectElement, options) {
        const currentVal = $(selectElement).val();
        $(selectElement).empty().append('<option value=""></option>');
        if (options) {
            options.forEach(i => $(selectElement).append(new Option(i.nombre || i.placas, i.id)));
        }
        $(selectElement).val(currentVal).trigger('change');
    }

    initializeSelect2(document);

    // --- PREVISUALIZACIÓN DE ARCHIVO NUEVO ---
    $('#id_evidencia_documento').change(function(){
        const file = this.files[0];
        const previewContainer = $('#preview-container');
        const contentDiv = $('#preview-content');
        
        if (file){
            previewContainer.show();
            const reader = new FileReader();
            
            reader.onload = function(e) {
                currentPreviewData = e.target.result;
                contentDiv.empty();

                if (file.type === 'application/pdf') {
                    currentPreviewType = 'pdf';
                    contentDiv.html(`
                        <div class="p-3 bg-white">
                            <i class="fas fa-file-pdf fa-4x text-danger"></i>
                            <div class="mt-2 fw-bold text-dark">PDF Seleccionado</div>
                        </div>
                    `);
                } else if (file.type.startsWith('image/')) {
                    currentPreviewType = 'image';
                    contentDiv.html(`
                        <img src="${e.target.result}" style="max-height: 200px; display: block;" class="img-fluid rounded">
                    `);
                } else {
                    currentPreviewType = null;
                    contentDiv.html('<div class="p-3 text-muted">Vista previa no disponible</div>');
                }
            }
            reader.readAsDataURL(file);
        } else {
            previewContainer.hide();
            currentPreviewData = null;
        }
    });

    // --- LÓGICA DE EMPRESAS Y CATALOGOS (CONSOLIDADOS) ---
    empresaSelect.on('change', function() { 
        const empresaId = $(this).val();
        
        // Si no se selecciona empresa, se limpia y deshabilita lo necesario
        if (!empresaId) {
             addButton.prop('disabled', true);
             if (!IS_EDITING) remisionInput.val(''); 
             return;
        }
        
        // 1. Cargar Catálogos
        fetch(`/api/get-catalogos/${empresaId}/`) 
            .then(response => response.json())
            .then(data => {
                cachedCatalogData.materiales = data.materiales || [];
                populateSelect($('#id_linea_transporte'), data.lineas_transporte);
                populateSelect($('#id_unidad'), data.unidades);
                populateSelect($('#id_contenedor'), data.contenedores);
                populateSelect($('#id_origen'), data.lugares_origen);
                populateSelect($('#id_destino'), data.lugares_destino);
                
                formContainer.find('.detalle-form-row').each(function() {
                    populateSelect($(this).find('.material-select'), cachedCatalogData.materiales);
                });
            })
            .catch(error => console.error("Error catálogos:", error))
            .finally(() => { addButton.prop('disabled', false); });
            
        // 2. OBTENER FOLIO CONSECUTIVO (INTEGRACIÓN FUNCIONAL)
        if (!IS_EDITING) {
             remisionInput.val('Generando folio...');
             
             fetch(`/api/get-next-remision/${empresaId}/`)
                 .then(response => {
                     if (!response.ok) throw new Error('Error de red');
                     return response.json();
                 })
                 .then(data => {
                     // Verifica la respuesta de tu vista Django
                     if (data.next_remision) {
                         remisionInput.val(data.next_remision);
                         remisionInput.prop('readonly', true);
                     } else if (data.is_manual) {
                         remisionInput.val('');
                         remisionInput.prop('readonly', false);
                         remisionInput.attr('placeholder', 'Folio manual');
                     } else {
                         remisionInput.val('');
                     }
                 })
                 .catch(error => {
                     console.error('Error obteniendo folio:', error);
                     remisionInput.val('');
                     remisionInput.prop('readonly', false);
                 });
        }
    });

    // Trigger inicial
    if (empresaSelect.val()) { 
        empresaSelect.trigger('change');
    } else {
        addButton.prop('disabled', true);
    }
    
    // --- MANEJO DE FILAS DINÁMICAS ---
    addButton.on('click', function() { 
        const formIndex = parseInt(totalFormsInput.val());
        const newRowHtml = emptyFormTemplate.replace(/__prefix__/g, formIndex);
        const newRow = $(newRowHtml);
        formContainer.append(newRow);
        
        populateSelect(newRow.find('.material-select'), cachedCatalogData.materiales);
        initializeSelect2(newRow);
        totalFormsInput.val(formIndex + 1);
    });
    
    formContainer.on('click', '.btn-delete-row', function() { 
        $(this).closest('.detalle-form-row').find('input[type="checkbox"][name$="-DELETE"]').prop('checked', true).end().hide(); 
    });

    formContainer.on('input', '.peso-carga, .peso-descarga', function() { 
        const row = $(this).closest('.row');
        const carga = parseFloat(row.find('.peso-carga').val()) || 0;
        const descarga = parseFloat(row.find('.peso-descarga').val()) || 0;
        const diferencia = descarga - carga; 
        const labelSpan = row.find('.perdida-calculada-label');
        const valorSpan = row.find('.perdida-calculada-valor');

        valorSpan.text(diferencia.toFixed(3));
        if (diferencia >= 0) {
            labelSpan.text('GANANCIA').removeClass('text-danger').addClass('text-success');
            valorSpan.removeClass('text-danger').addClass('text-success');
        } else {
            labelSpan.text('PÉRDIDA').removeClass('text-success').addClass('text-danger');
            valorSpan.removeClass('text-success').addClass('text-danger');
        }
    });
    
    $('.detalle-form-row').each(function() {
        $(this).find('.peso-carga').trigger('input');
    });

});
</script>
{% endblock %}