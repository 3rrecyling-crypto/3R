{% extends 'ternium/base.html' %}
{% load humanize %}
{% load widget_tweaks %}

{% block title %}Factura {{ factura.numero_factura }}{% endblock %}

{% block content %}
<div class="container-fluid py-5 bg-light" style="min-height: 100vh;">
    
    <div class="row mb-4 animate__animated animate__fadeIn">
        <div class="col-12">
            <nav aria-label="breadcrumb" class="mb-3">
                <ol class="breadcrumb mb-0 small fw-bold text-uppercase text-muted ls-wide">
                    <li class="breadcrumb-item"><a href="{% url 'lista_facturas' %}" class="text-decoration-none text-secondary">Cuentas por Pagar</a></li>
                    <li class="breadcrumb-item active text-dark">{{ factura.numero_factura }}</li>
                </ol>
            </nav>
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-3 border-bottom pb-3">
                <div class="d-flex align-items-center gap-3">
                    <div class="bg-white p-2 rounded shadow-sm border">
                        <i class="fas fa-file-invoice fa-2x text-primary"></i>
                    </div>
                    <div>
                        <h2 class="fw-bold text-dark mb-0 lh-1">
                            {{ factura.numero_factura }}
                        </h2>
                        <small class="text-muted">Folio Interno: <span class="font-monospace">{{ factura.folio_cxp }}</span></small>
                    </div>
                    <div class="ms-2">
                        {% if factura.estatus == 'PAGADA' %}
                            <span class="badge bg-success-subtle text-success border border-success-subtle px-3 py-2 rounded-pill"><i class="fas fa-check-circle me-1"></i>Pagada</span>
                        {% elif factura.estatus == 'VENCIDA' %}
                            <span class="badge bg-danger-subtle text-danger border border-danger-subtle px-3 py-2 rounded-pill"><i class="fas fa-exclamation-circle me-1"></i>Vencida</span>
                        {% elif factura.estatus == 'POR_VENCER' %}
                            <span class="badge bg-warning-subtle text-warning border border-warning-subtle px-3 py-2 rounded-pill"><i class="fas fa-clock me-1"></i>Por Vencer</span>
                        {% else %}
                            <span class="badge bg-secondary-subtle text-secondary border border-secondary-subtle px-3 py-2 rounded-pill">Pendiente</span>
                        {% endif %}
                    </div>
                </div>
                
                <div class="d-flex gap-2">
                    <a href="{% url 'lista_facturas' %}" class="btn btn-white border shadow-sm px-4 fw-medium">
                        <i class="fas fa-arrow-left me-2"></i>Volver
                    </a>
                    
                    {% if not factura.pagada %}
                    <button type="button" class="btn btn-primary shadow-sm px-4 fw-bold" data-bs-toggle="modal" data-bs-target="#modalPago">
                        <i class="fas fa-wallet me-2"></i>Registrar Pago
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="card border-0 shadow-sm rounded-3 mb-4 overflow-hidden">
        <div class="card-body p-5">
            <div class="position-relative">
                <div class="progress bg-light" style="height: 4px; margin-top: 15px;">
                    <div class="progress-bar bg-primary" role="progressbar" style="width: {{ factura.porcentaje_pagado|floatformat:0 }}%;"></div>
                </div>
                
                <div class="d-flex justify-content-between position-absolute w-100 top-0 start-0" style="margin-top: -12px;">
                    <div class="text-center">
                        <div class="rounded-circle d-flex align-items-center justify-content-center mx-auto mb-2 shadow-sm border border-2 border-white
                            {% if factura.pk %}bg-primary text-white{% else %}bg-secondary text-white{% endif %}" 
                            style="width: 32px; height: 32px; z-index: 2;">
                            <i class="fas fa-file-contract x-small"></i>
                        </div>
                        <div class="d-none d-sm-block">
                            <small class="fw-bold text-dark d-block">Emisión</small>
                            <small class="text-muted x-small">{{ factura.fecha_emision|date:"d M, Y" }}</small>
                        </div>
                    </div>

                    <div class="text-center">
                        <div class="rounded-circle d-flex align-items-center justify-content-center mx-auto mb-2 shadow-sm border border-2 border-white
                            {% if factura.pagos.exists %}bg-primary text-white{% else %}bg-white border-secondary text-secondary{% endif %}" 
                            style="width: 32px; height: 32px; z-index: 2;">
                            <span class="fw-bold x-small">{{ factura.porcentaje_pagado|floatformat:0 }}%</span>
                        </div>
                        <div class="d-none d-sm-block">
                            <small class="fw-bold text-dark d-block">En Proceso</small>
                            <small class="text-muted x-small">Avance</small>
                        </div>
                    </div>

                    <div class="text-center">
                        <div class="rounded-circle d-flex align-items-center justify-content-center mx-auto mb-2 shadow-sm border border-2 border-white
                            {% if factura.pagada %}bg-success text-white{% else %}bg-white border-secondary text-secondary{% endif %}" 
                            style="width: 32px; height: 32px; z-index: 2;">
                            <i class="fas fa-check x-small"></i>
                        </div>
                        <div class="d-none d-sm-block">
                            <small class="fw-bold text-dark d-block">Liquidada</small>
                            {% if factura.pagada %}
                                <small class="text-success x-small fw-bold">Completado</small>
                            {% else %}
                                <small class="text-muted x-small">Pendiente</small>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4 mb-4">
        <div class="col-md-4">
            <div class="card border-0 shadow-sm rounded-3 h-100 border-start border-4 border-primary">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center justify-content-between mb-2">
                        <p class="text-muted text-uppercase x-small fw-bold mb-0 ls-wide">Monto Total</p>
                        <div class="bg-primary bg-opacity-10 text-primary p-2 rounded">
                            <i class="fas fa-file-invoice-dollar"></i>
                        </div>
                    </div>
                    <h3 class="fw-bold text-dark mb-0">${{ factura.monto|floatformat:2|intcomma }}</h3>
                    <small class="text-muted">{{ factura.moneda|default:"MXN" }}</small>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm rounded-3 h-100 border-start border-4 border-success">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center justify-content-between mb-2">
                        <p class="text-muted text-uppercase x-small fw-bold mb-0 ls-wide">Abonado</p>
                        <div class="bg-success bg-opacity-10 text-success p-2 rounded">
                            <i class="fas fa-wallet"></i>
                        </div>
                    </div>
                    <h3 class="fw-bold text-success mb-0">${{ factura.monto_pagado|floatformat:2|intcomma }}</h3>
                    <small class="text-success fw-medium"><i class="fas fa-arrow-up me-1"></i>{{ factura.porcentaje_pagado|floatformat:1 }}% cubierto</small>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm rounded-3 h-100 border-start border-4 border-warning">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center justify-content-between mb-2">
                        <p class="text-muted text-uppercase x-small fw-bold mb-0 ls-wide">Por Pagar</p>
                        <div class="bg-warning bg-opacity-10 text-warning p-2 rounded">
                            <i class="fas fa-hourglass-half"></i>
                        </div>
                    </div>
                    <h3 class="fw-bold {% if factura.monto_pendiente > 0 %}text-dark{% else %}text-muted{% endif %} mb-0">
                        ${{ factura.monto_pendiente|floatformat:2|intcomma }}
                    </h3>
                    {% if factura.dias_restantes_credito < 0 %}
                        <small class="text-danger fw-bold"><i class="fas fa-exclamation-circle me-1"></i>Vencida hace {{ factura.dias_restantes_credito|stringformat:"d"|slice:"1:" }} días</small>
                    {% else %}
                        <small class="text-muted">{{ factura.dias_restantes_credito }} días de crédito restantes</small>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm rounded-3 h-100">
                <div class="card-header bg-white border-bottom py-3 px-4">
                    <h6 class="fw-bold text-dark mb-0 text-uppercase ls-wide text-secondary" style="font-size: 0.8rem;">
                        <i class="fas fa-info-circle me-2"></i>Detalles Generales
                    </h6>
                </div>
                <div class="card-body p-0">
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item p-4 border-light">
                            <small class="text-uppercase text-muted x-small fw-bold d-block mb-1">Proveedor</small>
                            <div class="d-flex align-items-center">
                                <div class="avatar-initial rounded bg-light text-primary fw-bold me-3 border" style="width:40px; height:40px; display:flex; align-items:center; justify-content:center;">
                                    {{ factura.nombre_proveedor|slice:":1" }}
                                </div>
                                <div>
                                    <h6 class="fw-bold text-dark mb-0">{{ factura.nombre_proveedor }}</h6>
                                    <small class="text-muted">RFC: {{ factura.proveedor.rfc|default:"--" }}</small>
                                </div>
                            </div>
                        </li>
                        
                        <li class="list-group-item p-4 border-light">
                            <div class="row g-3">
                                <div class="col-6">
                                    <small class="text-uppercase text-muted x-small fw-bold d-block mb-1">Emisión</small>
                                    <span class="text-dark fw-medium"><i class="far fa-calendar me-2 text-muted"></i>{{ factura.fecha_emision|date:"d M, Y" }}</span>
                                </div>
                                <div class="col-6">
                                    <small class="text-uppercase text-muted x-small fw-bold d-block mb-1">Vencimiento</small>
                                    <span class="text-dark fw-medium"><i class="far fa-calendar-check me-2 text-muted"></i>{{ factura.fecha_vencimiento|date:"d M, Y" }}</span>
                                </div>
                            </div>
                        </li>

                        {% if factura.orden_compra %}
                        <li class="list-group-item p-4 border-light bg-light bg-opacity-25">
                            <small class="text-uppercase text-muted x-small fw-bold d-block mb-2">Orden de Compra Vinculada</small>
                            <div class="d-flex justify-content-between align-items-center bg-white border rounded p-3 shadow-sm">
                                <div>
                                    <span class="fw-bold text-primary">{{ factura.orden_compra.folio }}</span>
                                    <div class="small text-muted">{{ factura.orden_compra.empresa.nombre }}</div>
                                </div>
                                <a href="{% url 'detalle_orden_compra' factura.orden_compra.pk %}" class="btn btn-sm btn-light border" data-bs-toggle="tooltip" title="Ver OC">
                                    <i class="fas fa-external-link-alt text-secondary"></i>
                                </a>
                            </div>
                        </li>
                        {% endif %}

                        {% if factura.archivo_factura %}
                        <li class="list-group-item p-4 border-light">
                            <a href="{{ factura.archivo_factura.url }}" target="_blank" class="btn btn-outline-danger w-100 border-2 fw-medium">
                                <i class="fas fa-file-pdf me-2"></i>Ver PDF Factura
                            </a>
                        </li>
                        {% endif %}
                    </ul>
                </div>
            </div>
        </div>

        <div class="col-lg-8">
            
            <div class="card border-0 shadow-sm rounded-3 mb-4">
                <div class="card-header bg-white border-bottom py-3 px-4 d-flex justify-content-between align-items-center">
                    <h6 class="fw-bold text-dark mb-0 text-uppercase ls-wide text-secondary" style="font-size: 0.8rem;">
                        <i class="fas fa-chart-pie me-2"></i>Estado de Cuenta (Plazos)
                    </h6>
                    <span class="badge bg-light text-dark border">{{ factura.cantidad_plazos }} Plazo(s)</span>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0" style="font-size: 0.9rem;">
                        <thead class="bg-light text-secondary text-uppercase x-small">
                            <tr>
                                <th class="ps-4 border-0">#</th>
                                <th class="border-0">Vencimiento</th>
                                <th class="text-end border-0">Cuota</th>
                                <th class="text-end border-0 text-success">Cubierto</th>
                                <th class="text-end border-0 text-danger">Saldo</th>
                                <th class="text-center border-0 pe-4">Estado</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for plazo in factura.plazos_programados %}
                            <tr class="{% if plazo.estado == 'PAGADO' %}bg-success-subtle bg-opacity-10{% endif %}">
                                <td class="ps-4 fw-bold text-muted">{{ plazo.numero_plazo }}</td>
                                <td>
                                    {{ plazo.fecha_programada|date:"d/m/Y" }}
                                    {% if plazo.esta_vencido %}
                                        <i class="fas fa-exclamation-circle text-danger ms-1" data-bs-toggle="tooltip" title="Vencido"></i>
                                    {% endif %}
                                </td>
                                <td class="text-end font-monospace text-muted">${{ plazo.monto_programado|floatformat:2|intcomma }}</td>
                                
                                <td class="text-end fw-bold text-success font-monospace">
                                    ${{ plazo.monto_cubierto|floatformat:2|intcomma }}
                                </td>
                                <td class="text-end fw-bold {% if plazo.saldo_pendiente > 0 %}text-danger{% else %}text-muted{% endif %} font-monospace">
                                    ${{ plazo.saldo_pendiente|floatformat:2|intcomma }}
                                </td>
                                <td class="text-center pe-4">
                                    {% if plazo.estado == 'PAGADO' %}
                                        <span class="badge bg-success text-white rounded-pill px-3 shadow-sm"><i class="fas fa-check me-1"></i>Cubierto</span>
                                    {% elif plazo.estado == 'PARCIAL' %}
                                        <span class="badge bg-warning text-dark border border-warning rounded-pill px-3">Parcial</span>
                                    {% else %}
                                        <span class="badge bg-light text-secondary border rounded-pill px-3">Pendiente</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card border-0 shadow-sm rounded-3">
                <div class="card-header bg-white border-bottom py-3 px-4 d-flex justify-content-between align-items-center">
                    <h6 class="fw-bold text-dark mb-0 text-uppercase ls-wide text-secondary" style="font-size: 0.8rem;">
                        <i class="fas fa-history me-2"></i>Historial de Pagos
                    </h6>
                    <span class="badge bg-primary-subtle text-primary border border-primary-subtle">{{ factura.pagos.count }} Movimientos</span>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="bg-light text-secondary text-uppercase x-small">
                                <tr>
                                    <th class="ps-4 border-0">Fecha</th>
                                    <th class="border-0">Método / Referencia</th>
                                    <th class="text-end border-0">Monto</th>
                                    <th class="text-end border-0 pe-4">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for pago in factura.pagos.all %}
                                <tr>
                                    <td class="ps-4 text-dark fw-medium">{{ pago.fecha_pago|date:"d M, Y" }}</td>
                                    <td>
                                        <div class="d-flex flex-column">
                                            <span class="fw-bold text-dark x-small text-uppercase">{{ pago.get_metodo_pago_display }}</span>
                                            <span class="text-muted x-small text-truncate" style="max-width: 150px;">{{ pago.referencia|default:"Sin referencia" }}</span>
                                        </div>
                                    </td>
                                    <td class="text-end fw-bold text-dark font-monospace fs-6">
                                        ${{ pago.monto_pagado|floatformat:2|intcomma }}
                                    </td>
                                    <td class="text-end pe-4">
                                        <div class="btn-group">
                                            {% if pago.archivo_comprobante %}
                                            <a href="{{ pago.archivo_comprobante.url }}" target="_blank" class="btn btn-sm btn-white border text-secondary" title="Ver Comprobante">
                                                <i class="fas fa-paperclip"></i>
                                            </a>
                                            {% endif %}
                                            
                                            <button type="button" 
                                                onclick="verDetallePago(
                                                    '{{ forloop.counter }}', 
                                                    '{{ pago.monto_pagado }}',
                                                    '{{ pago.fecha_pago|date:'Y-m-d' }}',
                                                    '{{ pago.get_metodo_pago_display }}',
                                                    '{{ pago.referencia|default:'-' }}',
                                                    '{{ pago.notas|default:''|escapejs }}',
                                                    '{% if pago.archivo_comprobante %}{{ pago.archivo_comprobante.url }}{% endif %}',
                                                    '{{ pago.registrado_por.username|default:'Sistema' }}',
                                                    '{{ pago.creado_en|date:'d/m/Y H:i' }}'
                                                )"
                                                class="btn btn-sm btn-white border text-primary" title="Ver Detalle">
                                                <i class="fas fa-eye"></i>
                                            </button>

                                            <a href="{% url 'editar_pago' pago.pk %}" class="btn btn-sm btn-white border text-info" title="Editar">
                                                <i class="fas fa-pencil-alt"></i>
                                            </a>

                                            <a href="{% url 'eliminar_pago' pago.pk %}" class="btn btn-sm btn-white border text-danger" title="Eliminar">
                                                <i class="fas fa-trash-alt"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="4" class="text-center py-5 text-muted">
                                        <div class="opacity-50 mb-2"><i class="fas fa-receipt fa-3x"></i></div>
                                        <p class="mb-0">No se han registrado pagos todavía.</p>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<div class="modal fade" id="modalPago" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header border-0 bg-primary text-white px-4 py-3 rounded-top-4">
                <h6 class="modal-title fw-bold text-uppercase ls-wide">
                    <i class="fas fa-wallet me-2"></i>Registrar Nuevo Pago
                </h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            
            <form method="post" action="{% url 'gestionar_plazos_factura' factura.pk %}" enctype="multipart/form-data" id="formPago">
                {% csrf_token %}
                <div class="modal-body p-4 bg-white">
                    
                    <div class="alert alert-primary border-0 d-flex align-items-center small mb-4 bg-opacity-10 text-primary">
                        <i class="fas fa-info-circle me-3 fs-5"></i>
                        <div>
                            <span class="d-block text-uppercase x-small fw-bold">Saldo Pendiente Actual</span>
                            <strong class="fs-5" id="labelSaldoPendiente">${{ factura.monto_pendiente|floatformat:2|intcomma }}</strong>
                        </div>
                    </div>

                    <div class="row g-3">
                        <div class="col-12">
                            <label class="form-label small text-muted fw-bold text-uppercase x-small">Monto a Pagar</label>
                            <div class="input-group has-validation">
                                <span class="input-group-text bg-white border-end-0 text-muted">$</span>
                                {% render_field form_pago.monto_pagado class="form-control form-control-lg bg-white border-start-0 fw-bold text-dark" placeholder="0.00" id="inputMontoPago" data-pendiente=factura.monto_pendiente %}
                                <div class="invalid-feedback" id="errorMontoMsg">
                                    El monto no puede exceder el saldo pendiente.
                                </div>
                            </div>
                        </div>

                        <div class="col-6">
                            <label class="form-label small text-muted fw-bold text-uppercase x-small">Fecha</label>
                            {% render_field form_pago.fecha_pago class="form-control" %}
                        </div>
                        <div class="col-6">
                            <label class="form-label small text-muted fw-bold text-uppercase x-small">Método</label>
                            {% render_field form_pago.metodo_pago class="form-select" %}
                        </div>

                        <div class="col-12">
                            <label class="form-label small text-muted fw-bold text-uppercase x-small">Referencia / Folio</label>
                            {% render_field form_pago.referencia class="form-control" placeholder="Ej: Transferencia #12345" %}
                        </div>

                        <div class="col-12">
                            <label class="form-label small text-muted fw-bold text-uppercase x-small">Comprobante (Opcional)</label>
                            {% render_field form_pago.archivo_comprobante class="form-control" %}
                        </div>
                        
                        <div class="col-12">
                            <label class="form-label small text-muted fw-bold text-uppercase x-small">Notas</label>
                            {% render_field form_pago.notas class="form-control" rows="2" placeholder="Comentarios adicionales..." %}
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0 p-3 pt-0 bg-white">
                    <button type="button" class="btn btn-light rounded-pill px-4 fw-medium" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary rounded-pill px-4 fw-bold shadow-sm" id="btnGuardarPago">
                        Confirmar Pago
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="modalVerPago" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header border-0 bg-dark text-white px-4 py-3 rounded-top-4">
                <h6 class="modal-title fw-bold text-uppercase ls-wide">
                    <i class="fas fa-receipt me-2"></i>Detalle de Transacción
                </h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4 bg-white">
                <div class="text-center mb-4">
                    <h2 class="text-success fw-bold mb-0" id="ver_monto"></h2>
                    <span class="badge bg-success-subtle text-success border border-success-subtle rounded-pill mt-2">Pago Exitoso</span>
                </div>

                <ul class="list-group list-group-flush small">
                    <li class="list-group-item d-flex justify-content-between px-0">
                        <span class="text-muted">Fecha Pago:</span>
                        <span class="fw-bold text-dark" id="ver_fecha"></span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between px-0">
                        <span class="text-muted">Método:</span>
                        <span class="fw-bold text-dark" id="ver_metodo"></span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between px-0">
                        <span class="text-muted">Referencia:</span>
                        <span class="fw-bold text-dark font-monospace" id="ver_referencia"></span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between px-0">
                        <span class="text-muted">Registrado por:</span>
                        <span class="fw-bold text-dark" id="ver_usuario"></span>
                    </li>
                </ul>

                <div class="mt-3">
                    <label class="form-label x-small fw-bold text-uppercase text-muted">Notas</label>
                    <div class="bg-light p-3 rounded text-muted fst-italic" id="ver_notas_div"></div>
                </div>

                <div class="col-12 mt-4" id="div_archivo_descarga" style="display: none;">
                    <a href="#" id="link_archivo" target="_blank" class="btn btn-outline-primary w-100 border-2 fw-medium">
                        <i class="fas fa-download me-2"></i>Descargar Comprobante
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_css %}
<style>
    /* Estilos Corporativos Personalizados */
    .x-small { font-size: 0.7rem; }
    .ls-wide { letter-spacing: 0.05em; }
    
    .btn-white {
        background-color: #fff;
        border: 1px solid #e2e8f0;
        color: #4a5568;
        transition: all 0.2s;
    }
    .btn-white:hover {
        background-color: #f7fafc;
        border-color: #cbd5e0;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .form-control:focus, .form-select:focus {
        border-color: #4e73df;
        box-shadow: 0 0 0 0.2rem rgba(78, 115, 223, 0.15);
    }

    /* Modal Backdrop Fix */
    .modal-backdrop { z-index: 1040 !important; }
    .modal { z-index: 1050 !important; }
</style>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 1. Mover modales al body para evitar problemas de z-index
        var modalPago = document.getElementById('modalPago');
        var modalVer = document.getElementById('modalVerPago');
        if(modalPago) document.body.appendChild(modalPago);
        if(modalVer) document.body.appendChild(modalVer);
        
        // 2. Inicializar Tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        });

        // 3. VALIDACIÓN EN TIEMPO REAL DEL MONTO
        const inputMonto = document.getElementById('inputMontoPago');
        const btnGuardar = document.getElementById('btnGuardarPago');
        const errorMsg = document.getElementById('errorMontoMsg');

        if (inputMonto && btnGuardar) {
            // Obtenemos el saldo pendiente del atributo data (convertimos la coma decimal si existe)
            let maxMontoStr = inputMonto.dataset.pendiente; 
            // En Django a veces los decimales vienen con coma, aseguramos punto para JS
            let maxMonto = parseFloat(maxMontoStr.replace(',', '.')); 

            inputMonto.addEventListener('input', function() {
                let valorActual = parseFloat(this.value);
                
                if (isNaN(valorActual)) {
                    // Si está vacío o no es número, limpiamos estados
                    this.classList.remove('is-invalid');
                    btnGuardar.disabled = false;
                    return;
                }

                // Agregamos una pequeña tolerancia de 0.10 por redondeos
                if (valorActual > (maxMonto + 0.10)) {
                    // ERROR: Se pasó del monto
                    this.classList.add('is-invalid');
                    btnGuardar.disabled = true;
                    errorMsg.style.display = 'block';
                } else if (valorActual <= 0) {
                    // ERROR: Negativo o cero
                    this.classList.add('is-invalid');
                    btnGuardar.disabled = true;
                    errorMsg.textContent = "El monto debe ser mayor a 0.";
                } else {
                    // OK
                    this.classList.remove('is-invalid');
                    btnGuardar.disabled = false;
                    errorMsg.style.display = 'none';
                }
            });
        }
    });

    // Función para el modal de VER DETALLE
    function verDetallePago(indice, monto, fecha, metodo, referencia, notas, urlArchivo, usuario, creado) {
        // Formateo de moneda para visualización
        const montoFormateado = new Intl.NumberFormat('es-MX', {
            style: 'currency',
            currency: 'MXN'
        }).format(monto);

        document.getElementById('ver_monto').textContent = montoFormateado;
        document.getElementById('ver_fecha').textContent = fecha;
        document.getElementById('ver_metodo').textContent = metodo;
        document.getElementById('ver_referencia').textContent = referencia;
        document.getElementById('ver_usuario').textContent = usuario;
        
        var notasDiv = document.getElementById('ver_notas_div');
        notasDiv.textContent = notas ? notas : "Sin notas adicionales.";

        var divArchivo = document.getElementById('div_archivo_descarga');
        var linkArchivo = document.getElementById('link_archivo');

        if (urlArchivo && urlArchivo !== '') {
            divArchivo.style.display = 'block';
            linkArchivo.href = urlArchivo;
        } else {
            divArchivo.style.display = 'none';
        }

        var myModal = new bootstrap.Modal(document.getElementById('modalVerPago'));
        myModal.show();
    }
</script>
{% endblock %}