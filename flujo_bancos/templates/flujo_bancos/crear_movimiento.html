{% extends 'ternium/base.html' %}
{% load static humanize %}

{% block extra_css %}
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
    
    <style>
        .select2-container--bootstrap-5 .select2-selection {
            min-height: 38px;
            border-radius: 0.375rem;
        }
        #seccion-impuestos-contenedor {
            transition: all 0.3s ease;
        }
        .sticky-card {
            position: sticky;
            top: 20px;
            z-index: 100;
        }
        .loading-text {
            font-size: 0.8rem;
            color: #6c757d;
            font-style: italic;
        }
        .saldo-editable {
            cursor: pointer;
            border-bottom: 1px dashed #ccc;
            transition: color 0.3s ease;
        }
        .saldo-editable:hover {
            color: #0d6efd;
            border-bottom-color: #0d6efd;
        }
        .modal-backdrop { z-index: 1040 !important; }
        .modal-content { z-index: 1100 !important; }
        .modal { z-index: 1050 !important; }
        
        /* Estilos para las tarjetas de saldo */
        .card-saldo-antes {
            background-color: #f8f9fa;
            border-left: 4px solid #6c757d;
        }
        .card-saldo-despues {
            background-color: #e8f5e9;
            border-left: 4px solid #198754; /* Verde éxito */
        }
        .card-saldo-despues.negativo {
            background-color: #f8d7da;
            border-left: 4px solid #dc3545; /* Rojo peligro */
        }
    </style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-md-3 mb-4">
            <div class="card shadow border-0 sticky-card">
                <div class="card-header bg-dark text-white text-center py-3">
                    <h5 class="mb-0 fw-bold"><i class="fas fa-wallet me-2"></i>Resumen de Saldo</h5>
                </div>
                <div class="card-body">
                    
                    <div class="p-3 mb-3 rounded card-saldo-antes">
                        <small class="text-muted text-uppercase fw-bold d-block mb-1" style="font-size: 0.7rem;">
                            Saldo Antes de Realizar la Operación
                        </small>
                        <h4 id="display-saldo-antes" 
                            class="fw-bold text-secondary mb-0 saldo-editable"
                            title="Clic para corregir saldo base"
                            onclick="abrirModalSaldo()">
                            $0.00
                        </h4>
                        <div id="saldo-loader" class="loading-text d-none">Consultando...</div>
                    </div>

                    <h6 class="text-primary fw-bold mb-3 mt-4">
                        <i class="fas fa-calculator me-2"></i>Desglose
                    </h6>
                    <ul class="list-group list-group-flush small mb-3">
                        <li class="list-group-item d-flex justify-content-between align-items-center px-0 bg-transparent">
                            Monto Base
                            <span id="resumen-subtotal" class="fw-bold text-dark">$0.00</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center px-0 bg-transparent">
                            (+) IVA
                            <span id="resumen-iva" class="text-danger fw-bold">$0.00</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center px-0 bg-transparent">
                            (-) Retenciones
                            <span id="resumen-ret" class="text-success fw-bold">$0.00</span>
                        </li>
                    </ul>

                    <div id="card-saldo-final" class="p-3 rounded card-saldo-despues">
                        <small class="text-muted text-uppercase fw-bold d-block mb-1" style="font-size: 0.7rem;">
                            Saldo Después de Realizar la Operación
                        </small>
                        <h3 id="display-saldo-despues" class="fw-bold text-success mb-0">
                            $0.00
                        </h3>
                    </div>

                </div>
            </div>
        </div>

        <div class="col-md-9">
            <div class="card shadow-lg border-0">
                <div class="card-header bg-primary text-white py-3 d-flex justify-content-between align-items-center">
                    <h4 class="mb-0 fw-bold">
                        <i class="fas {% if movimiento %}fa-edit{% else %}fa-plus-circle{% endif %} me-2"></i>
                        {% if movimiento %}Editar Movimiento{% else %}Nuevo Movimiento Bancario{% endif %}
                    </h4>
                    <span id="icono-operacion" class="badge bg-white text-primary fs-6 p-2 shadow-sm">Operación</span>
                </div>
                
                <div class="card-body p-4">
                    <form method="post" id="movimientoForm" novalidate enctype="multipart/form-data">
                        {% csrf_token %}
                        
                        <div class="row g-3 mb-4">
                            <div class="col-md-2">
                                <label class="form-label fw-bold"><i class="fas fa-calendar-alt me-1 text-primary"></i>Fecha</label>
                                {{ form.fecha }}
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-bold"><i class="fas fa-university me-1 text-primary"></i>Cuenta Origen</label>
                                {{ form.cuenta }}
                            </div>
                            <div class="col-md-2">
                                <label class="form-label fw-bold"><i class="fas fa-filter me-1 text-primary"></i>Tipo</label>
                                {{ form.tipo_movimiento }}
                            </div>
                            <div class="col-md-5">
                                <label class="form-label fw-bold">Concepto / Referencia</label>
                                {{ form.concepto }}
                                <datalist id="lista-conceptos">
                                    {% for c in lista_conceptos %}<option value="{{ c }}">{% endfor %}
                                </datalist>
                            </div>
                        </div>

                        <div class="row g-3 mb-4">
                            <div class="col-md-4">
                                <label class="form-label small fw-bold text-muted">Unidad de Negocio</label>
                                {{ form.unidad_negocio }}
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-bold text-primary">Operación</label>
                                {{ form.operacion }}
                            </div>
                            <div class="col-md-4">
                                <label class="form-label small fw-bold text-muted">Categoría</label>
                                {{ form.categoria }}
                            </div>
                        </div>

                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label class="form-label small fw-bold text-muted">Subcategoría</label>
                                {{ form.subcategoria }}
                            </div>

                            <div class="col-md-6">
                                <div id="div_tercero">
                                    <label class="form-label fw-bold" id="label-tercero">Recibido de / Pagado a</label>
                                    <div class="input-group shadow-sm">
                                        {{ form.tercero_obj }} 
                                        <button type="button" onclick="abrirTerceroPopup('{% url 'crear_tercero' %}')" class="btn btn-primary" title="Agregar nuevo">
                                            <i class="fas fa-user-plus"></i>
                                        </button>
                                    </div>
                                </div>

                                <div id="div_cuenta_destino" class="d-none">
                                    <label class="form-label fw-bold text-success">Cuenta Destino (Transferencia MXN)</label>
                                    {{ form.cuenta_destino_transfer }}
                                </div>
                            </div>
                        </div>

                        <div class="card bg-light border-0 mb-4 shadow-sm">
                            <div class="card-body">
                                <div class="row g-3 align-items-end">
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold text-dark">Subtotal (Importe Base)</label>
                                        <div class="input-group">
                                            <span class="input-group-text bg-white border-end-0"><i class="fas fa-dollar-sign text-success"></i></span>
                                            {{ form.monto_total }}
                                        </div>
                                    </div>
                                    <div class="col-md-8" id="seccion-impuestos-contenedor">
                                        <div class="row g-2">
                                            <div class="col-4">
                                                <label class="form-label small text-muted">IVA</label>
                                                {{ form.iva }}
                                            </div>
                                            <div class="col-4">
                                                <label class="form-label small text-muted">Ret. IVA</label>
                                                {{ form.ret_iva }}
                                            </div>
                                            <div class="col-4">
                                                <label class="form-label small text-muted">Ret. ISR</label>
                                                {{ form.ret_isr }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row g-3 mb-4">
                            <div class="col-md-7">
                                <label class="form-label text-muted fw-bold">Observaciones Adicionales</label>
                                {{ form.comentarios }}
                            </div>
                            <div class="col-md-5">
                                <label class="form-label fw-bold text-primary"><i class="fas fa-file-invoice me-1"></i>Adjuntar Comprobante</label>
                                <div class="bg-white p-2 border rounded shadow-sm">
                                    {{ form.comprobante }}
                                </div>
                                {% if movimiento.comprobante %}
                                    <div class="mt-1 small">
                                        <a href="{{ movimiento.comprobante.url }}" target="_blank">Ver actual</a>
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="d-flex justify-content-end gap-3 pt-3 border-top">
                            <a href="{% url 'lista_movimientos' %}" class="btn btn-light border px-4">Cancelar</a>
                            <button type="submit" class="btn btn-success px-5 fw-bold shadow">
                                <i class="fas fa-cloud-upload-alt me-2"></i>
                                {% if movimiento %}Actualizar Movimiento{% else %}Finalizar y Guardar{% endif %}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalSaldo" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content shadow-lg">
            <div class="modal-header bg-dark text-white py-2">
                <h6 class="modal-title">Corrección de Saldo</h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="" id="formSaldo">
                {% csrf_token %}
                <div class="modal-body">
                    <label class="form-label small fw-bold text-muted">Nuevo Saldo Inicial</label>
                    <div class="input-group">
                        <span class="input-group-text">$</span>
                        <input type="number" step="0.01" name="saldo_inicial" id="inputSaldo" class="form-control fw-bold" required>
                    </div>
                    <div class="form-text small mt-2">
                        Esto ajustará el cálculo del saldo total actual.
                    </div>
                </div>
                <div class="modal-footer py-1 border-0">
                    <button type="submit" class="btn btn-sm btn-dark w-100">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
    // --- VARIABLES DE ESTADO ---
    let currentCuentaId = null;
    let currentSaldoInicial = 0; // Para el modal de edición
    let saldoBaseCuenta = 0;     // ESTE ES EL "SALDO ANTES"

    // --- DATOS INYECTADOS DESDE DJANGO (Para edición histórica correcta) ---
    {% if movimiento %}
        const esEdicion = true;
        // Recuperamos los valores crudos de la BD para ingeniería inversa
        const saldoFinalGuardado = parseFloat("{{ movimiento.saldo_banco|default:0 }}");
        const abonoGuardado = parseFloat("{{ movimiento.abono|default:0 }}");
        const cargoGuardado = parseFloat("{{ movimiento.cargo|default:0 }}");
        
        // CÁLCULO DEL "SALDO ANTES" HISTÓRICO:
        // SaldoAntes = SaldoFinal - Abono + Cargo
        saldoBaseCuenta = saldoFinalGuardado - abonoGuardado + cargoGuardado;
    {% else %}
        const esEdicion = false;
        // Si es nuevo, saldoBaseCuenta se llenará con AJAX fetchSaldo()
    {% endif %}

    const fmt = new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' });

    function abrirTerceroPopup(url) {
        const w = 600; const h = 700;
        const left = (window.screen.width / 2) - (w / 2);
        const top = (window.screen.height / 2) - (h / 2);
        window.open(url, "CrearTercero", `width=${w},height=${h},top=${top},left=${left},scrollbars=yes`);
    }

    function abrirModalSaldo() {
        if (!currentCuentaId) {
            alert("Primero selecciona una cuenta.");
            return;
        }
        document.getElementById('inputSaldo').value = currentSaldoInicial;
        document.getElementById('formSaldo').action = "/bancos/cuenta/editar/" + currentCuentaId + "/"; 
        var myModal = new bootstrap.Modal(document.getElementById('modalSaldo'));
        myModal.show();
    }

    $(document).ready(function() {
        var modals = document.querySelectorAll('.modal');
        modals.forEach(modal => document.body.appendChild(modal));

        const $cuentaSelect = $('#id_cuenta');
        const $operacionSelect = $('#id_operacion');
        const $tipoSelect = $('#id_tipo_movimiento');
        const $terceroSelect = $('#id_tercero_obj');
        const $categoriaSelect = $('#id_categoria');
        const $subcategoriaSelect = $('#id_subcategoria');
        const $destinoSelect = $('#id_cuenta_destino_transfer');

        const divTercero = document.getElementById('div_tercero');
        const divDestino = document.getElementById('div_cuenta_destino');
        
        const inputSubtotal = document.getElementById('id_monto_total');
        const inputIva = document.getElementById('id_iva');
        const inputRetIva = document.getElementById('id_ret_iva');
        const inputRetIsr = document.getElementById('id_ret_isr');
        const seccionImpuestos = document.getElementById('seccion-impuestos-contenedor');
        
        // ELEMENTOS DE VISUALIZACIÓN
        const displaySaldoAntes = document.getElementById('display-saldo-antes');
        const displaySaldoDespues = document.getElementById('display-saldo-despues');
        const cardSaldoDespues = document.getElementById('card-saldo-final');
        
        const resumenSubtotal = document.getElementById('resumen-subtotal');
        const resumenIva = document.getElementById('resumen-iva');
        const resumenRet = document.getElementById('resumen-ret');
        const iconoOperacion = document.getElementById('icono-operacion');
        const labelTercero = document.getElementById('label-tercero');
        const loader = document.getElementById('saldo-loader');

        function checkOperacion() {
            const data = $operacionSelect.select2('data')[0];
            const text = data ? data.text.toUpperCase() : "";
            
            if (text.includes('BANCO') || text.includes('DIVISA') || text.includes('VENTA')) {
                divTercero.classList.add('d-none');
                divDestino.classList.remove('d-none');
                $destinoSelect.prop('required', true);
            } else {
                divDestino.classList.add('d-none');
                divTercero.classList.remove('d-none');
                $destinoSelect.prop('required', false);
                $destinoSelect.val(null).trigger('change');
            }
        }

        function actualizarCalculos() {
            // Obtenemos valores del formulario
            const subtotal = parseFloat(inputSubtotal.value) || 0;
            let iva = parseFloat(inputIva.value) || 0;
            const retIva = parseFloat(inputRetIva.value) || 0;
            const retIsr = parseFloat(inputRetIsr.value) || 0;
            const tipo = $tipoSelect.val();
            
            let totalOperacion = 0;
            let saldoFinal = saldoBaseCuenta; // Empezamos desde el saldo "ANTES"

            // Lógica de Ingreso/Egreso
            if (tipo === 'ingreso') {
                seccionImpuestos.style.opacity = '0.5';
                seccionImpuestos.style.pointerEvents = 'none';
                iva = 0; 
                inputIva.value = 0;
                
                totalOperacion = subtotal; // Ingreso suele ser directo sin impuestos desglosados aquí
                saldoFinal += totalOperacion;

                iconoOperacion.innerHTML = '<i class="fas fa-arrow-circle-up me-1"></i>INGRESO';
                iconoOperacion.className = "badge bg-white text-success fs-6 p-2 shadow-sm border border-success";
                labelTercero.innerHTML = '<i class="fas fa-user-tie me-1"></i>Recibido de (Cliente)';
            } else {
                seccionImpuestos.style.opacity = '1';
                seccionImpuestos.style.pointerEvents = 'auto';
                
                totalOperacion = subtotal + iva - (retIva + retIsr);
                saldoFinal -= totalOperacion;

                iconoOperacion.innerHTML = '<i class="fas fa-arrow-circle-down me-1"></i>EGRESO';
                iconoOperacion.className = "badge bg-white text-danger fs-6 p-2 shadow-sm border border-danger";
                labelTercero.innerHTML = '<i class="fas fa-truck-loading me-1"></i>Pagado a (Proveedor)';
            }

            // --- ACTUALIZAR PANTALLA ---
            
            // 1. Mostrar Saldo ANTES
            displaySaldoAntes.textContent = fmt.format(saldoBaseCuenta);

            // 2. Mostrar Desgloses
            resumenSubtotal.textContent = fmt.format(subtotal);
            resumenIva.textContent = fmt.format(iva);
            resumenRet.textContent = fmt.format(retIva + retIsr);

            // 3. Mostrar Saldo DESPUÉS
            displaySaldoDespues.textContent = fmt.format(saldoFinal);

            // Estilos condicionales para el saldo final
            if (saldoFinal < 0) {
                displaySaldoDespues.classList.remove('text-success');
                displaySaldoDespues.classList.add('text-danger');
                cardSaldoDespues.classList.add('negativo');
                cardSaldoDespues.classList.remove('card-saldo-despues'); // Quitamos borde verde
            } else {
                displaySaldoDespues.classList.remove('text-danger');
                displaySaldoDespues.classList.add('text-success');
                cardSaldoDespues.classList.remove('negativo');
                cardSaldoDespues.classList.add('card-saldo-despues'); // Ponemos borde verde
            }
        }

        function fetchSaldo() {
            // Si estamos editando y NO hemos cambiado la cuenta, NO sobreescribimos el saldo histórico
            // con el saldo actual del banco.
            const cuentaId = $cuentaSelect.val();
            currentCuentaId = cuentaId;

            // Si es edición y es la misma cuenta original, usamos el cálculo histórico ya hecho arriba
            if (esEdicion && cuentaId == "{{ form.cuenta.value|default:'' }}") {
                actualizarCalculos();
                return;
            }

            // Si cambiamos de cuenta o es nuevo, traemos el saldo ACTUAL fresco
            if (!cuentaId) {
                saldoBaseCuenta = 0;
                currentSaldoInicial = 0;
                actualizarCalculos();
                return;
            }

            loader.classList.remove('d-none');
            $.getJSON("{% url 'ajax_saldo_cuenta' %}", { cuenta_id: cuentaId }, function(data) {
                saldoBaseCuenta = parseFloat(data.saldo) || 0;
                currentSaldoInicial = parseFloat(data.saldo_inicial) || 0; 
                loader.classList.add('d-none');
                actualizarCalculos();
            });
        }

        $categoriaSelect.change(function() {
            const categoriaId = $(this).val();
            if (!categoriaId) {
                $subcategoriaSelect.html('<option value="">---------</option>');
                return;
            }
            $.getJSON("{% url 'ajax_load_subcategories' %}", { categoria_id: categoriaId }, function(data) {
                let options = '<option value="">Seleccione...</option>';
                data.forEach(item => {
                    options += `<option value="${item.id}">${item.nombre}</option>`;
                });
                $subcategoriaSelect.html(options);
            });
        });

        // Eventos
        $cuentaSelect.select2({ theme: 'bootstrap-5', width: '100%' }).on('change', fetchSaldo);
        $operacionSelect.select2({ theme: 'bootstrap-5', width: '100%' }).on('change', checkOperacion);
        $terceroSelect.select2({ theme: 'bootstrap-5', width: '100%' });
        $categoriaSelect.select2({ theme: 'bootstrap-5', width: '100%' });
        $subcategoriaSelect.select2({ theme: 'bootstrap-5', width: '100%' });
        $destinoSelect.select2({ theme: 'bootstrap-5', width: '100%' });
        
        $tipoSelect.on('change', actualizarCalculos);
        [inputSubtotal, inputIva, inputRetIva, inputRetIsr].forEach(el => {
            el.addEventListener('input', actualizarCalculos);
        });

        // Inicialización
        if ($cuentaSelect.val()) {
            // Si es nuevo, fetchSaldo traerá el dato. Si es edición, fetchSaldo respetará el histórico.
            fetchSaldo(); 
        }
        checkOperacion();
        actualizarCalculos();
    });
</script>
{% endblock %}