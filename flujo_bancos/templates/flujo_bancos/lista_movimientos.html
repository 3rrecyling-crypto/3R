{% extends 'ternium/base.html' %}
{% load humanize %} 

{% block extra_css %}
<style>
    :root {
        --table-header-bg: linear-gradient(135deg, #1a73e8 0%, #0d62d1 100%);
        --primary-color: #0d6efd;
    }

    /* Ajustes generales de tarjeta y página */
    .page-header {
        background: white;
        border-radius: 12px;
        padding: 1.5rem 2rem;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        margin-bottom: 1.5rem;
        border-left: 4px solid var(--primary-color);
    }

    .filter-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        margin-bottom: 1.5rem;
        border-top: 3px solid #6c757d;
    }

    /* Estilos de la tabla */
    .data-table-card {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        border: 1px solid rgba(0,0,0,0.05);
    }

    .table-responsive {
        min-height: 400px;
    }

    .table-header-gradient {
        background: var(--table-header-bg) !important;
        border: none !important;
    }

    .table th {
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.75rem; /* Fuente un poco más pequeña para que quepan las columnas */
        letter-spacing: 0.5px;
        padding: 1rem 0.5rem !important;
        border-bottom: 2px solid rgba(255,255,255,0.2) !important;
        white-space: nowrap; /* Evita que los títulos se rompan */
        vertical-align: middle;
    }

    .table td {
        padding: 0.75rem 0.5rem !important;
        vertical-align: middle;
        border-bottom: 1px solid rgba(0,0,0,0.03) !important;
        font-size: 0.85rem;
    }

    .table tbody tr {
        transition: all 0.2s ease;
    }

    .table tbody tr:hover {
        background-color: rgba(26, 115, 232, 0.03);
    }

    /* Badges y estilos de texto */
    .status-badge {
        padding: 0.4rem 0.8rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 4px;
    }

    .badge-pendiente {
        background-color: #fff3cd;
        color: #856404;
        border: 1px solid #ffeeba;
    }

    .badge-terminado {
        background-color: #d1e7dd;
        color: #0f5132;
        border: 1px solid #badbcc;
    }

    .amount-cell {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        font-weight: 700;
        font-size: 0.9rem;
        white-space: nowrap;
    }

    .text-small-muted {
        font-size: 0.75rem;
        color: #6c757d;
    }

    /* Botones de acción */
    .action-buttons {
        display: flex;
        gap: 4px;
        justify-content: center;
    }

    .btn-icon {
        width: 32px;
        height: 32px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 6px;
        transition: all 0.2s ease;
        padding: 0;
    }

    .btn-icon:hover {
        transform: translateY(-2px);
    }

    .audit-icon.locked { color: #28a745; }
    .audit-icon.unlocked { color: #ccc; }

    /* Estilos del Dropdown Excel */
    .excel-dropdown .dropdown-menu { border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); }
    .excel-dropdown .dropdown-item { padding: 0.75rem 1.25rem; border-radius: 6px; margin: 2px; }
    .excel-dropdown .dropdown-item:hover { background: rgba(26, 115, 232, 0.08); }
    
    /* Estilos Paginación */
    .pagination .page-link {
        color: #0d6efd;
        border-radius: 5px;
        margin: 0 2px;
        border: 1px solid #dee2e6;
    }
    .pagination .page-item.active .page-link {
        background-color: #0d6efd;
        border-color: #0d6efd;
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4 mb-5">
    
    <div class="page-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="h3 mb-2 fw-bold text-dark">Historial de Movimientos</h1>
                <p class="text-muted mb-0">Control financiero y auditoría de cuentas</p>
            </div>
            <div class="d-flex gap-2">
                <button type="button" class="btn btn-outline-dark" data-bs-toggle="modal" data-bs-target="#importarModal">
                    <i class="fas fa-file-upload me-2"></i> Importar TXT
                </button>
                
                <div class="dropdown excel-dropdown">
                    <button type="button" class="btn btn-success dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-file-excel me-2"></i> Excel
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li>
                            <a class="dropdown-item" href="{% url 'exportar_movimientos_excel' %}?{{ request.GET.urlencode }}&modo=consolidado">
                                <i class="fas fa-table me-2 text-primary"></i> Reporte Consolidado
                            </a>
                        </li>
                        <li>
                            <a class="dropdown-item" href="{% url 'exportar_movimientos_excel' %}?{{ request.GET.urlencode }}&modo=segregado">
                                <i class="fas fa-layer-group me-2 text-success"></i> Separado por Cuenta
                            </a>
                        </li>
                    </ul>
                </div>
                
                <a href="{% url 'crear_movimiento' %}" class="btn btn-primary">
                    <i class="fas fa-plus-circle me-2"></i> Nuevo
                </a>
            </div>
        </div>
    </div>

    <div class="filter-card">
        <h6 class="mb-3 fw-bold text-dark"><i class="fas fa-filter me-2"></i>Filtros de Búsqueda</h6>
        <form method="get" class="row g-3 align-items-end">
            <div class="col-lg-3 col-md-6">
                <label class="form-label small fw-bold">Buscar Concepto/Tercero</label>
                <div class="input-group input-group-sm">
                    <span class="input-group-text bg-light"><i class="fas fa-search"></i></span>
                    <input type="text" name="q" class="form-control" value="{{ request.GET.q }}" placeholder="Escribe aquí...">
                </div>
            </div>
            
            <div class="col-lg-2 col-md-3">
                <label class="form-label small fw-bold">Desde</label>
                <input type="date" name="fecha_inicio" class="form-control form-control-sm" value="{{ request.GET.fecha_inicio }}">
            </div>
            
            <div class="col-lg-2 col-md-3">
                <label class="form-label small fw-bold">Hasta</label>
                <input type="date" name="fecha_fin" class="form-control form-control-sm" value="{{ request.GET.fecha_fin }}">
            </div>

            <div class="col-lg-2 col-md-6">
                <label class="form-label small fw-bold">Estatus</label>
                <select name="estatus" class="form-select form-select-sm">
                    <option value="">-- Todos --</option>
                    <option value="PENDIENTE" {% if estatus_filtro == 'PENDIENTE' %}selected{% endif %}>Pendientes</option>
                    <option value="TERMINADO" {% if estatus_filtro == 'TERMINADO' %}selected{% endif %}>Terminados</option>
                </select>
            </div>

            <div class="col-lg-1 col-md-6">
                <label class="form-label small fw-bold">Auditado</label>
                <select name="auditado" class="form-select form-select-sm">
                    <option value="">Todos</option>
                    <option value="1" {% if request.GET.auditado == '1' %}selected{% endif %}>Sí</option>
                    <option value="0" {% if request.GET.auditado == '0' %}selected{% endif %}>No</option>
                </select>
            </div>

            <div class="col-lg-2 col-md-12 d-flex gap-2">
                <button type="submit" class="btn btn-dark btn-sm w-100"><i class="fas fa-filter"></i> Aplicar</button>
                <a href="{% url 'lista_movimientos' %}" class="btn btn-outline-secondary btn-sm w-100"><i class="fas fa-redo"></i></a>
            </div>
        </form>
    </div>

    <div class="data-table-card">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-header-gradient text-white">
                    <tr>
                        <th class="ps-3">Fecha</th>
                        <th>Concepto / Cuenta</th>
                        <th>U. Negocio / Operación</th>
                        <th>Cat / Subcat</th>
                        <th>Tercero</th>
                        <th>Comentario</th>
                        <th class="text-end">Cargo</th>
                        <th class="text-end">Abono</th>
                        <th class="text-center">Estatus</th>
                        <th class="text-center">Auditado</th>
                        <th class="text-center pe-3">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for mov in movimientos %}
                    <tr class="{% if mov.estatus == 'PENDIENTE' %}table-warning{% endif %}">
                        
                        <td class="ps-3 text-nowrap fw-bold">{{ mov.fecha|date:"d/m/Y" }}</td>
                        
                        <td style="min-width: 200px;">
                            <div class="fw-bold text-dark mb-1">{{ mov.concepto|truncatechars:80 }}</div>
                            <div class="text-small-muted"><i class="fas fa-university me-1"></i>{{ mov.cuenta.nombre }}</div>
                        </td>

                        <td>
                            {% if mov.unidad_negocio %}
                                <div class="badge bg-light text-dark border mb-1">{{ mov.unidad_negocio.nombre }}</div>
                            {% endif %}
                            {% if mov.operacion %}
                                <div class="text-small-muted"><i class="fas fa-cogs me-1"></i>{{ mov.operacion.nombre }}</div>
                            {% endif %}
                        </td>

                        <td>
                            {% if mov.categoria %}
                                <div class="fw-bold text-secondary" style="font-size: 0.8rem;">{{ mov.categoria.nombre }}</div>
                            {% endif %}
                            {% if mov.subcategoria %}
                                <div class="text-small-muted">&rdsh; {{ mov.subcategoria.nombre }}</div>
                            {% else %}
                                <span class="text-muted fst-italic" style="font-size: 0.75rem;">--</span>
                            {% endif %}
                        </td>

                        <td>
                            {% if mov.tercero %}
                                <span class="text-dark"><i class="fas fa-user-tag me-1 text-secondary"></i>{{ mov.tercero }}</span>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>

                        <td style="max-width: 150px;">
                            {% if mov.comentarios %}
                                <span class="text-muted fst-italic text-truncate d-block" title="{{ mov.comentarios }}">{{ mov.comentarios }}</span>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>

                        <td class="text-end amount-cell text-danger">
                            {% if mov.cargo > 0 %}${{ mov.cargo|intcomma }}{% else %}<span class="text-muted">-</span>{% endif %}
                        </td>
                        
                        <td class="text-end amount-cell text-success">
                            {% if mov.abono > 0 %}${{ mov.abono|intcomma }}{% else %}<span class="text-muted">-</span>{% endif %}
                        </td>

                        <td class="text-center">
                            {% if mov.estatus == 'PENDIENTE' %}
                                <span class="status-badge badge-pendiente"><i class="fas fa-clock"></i> Pendiente</span>
                            {% else %}
                                <span class="status-badge badge-terminado"><i class="fas fa-check"></i> Terminado</span>
                            {% endif %}
                        </td>

                        <td class="text-center">
                            {% if mov.auditado %}
                                <i class="fas fa-lock audit-icon locked" title="Auditado"></i>
                            {% else %}
                                <i class="fas fa-lock-open audit-icon unlocked"></i>
                            {% endif %}
                        </td>

                        <td class="text-center pe-3">
                            <div class="action-buttons">
                                {% if mov.auditado %}
                                    <a href="{% url 'detalle_movimiento' mov.id %}" class="btn btn-icon btn-info text-white" title="Visualizar Detalle">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <button class="btn btn-icon btn-light text-muted border" disabled title="Bloqueado por Auditoría">
                                        <i class="fas fa-lock"></i>
                                    </button>
                                {% else %}
                                    <a href="{% url 'editar_movimiento' mov.id %}" class="btn btn-icon btn-outline-primary" title="Editar">
                                        <i class="fas fa-pen"></i>
                                    </a>
                                    
                                    <a href="{% url 'auditar_movimiento' mov.id %}" 
                                       class="btn btn-icon btn-outline-success" 
                                       title="Auditar y Bloquear"
                                       onclick="return confirm('¿Confirmas que este movimiento es correcto? Se bloqueará para futuras ediciones.')">
                                        <i class="fas fa-check-double"></i>
                                    </a>

                                    <a href="{% url 'eliminar_movimiento' mov.id %}" 
                                       class="btn btn-icon btn-outline-danger" 
                                       title="Eliminar Movimiento"
                                       onclick="return confirm(⚠️ ¿Estás seguro de ELIMINAR este movimiento? Esta acción no se puede deshacer.')">
                                        <i class="fas fa-trash"></i>
                                    </a>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="11" class="text-center py-5">
                            <div class="empty-state text-muted">
                                <i class="fas fa-folder-open fa-3x mb-3 opacity-25"></i>
                                <p class="mb-0">No se encontraron movimientos con los filtros seleccionados.</p>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {% if movimientos.has_other_pages %}
        <div class="card-footer bg-white border-top-0 py-3">
            <nav aria-label="Page navigation">
                <ul class="pagination justify-content-center mb-0">
                    
                    {% if movimientos.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ movimientos.previous_page_number }}&q={{ request.GET.q }}&fecha_inicio={{ request.GET.fecha_inicio }}&fecha_fin={{ request.GET.fecha_fin }}&estatus={{ request.GET.estatus }}&auditado={{ request.GET.auditado }}">
                                <i class="fas fa-chevron-left"></i>
                            </a>
                        </li>
                    {% else %}
                        <li class="page-item disabled"><span class="page-link"><i class="fas fa-chevron-left"></i></span></li>
                    {% endif %}

                    {% for i in movimientos.paginator.page_range %}
                        {% if i == movimientos.number %}
                            <li class="page-item active"><span class="page-link">{{ i }}</span></li>
                        {% elif i > movimientos.number|add:'-3' and i < movimientos.number|add:'3' %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ i }}&q={{ request.GET.q }}&fecha_inicio={{ request.GET.fecha_inicio }}&fecha_fin={{ request.GET.fecha_fin }}&estatus={{ request.GET.estatus }}&auditado={{ request.GET.auditado }}">{{ i }}</a>
                            </li>
                        {% endif %}
                    {% endfor %}

                    {% if movimientos.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ movimientos.next_page_number }}&q={{ request.GET.q }}&fecha_inicio={{ request.GET.fecha_inicio }}&fecha_fin={{ request.GET.fecha_fin }}&estatus={{ request.GET.estatus }}&auditado={{ request.GET.auditado }}">
                                <i class="fas fa-chevron-right"></i>
                            </a>
                        </li>
                    {% else %}
                        <li class="page-item disabled"><span class="page-link"><i class="fas fa-chevron-right"></i></span></li>
                    {% endif %}
                </ul>
                <div class="text-center mt-2 text-muted small">
                    Mostrando {{ movimientos.start_index }} - {{ movimientos.end_index }} de {{ movimientos.paginator.count }} registros
                </div>
            </nav>
        </div>
        {% endif %}
        </div>
</div>

<div class="modal fade" id="importarModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title"><i class="fas fa-file-import me-2"></i>Importar Movimientos</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            
            <form method="post" action="{% url 'importar_movimientos' %}" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="alert alert-info d-flex align-items-center mb-3">
                        <i class="fas fa-info-circle fa-2x me-3"></i>
                        <div>
                            <strong>Formato:</strong><br>
                            <code>FECHA | CONCEPTO | CARGO | ABONO</code>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Cuenta de Destino</label>
                        {% if importar_form %}
                            {{ importar_form.cuenta_destino }}
                        {% else %}
                            <select name="cuenta_destino" class="form-select" required>
                                <option value="">-- Selecciona --</option>
                                {% for c in cuentas %} 
                                    <option value="{{ c.id }}">{{ c.nombre }} ({{ c.moneda }})</option>
                                {% endfor %}
                            </select>
                        {% endif %}
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Archivo TXT</label>
                        <input type="file" name="archivo_txt" class="form-control" accept=".txt" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary fw-bold">Importar</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Mueve el modal al final del body para evitar problemas de z-index
        var modalElement = document.getElementById('importarModal');
        if(modalElement) document.body.appendChild(modalElement);
    });
</script>
{% endblock %}