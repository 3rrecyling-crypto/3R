{% extends 'ternium/base.html' %}
{% load humanize %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
<style>
    /* Ajuste para que el Select2 se vea bien en bootstrap */
    .select2-container--bootstrap-5 .select2-selection {
        border-color: #dee2e6;
        padding: 0.375rem 0.75rem;
    }

    /* === SOLUCIÓN DE CAPAS (Z-INDEX) === */
    /* Forzamos que la cortina oscura y el modal estén por encima de la Navbar (que tiene 10000) */
    .modal-backdrop {
        z-index: 10050 !important;
    }
    .modal {
        z-index: 10055 !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4 bg-light bg-opacity-50">
    
    <div class="row g-3 mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm overflow-hidden bg-white">
                <div class="card-body p-4 d-flex flex-column flex-md-row align-items-center justify-content-between gap-3">
                    
                    <div class="d-flex align-items-center">
                        <div class="bg-primary bg-opacity-10 p-3 rounded-circle me-3">
                            <i class="fas fa-file-invoice text-primary fs-2"></i>
                        </div>
                        <div>
                            <h6 class="text-muted text-uppercase small fw-bold mb-1">Viajes Pendientes de Facturar</h6>
                            <h2 class="mb-0 fw-bold text-dark">{{ total_pendientes }}</h2>
                        </div>
                    </div>
                    
                    <div class="d-flex gap-2">
                        <a href="{% url 'dashboard_facturacion' %}?estado=pendiente" class="btn btn-blue text-dark fw-bold shadow-sm px-4">
                            <i class="fas fa-clock me-2"></i>Ver Facturas Timbradas
                        </a>

                        <button onclick="exportarExcel()" class="btn btn-success fw-bold shadow-sm px-4">
                            <i class="fas fa-file-excel me-2"></i>Excel
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow-sm border-0 mb-4">
        <div class="card-header bg-white py-3 border-bottom">
            <h6 class="mb-0 fw-bold text-dark"><i class="fas fa-sliders-h me-2 text-primary"></i>Filtros y Resumen</h6>
        </div>
        <div class="card-body">
            <div class="row g-4">
                
                <div class="col-lg-4 border-end">
                    <label class="small fw-bold text-muted mb-3 d-block">FILTRAR LISTADO</label>
                    <form method="GET" id="filterForm">
                        <div class="row g-3">
                            <div class="col-12">
                                <label class="form-label small text-muted">Cliente</label>
                                <select name="q_cliente" class="form-select select2-cliente">
                                    <option value="">Todos los Clientes</option>
                                    {% for c in clientes_combo %}
                                        <option value="{{ c.nombre }}" {% if filtro_cliente == c.nombre %}selected{% endif %}>
                                            {{ c.nombre }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div class="col-6">
                                <label class="form-label small text-muted">Desde</label>
                                <input type="date" name="fecha_inicio" class="form-control" value="{{ filtro_inicio|default:'' }}">
                            </div>
                            <div class="col-6">
                                <label class="form-label small text-muted">Hasta</label>
                                <input type="date" name="fecha_fin" class="form-control" value="{{ filtro_fin|default:'' }}">
                            </div>
                            
                            <div class="col-12">
                                <button type="submit" class="btn btn-primary w-100 fw-bold mb-2">
                                    <i class="fas fa-search me-1"></i> Aplicar Filtros
                                </button>
                                
                                <a href="{% url 'remisiones_por_facturar' %}" class="btn btn-outline-secondary w-100 btn-sm">
                                    <i class="fas fa-eraser me-1"></i> Limpiar Filtros
                                </a>
                            </div>
                        </div>
                    </form>
                </div>

                <div class="col-lg-8">
                    <label class="small fw-bold text-muted mb-3 d-block">RESUMEN DE VIAJES (Excluyendo Patios)</label>
                    <div class="d-flex flex-wrap gap-2">
                        {% for c in resumen_clientes %}
                        <div class="bg-light border rounded p-2 d-flex align-items-center" style="min-width: 180px;">
                            <div class="avatar-sm bg-white rounded p-1 me-2 text-center fw-bold text-primary shadow-sm border" style="width: 40px; height: 40px; line-height: 30px; font-size: 1.2rem;">
                                {{ c.cliente__nombre|slice:":1" }}
                            </div>
                            <div>
                                <span class="d-block fw-bold text-dark small text-truncate" style="max-width: 130px;" title="{{ c.cliente__nombre }}">
                                    {{ c.cliente__nombre }}
                                </span>
                                <span class="d-block text-muted" style="font-size: 0.75rem;">
                                    <strong>{{ c.conteo }}</strong> viajes
                                </span>
                            </div>
                        </div>
                        {% empty %}
                        <div class="alert alert-light w-100 text-center text-muted border-dashed">
                            No hay viajes pendientes con los filtros actuales.
                        </div>
                        {% endfor %}
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div class="card shadow border-0">
        <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
            <h5 class="mb-0 fw-bold text-dark">Listado Detallado</h5>
            
            <button type="submit" form="formPrefactura" class="btn btn-success fw-bold shadow-sm disabled" id="btnFacturar">
                <i class="fas fa-check-circle me-2"></i>Prefacturar (<span id="countSelected">0</span>)
            </button>
        </div>

        <div class="card-body p-0">
            <form action="{% url 'prefacturar_remisiones' %}" method="POST" id="formPrefactura">
                {% csrf_token %}
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0 table-striped">
                        <thead class="bg-light text-secondary small text-uppercase">
                            <tr>
                                <th class="text-center" width="5%"><input type="checkbox" class="form-check-input" id="selectAll" style="cursor: pointer;"></th>
                                <th class="py-3">Folio</th>
                                <th class="py-3">Fecha</th>
                                <th class="py-3">Cliente</th>
                                <th class="py-3">Ruta (Origen -> Destino)</th>
                                <th class="py-3">Material</th>
                                <th class="py-3 text-end">Peso Neto</th>
                                <th class="py-3 text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for r in remisiones %}
                            <tr>
                                <td class="text-center">
                                    <input type="checkbox" name="remisiones_ids" value="{{ r.id }}" class="form-check-input remision-check" style="cursor: pointer; transform: scale(1.3);">
                                </td>
                                
                                <td class="fw-bold">
                                    <a href="{% url 'remision_lista' %}?q_remision={{ r.remision }}" 
                                       target="_blank" 
                                       class="text-decoration-none text-primary"
                                       title="Buscar {{ r.remision }} en lista general">
                                        {{ r.remision }} <i class="fas fa-external-link-alt text-muted ms-1" style="font-size: 0.7rem;"></i>
                                    </a>
                                </td>
                                
                                <td>{{ r.fecha|date:"d/m/Y" }}</td>
                                
                                <td class="fw-bold">{{ r.cliente.nombre }}</td>
                                
                                <td>
                                    <div class="small">
                                        <span class="text-muted">De:</span> {{ r.origen.nombre }} <br>
                                        <span class="text-primary">A:</span> <strong>{{ r.destino.nombre }}</strong>
                                    </div>
                                </td>
                                
                                <td class="text-secondary fw-bold">
                                    {{ r.detalles.first.material.nombre|default:"-- S/Material --" }}
                                </td>
                                
                                <td class="text-end fw-bold text-dark">{{ r.total_peso_dlv|floatformat:2 }} kg</td>
                                
                                <td class="text-center">
                                    <button type="button" class="btn btn-sm btn-outline-info rounded-pill px-3 fw-bold" 
                                            onclick="abrirModalDetalle('{% url 'detalle_remision' r.id %}', '{{ r.remision }}')">
                                        <i class="fas fa-eye me-1"></i> Ver
                                    </button>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="8" class="text-center py-5 text-muted">
                                    <i class="fas fa-folder-open fa-3x mb-3 opacity-25"></i>
                                    <p>No se encontraron remisiones pendientes.</p>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                {% if remisiones.paginator.num_pages > 1 %}
                <div class="card-footer bg-white py-3 border-top">
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="text-muted small">
                            Mostrando {{ remisiones.start_index }} a {{ remisiones.end_index }} de {{ total_pendientes }} registros
                        </span>

                        <nav aria-label="Paginación">
                            <ul class="pagination pagination-sm mb-0">
                                {% if remisiones.has_previous %}
                                    <li class="page-item">
                                        <a class="page-link" href="?page=1{% if filtro_cliente %}&q_cliente={{ filtro_cliente }}{% endif %}{% if filtro_inicio %}&fecha_inicio={{ filtro_inicio }}{% endif %}{% if filtro_fin %}&fecha_fin={{ filtro_fin }}{% endif %}">
                                            <i class="fas fa-angle-double-left"></i>
                                        </a>
                                    </li>
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ remisiones.previous_page_number }}{% if filtro_cliente %}&q_cliente={{ filtro_cliente }}{% endif %}{% if filtro_inicio %}&fecha_inicio={{ filtro_inicio }}{% endif %}{% if filtro_fin %}&fecha_fin={{ filtro_fin }}{% endif %}">
                                            Anterior
                                        </a>
                                    </li>
                                {% endif %}

                                <li class="page-item active"><span class="page-link">{{ remisiones.number }}</span></li>

                                {% if remisiones.has_next %}
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ remisiones.next_page_number }}{% if filtro_cliente %}&q_cliente={{ filtro_cliente }}{% endif %}{% if filtro_inicio %}&fecha_inicio={{ filtro_inicio }}{% endif %}{% if filtro_fin %}&fecha_fin={{ filtro_fin }}{% endif %}">
                                            Siguiente
                                        </a>
                                    </li>
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ remisiones.paginator.num_pages }}{% if filtro_cliente %}&q_cliente={{ filtro_cliente }}{% endif %}{% if filtro_inicio %}&fecha_inicio={{ filtro_inicio }}{% endif %}{% if filtro_fin %}&fecha_fin={{ filtro_fin }}{% endif %}">
                                            <i class="fas fa-angle-double-right"></i>
                                        </a>
                                    </li>
                                {% endif %}
                            </ul>
                        </nav>
                    </div>
                </div>
                {% endif %}
                </form>
        </div>
    </div>
</div>

<div class="modal fade" id="modalDetalleRemision" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content border-0 shadow-lg" style="height: 85vh;">
            <div class="modal-header bg-primary text-white py-2">
                <h5 class="modal-title fw-bold fs-6">
                    <i class="fas fa-truck-loading me-2"></i>Remisión: <span id="modalTitleFolio"></span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            
            <div class="modal-body bg-light position-relative p-0" id="modalBodyContent">
                <div id="modalSpinner" class="position-absolute top-50 start-50 translate-middle text-center" style="display: none; z-index: 10;">
                    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
                    <p class="mt-2 text-muted fw-bold">Cargando información...</p>
                </div>
                <div id="ajaxContent" class="h-100 w-100" style="overflow-y: auto; padding: 15px;"></div>
            </div>
            
            <div class="modal-footer bg-light py-2">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        
        // 1. INICIALIZAR SELECT2 (ComboBox Buscador)
        $('.select2-cliente').select2({
            theme: 'bootstrap-5',
            placeholder: "Seleccione un Cliente...",
            allowClear: true,
            width: '100%'
        });

        // 2. LÓGICA DE CHECKBOXES (Activar botón Prefacturar)
        const selectAll = document.getElementById('selectAll');
        const checks = document.querySelectorAll('.remision-check');
        const btnFacturar = document.getElementById('btnFacturar');
        const countSpan = document.getElementById('countSelected');

        function updateState() {
            const count = document.querySelectorAll('.remision-check:checked').length;
            countSpan.textContent = count;
            if (count > 0) btnFacturar.classList.remove('disabled');
            else btnFacturar.classList.add('disabled');
        }

        if(selectAll) {
            selectAll.addEventListener('change', function() {
                checks.forEach(c => c.checked = this.checked);
                updateState();
            });
        }
        checks.forEach(c => c.addEventListener('change', updateState));
    });

    // 3. EXPORTAR EXCEL
    function exportarExcel() {
        const params = new URLSearchParams(new FormData(document.getElementById('filterForm')));
        params.append('exportar', 'excel');
        window.location.href = "?" + params.toString();
    }

    // 4. ABRIR MODAL (AJAX / Fetch)
    function abrirModalDetalle(url, folio) {
        document.getElementById('modalTitleFolio').textContent = folio;
        
        const spinner = document.getElementById('modalSpinner');
        const contentDiv = document.getElementById('ajaxContent');
        const modalEl = document.getElementById('modalDetalleRemision');
        
        // === FIX IMPORTANTE: Mover modal al body para evitar conflictos de Z-Index ===
        document.body.appendChild(modalEl);
        // =========================================================================
        
        // Limpiar
        contentDiv.innerHTML = '';
        spinner.style.display = 'block';

        const modal = new bootstrap.Modal(modalEl);
        modal.show();

        fetch(url)
            .then(response => {
                if (!response.ok) throw new Error('Error al cargar');
                return response.text();
            })
            .then(html => {
                spinner.style.display = 'none';
                contentDiv.innerHTML = html;
                
                // Ocultar barras de navegación dentro del modal para limpieza visual
                const elementosOcultar = contentDiv.querySelectorAll('nav, .navbar, header, footer, .sidebar');
                elementosOcultar.forEach(el => el.style.display = 'none');
                
                const mainContainer = contentDiv.querySelector('.container, .container-fluid');
                if(mainContainer) {
                    mainContainer.classList.remove('py-4', 'mt-4'); 
                    mainContainer.style.paddingTop = '0';
                }
            })
            .catch(error => {
                spinner.style.display = 'none';
                contentDiv.innerHTML = '<div class="alert alert-danger m-4">No se pudo cargar el detalle.</div>';
            });
    }
</script>
{% endblock %}
{% endblock %}