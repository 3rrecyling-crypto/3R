{% extends 'ternium/base.html' %}
{% load humanize %}

{% block title %}Registrar Cuenta por Pagar{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
<style>
    .select2-container--bootstrap-5 .select2-selection { border-color: #dee2e6; }
    .bg-cxp-header { background: linear-gradient(135deg, #2c3e50 0%, #4ca1af 100%); color: white; }
    .card-cxp { border-top: 4px solid #2c3e50; }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="fw-bold text-dark mb-0">
                        <i class="fas fa-file-invoice-dollar text-secondary me-2"></i>Nueva Cuenta por Pagar
                    </h2>
                    <p class="text-muted mb-0">Registra las facturas recibidas de tus proveedores</p>
                </div>
                <a href="{% url 'dashboard_facturacion' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Volver al Dashboard
                </a>
            </div>
        </div>
    </div>

    <form method="POST" enctype="multipart/form-data" id="formCXP">
        {% csrf_token %}
        
        <div class="row g-4">
            <div class="col-lg-8">
                <div class="card shadow-sm border-0 card-cxp mb-4">
                    <div class="card-header bg-white py-3">
                        <h6 class="mb-0 fw-bold text-dark"><i class="fas fa-building me-2"></i>Datos del Proveedor</h6>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-12">
                                <label class="form-label fw-bold">Proveedor (Emisor)</label>
                                <select name="proveedor" class="form-select select2" required>
                                    <option value="">Buscar proveedor por razón social o RFC...</option>
                                    {% for prov in proveedores %}
                                        <option value="{{ prov.id }}">{{ prov.razon_social }} - {{ prov.rfc }}</option>
                                    {% endfor %}
                                </select>
                                <div class="form-text"><a href="#" class="text-decoration-none"><i class="fas fa-plus me-1"></i>Registrar nuevo proveedor</a></div>
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Folio de Factura (Interno)</label>
                                <input type="text" name="folio" class="form-control" placeholder="Ej. A-5043" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Folio Fiscal (UUID)</label>
                                <input type="text" name="uuid" class="form-control" placeholder="32 dígitos hexadecimales">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card shadow-sm border-0 card-cxp">
                    <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                        <h6 class="mb-0 fw-bold text-dark"><i class="fas fa-list me-2"></i>Desglose de la Cuenta</h6>
                    </div>
                    <div class="card-body p-0">
                        <table class="table table-striped mb-0" id="tablaConceptos">
                            <thead class="bg-light text-secondary small text-uppercase">
                                <tr>
                                    <th class="ps-4" style="width: 50%;">Descripción / Concepto</th>
                                    <th style="width: 20%;">Categoría</th>
                                    <th class="pe-4 text-end" style="width: 30%;">Importe</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="ps-4">
                                        <input type="text" name="descripcion[]" class="form-control form-control-sm" placeholder="Ej. Compra de material..." required>
                                    </td>
                                    <td>
                                        <select name="categoria[]" class="form-select form-select-sm">
                                            <option value="gastos_generales">Gastos Generales</option>
                                            <option value="mantenimiento">Mantenimiento</option>
                                            <option value="combustible">Combustible</option>
                                            <option value="nomina">Nómina</option>
                                        </select>
                                    </td>
                                    <td class="pe-4">
                                        <div class="input-group input-group-sm">
                                            <span class="input-group-text">$</span>
                                            <input type="number" name="importe[]" class="form-control text-end importe-row" step="0.01" onchange="calcularTotales()" required>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        <div class="p-3 bg-light border-top text-center">
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="agregarFila()">
                                <i class="fas fa-plus me-1"></i>Agregar Concepto
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card shadow-sm border-0 mb-4">
                    <div class="card-header bg-white py-3">
                        <h6 class="mb-0 fw-bold text-dark"><i class="fas fa-calendar-alt me-2"></i>Fechas y Condiciones</h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label small text-muted text-uppercase fw-bold">Fecha de Emisión</label>
                            <input type="date" name="fecha_emision" class="form-control" value="{% now 'Y-m-d' %}">
                        </div>
                        <div class="mb-3">
                            <label class="form-label small text-muted text-uppercase fw-bold">Fecha de Vencimiento (Pago)</label>
                            <input type="date" name="fecha_vencimiento" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label class="form-label small text-muted text-uppercase fw-bold">Método de Pago</label>
                            <select name="metodo_pago" class="form-select">
                                <option value="PUE">PUE - Pago en una sola exhibición</option>
                                <option value="PPD">PPD - Pago en parcialidades o diferido</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="card shadow-sm border-0 mb-4 bg-white">
                    <div class="card-body">
                        <h6 class="fw-bold text-muted text-uppercase small mb-3">Resumen de Importes</h6>
                        
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-muted">Subtotal:</span>
                            <span class="fw-bold" id="lblSubtotal">$0.00</span>
                        </div>
                        
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-muted">IVA (16%):</span>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="checkIva" checked onchange="calcularTotales()">
                            </div>
                            <span class="fw-bold text-danger" id="lblIva">$0.00</span>
                        </div>

                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <span class="text-muted">Retenciones:</span>
                            <div class="input-group input-group-sm" style="width: 100px;">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control text-end" id="inputRetencion" value="0" step="0.01" onchange="calcularTotales()">
                            </div>
                        </div>

                        <hr>
                        
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="h5 fw-bold text-dark mb-0">Total a Pagar:</span>
                            <span class="h4 fw-bold text-primary mb-0" id="lblTotal">$0.00</span>
                        </div>
                        
                        <input type="hidden" name="subtotal" id="hiddenSubtotal">
                        <input type="hidden" name="total" id="hiddenTotal">
                    </div>
                </div>

                <div class="card shadow-sm border-0 mb-4">
                    <div class="card-header bg-white py-3">
                        <h6 class="mb-0 fw-bold text-dark"><i class="fas fa-paperclip me-2"></i>Adjuntos</h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label small">Factura (PDF)</label>
                            <input type="file" name="archivo_pdf" class="form-control form-control-sm" accept="application/pdf">
                        </div>
                        <div class="mb-3">
                            <label class="form-label small">Factura (XML)</label>
                            <input type="file" name="archivo_xml" class="form-control form-control-sm" accept=".xml">
                        </div>
                    </div>
                </div>

                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-dark btn-lg fw-bold">
                        <i class="fas fa-save me-2"></i>Registrar CXP
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
    $(document).ready(function() {
        $('.select2').select2({
            theme: 'bootstrap-5',
            width: '100%'
        });
    });

    function agregarFila() {
        const row = `
            <tr>
                <td class="ps-4">
                    <input type="text" name="descripcion[]" class="form-control form-control-sm" required>
                </td>
                <td>
                    <select name="categoria[]" class="form-select form-select-sm">
                        <option value="gastos_generales">Gastos Generales</option>
                        <option value="mantenimiento">Mantenimiento</option>
                        <option value="combustible">Combustible</option>
                        <option value="nomina">Nómina</option>
                    </select>
                </td>
                <td class="pe-4">
                    <div class="input-group input-group-sm">
                        <span class="input-group-text">$</span>
                        <input type="number" name="importe[]" class="form-control text-end importe-row" step="0.01" onchange="calcularTotales()" required>
                    </div>
                    <button type="button" class="btn btn-link text-danger btn-sm float-end p-0 mt-1" onclick="$(this).closest('tr').remove(); calcularTotales();">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;
        $('#tablaConceptos tbody').append(row);
    }

    function calcularTotales() {
        let subtotal = 0;
        
        $('.importe-row').each(function() {
            let val = parseFloat($(this).val()) || 0;
            subtotal += val;
        });

        let iva = 0;
        if ($('#checkIva').is(':checked')) {
            iva = subtotal * 0.16;
        }

        let retencion = parseFloat($('#inputRetencion').val()) || 0;
        let total = subtotal + iva - retencion;

        // Actualizar vista
        $('#lblSubtotal').text('$' + subtotal.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}));
        $('#lblIva').text('$' + iva.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}));
        $('#lblTotal').text('$' + total.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}));

        // Actualizar inputs ocultos
        $('#hiddenSubtotal').val(subtotal.toFixed(2));
        $('#hiddenTotal').val(total.toFixed(2));
    }
</script>
{% endblock %}