{% extends 'ternium/base.html' %}
{% load static %}

{% block title %}Nueva Factura Libre{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="card shadow">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h3 class="mb-0">Nueva Factura</h3>
            <a href="{% url 'dashboard_facturacion' %}" class="btn btn-light btn-sm">Volver</a>
        </div>
        
        <div class="card-body">
            <form method="post" id="facturaForm">
                {% csrf_token %}

                <div class="row g-3 mb-4">
                    <div class="col-md-12">
                        <label class="form-label fw-bold">Cliente / Receptor</label>
                        {{ form.receptor }}
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Uso CFDI</label>
                        {{ form.uso_cfdi }}
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Método de Pago</label>
                        {{ form.metodo_pago }}
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Forma de Pago</label>
                        {{ form.forma_pago }}
                    </div>

                    <div class="col-md-3">
                        <label class="form-label">Moneda</label>
                        {{ form.moneda }}
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Tipo de Cambio</label>
                        {{ form.tipo_cambio }}
                    </div>
                    
                    <div class="col-md-6 d-flex align-items-end">
                        <div class="form-check mb-2">
                            {{ form.aplicar_retencion }}
                            <label class="form-check-label">
                                {{ form.aplicar_retencion.label }}
                            </label>
                        </div>
                    </div>
                </div>

                <hr>

                <h5 class="text-primary mb-3">Conceptos</h5>

                <div class="table-responsive">
                    <table class="table table-bordered align-middle" id="tablaConceptos">
                        <thead class="table-light text-center">
                            <tr>
                                <th width="10%">Cantidad</th>
                                <th width="12%">Unidad (SAT)</th>
                                <th width="12%">Clave (SAT)</th>
                                <th width="35%">Descripción</th>
                                <th width="15%">Precio</th>
                                <th width="15%">Importe</th>
                                <th width="1%"></th>
                            </tr>
                        </thead>
                        <tbody id="bodyConceptos">
                            <tr>
                                <td>
                                    <input type="number" step="0.01" name="cantidad[]" class="form-control text-center cantidad" required placeholder="0" oninput="calcularFila(this)">
                                </td>
                                <td>
                                    <input type="text" name="unidad[]" class="form-control text-center" placeholder="Ej: H87" required>
                                </td>
                                <td>
                                    <input type="text" name="clave_sat[]" class="form-control text-center" placeholder="Ej: 84111506" required>
                                </td>
                                <td>
                                    <input type="text" name="descripcion[]" class="form-control" required placeholder="Descripción del servicio o producto">
                                </td>
                                <td>
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        <input type="number" step="0.01" name="valor_unitario[]" class="form-control text-end precio" required placeholder="0.00" oninput="calcularFila(this)">
                                    </div>
                                </td>
                                <td>
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        <input type="number" step="0.01" class="form-control text-end importe" readonly tabindex="-1" value="0.00">
                                    </div>
                                </td>
                                <td class="text-center">
                                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="eliminarFila(this)">X</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <button type="button" class="btn btn-secondary btn-sm mb-4" onclick="agregarFila()">
                    + Agregar Fila
                </button>

                <div class="row justify-content-end">
                    <div class="col-md-4">
                        <table class="table table-sm table-borderless">
                            <tr>
                                <td class="text-end fw-bold">Subtotal:</td>
                                <td class="text-end"><span id="granSubtotal">$0.00</span></td>
                            </tr>
                            <tr>
                                <td class="text-end fw-bold">IVA (16%):</td>
                                <td class="text-end"><span id="granIva">$0.00</span></td>
                            </tr>
                            <tr id="filaRetencion" style="display:none;">
                                <td class="text-end fw-bold text-danger">Retención (6%):</td>
                                <td class="text-end text-danger"><span id="granRet">$0.00</span></td>
                            </tr>
                            <tr class="border-top">
                                <td class="text-end fw-bold h5">Total:</td>
                                <td class="text-end h5"><span id="granTotal">$0.00</span></td>
                            </tr>
                        </table>
                    </div>
                </div>

                <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                    <button type="submit" class="btn btn-success btn-lg px-5">Generar Factura</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // Inicialización
    document.addEventListener('DOMContentLoaded', function() {
        const checkRet = document.getElementById('{{ form.aplicar_retencion.id_for_label }}');
        if(checkRet){
            checkRet.addEventListener('change', calcularTotalesGenerales);
        }
    });

    // Calcula importe de una fila (Cantidad * Precio)
    function calcularFila(elemento) {
        let fila = elemento.closest('tr');
        let cantidad = parseFloat(fila.querySelector('.cantidad').value) || 0;
        let precio = parseFloat(fila.querySelector('.precio').value) || 0;
        
        let importe = cantidad * precio;
        fila.querySelector('.importe').value = importe.toFixed(2);
        
        calcularTotalesGenerales();
    }

    // Suma totales y calcula impuestos
    function calcularTotalesGenerales() {
        let subtotal = 0;
        document.querySelectorAll('.importe').forEach(input => {
            subtotal += parseFloat(input.value) || 0;
        });

        const checkRet = document.getElementById('{{ form.aplicar_retencion.id_for_label }}');
        const aplicaRetencion = checkRet ? checkRet.checked : false;

        let iva = subtotal * 0.16;
        let retencion = aplicaRetencion ? (subtotal * 0.06) : 0;
        let total = subtotal + iva - retencion;

        document.getElementById('granSubtotal').innerText = '$' + subtotal.toFixed(2);
        document.getElementById('granIva').innerText = '$' + iva.toFixed(2);
        
        const filaRet = document.getElementById('filaRetencion');
        if (aplicaRetencion) {
            filaRet.style.display = 'table-row';
            document.getElementById('granRet').innerText = '-$' + retencion.toFixed(2);
        } else {
            filaRet.style.display = 'none';
        }

        document.getElementById('granTotal').innerText = '$' + total.toFixed(2);
    }

    // Agregar nueva fila limpia
    function agregarFila() {
        let tbody = document.getElementById('bodyConceptos');
        let primeraFila = tbody.querySelector('tr'); 
        let nuevaFila = primeraFila.cloneNode(true);
        
        nuevaFila.querySelectorAll('input').forEach(input => {
            input.value = ''; // Limpiar valores
            if(input.classList.contains('importe')) input.value = '0.00';
        });

        tbody.appendChild(nuevaFila);
    }

    // Eliminar fila
    function eliminarFila(boton) {
        let filas = document.querySelectorAll('#bodyConceptos tr');
        if (filas.length > 1) {
            boton.closest('tr').remove();
            calcularTotalesGenerales();
        } else {
            alert("Debe haber al menos un concepto.");
        }
    }
</script>
{% endblock %}